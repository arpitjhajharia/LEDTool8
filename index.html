<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admire Signage - LED Quoting Tool v8</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }

            #root {
                margin: 0;
                padding: 0;
            }

            .dark {
                color: black !important;
                background: white !important;
            }

            .modal-content {
                box-shadow: none !important;
                border: none !important;
            }
        }

        .print-only {
            display: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Calculator: (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></IconBase>,
            Settings: (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>,
            Printer: (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></IconBase>,
            Plus: (props) => <IconBase {...props}><path d="M5 12h14" /><path d="M12 5v14" /></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></IconBase>,
            Monitor: (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></IconBase>,
            Box: (props) => <IconBase {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" x2="12" y1="22.08" y2="12" /></IconBase>,
            Wrench: (props) => <IconBase {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></IconBase>,
            Percent: (props) => <IconBase {...props}><line x1="19" x2="5" y1="5" y2="19" /><circle cx="6.5" cy="6.5" r="2.5" /><circle cx="17.5" cy="17.5" r="2.5" /></IconBase>,
            Edit: (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></IconBase>,
            Sun: (props) => <IconBase {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></IconBase>,
            Moon: (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></IconBase>,
            Copy: (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><polyline points="10 9 9 9 8 9" /></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></IconBase>
        };

        const { Calculator, Settings, Printer, Plus, Trash2, Monitor, DollarSign, Box, Wrench, Percent, Edit, Sun, Moon, X, Eye, Copy, RefreshCw, Save, FileText, Download } = Icons;

        // --- Firebase Config Logic ---
        const externalConfig = {
              apiKey: "AIzaSyAvueWxge1MyGoj9JRPFP5cGF8EVb240XE",
  authDomain: "led-single.firebaseapp.com",
  projectId: "led-single",
  storageBucket: "led-single.firebasestorage.app",
  messagingSenderId: "820851571866",
  appId: "1:820851571866:web:516f653701a684d78e7323",
  measurementId: "G-9LDX0M4YH8"
        };

        let firebaseConfig;
        let appId = 'admire-signage-external';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : appId;
        } else {
            firebaseConfig = externalConfig;
        }

        let app, auth, db, isConfigured = true;

        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("REPLACE_WITH")) {
            isConfigured = false;
        } else {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                isConfigured = false;
            }
        }

        // --- Utils ---
        const formatCurrency = (amount, currency = 'INR', compact = false) => {
            return new Intl.NumberFormat(currency === 'INR' ? 'en-IN' : 'en-US', {
                style: 'currency',
                currency: currency,
                maximumFractionDigits: 0,
                notation: compact ? "compact" : "standard"
            }).format(amount);
        };

        const generateId = () => Math.random().toString(36).substr(2, 9).toUpperCase();

        // --- Components ---

        // 1. Inventory Manager
        const InventoryManager = ({ user, transactions = [] }) => {
            const [items, setItems] = React.useState([]);
            const [editingId, setEditingId] = React.useState(null);
            const [newItem, setNewItem] = React.useState({ 
                type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                brightness: '', refreshRate: '', 
                ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
            });
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory')
                    .onSnapshot(snap => {
                        const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setItems(data);
                        setLoading(false);
                    }, err => console.error(err));
                return () => unsub();
            }, [user]);

            const handleSaveItem = async () => {
                if (newItem.type === 'module') {
                    if (!newItem.pitch || !newItem.brand || !newItem.model || !newItem.price || !newItem.width || !newItem.height || !newItem.weight || !newItem.avgPower || !newItem.maxPower || !newItem.brightness || !newItem.refreshRate || !newItem.contrast || !newItem.viewAngleH || !newItem.viewAngleV || !newItem.ipFront || !newItem.ipBack) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'cabinet') {
                    if (!newItem.material || !newItem.model || !newItem.price || !newItem.vendor || !newItem.width || !newItem.height) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'card' || newItem.type === 'processor') {
                     if (!newItem.brand || !newItem.model || !newItem.price || !newItem.vendor) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'psu') {
                     if (!newItem.brand || !newItem.model || !newItem.price || !newItem.vendor || !newItem.amps) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (!newItem.brand || !newItem.model) {
                    return alert("Brand and Model are required");
                }
                
                try {
                    const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory');
                    
                    const itemData = {
                        ...newItem,
                        width: Number(newItem.width),
                        height: Number(newItem.height),
                        price: Number(newItem.price),
                        carriage: Number(newItem.carriage || 0),
                        pitch: Number(newItem.pitch),
                        currency: newItem.currency || 'INR', 
                        indoor: newItem.indoor === 'true' || newItem.indoor === true,
                        material: newItem.material || '',
                        weight: newItem.weight ? Number(newItem.weight) : 0,
                        avgPower: newItem.avgPower ? Number(newItem.avgPower) : 0,
                        maxPower: newItem.maxPower ? Number(newItem.maxPower) : 0,
                        brightness: newItem.brightness ? parseInt(newItem.brightness) : 0,
                        refreshRate: newItem.refreshRate ? parseInt(newItem.refreshRate) : 0,
                        viewAngleH: newItem.viewAngleH ? parseInt(newItem.viewAngleH) : 0,
                        viewAngleV: newItem.viewAngleV ? parseInt(newItem.viewAngleV) : 0,
                        ipFront: newItem.ipFront ? parseInt(newItem.ipFront) : 0,
                        ipBack: newItem.ipBack ? parseInt(newItem.ipBack) : 0,
                        ports: newItem.ports ? parseInt(newItem.ports) : 0,
                        amps: newItem.amps ? Number(newItem.amps) : 0,
                        updatedAt: new Date()
                    };

                    if (editingId) {
                        await collectionRef.doc(editingId).update(itemData);
                        setEditingId(null);
                    } else {
                        await collectionRef.add({ ...itemData, createdAt: new Date() });
                    }
                    setNewItem({ 
                        type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                        width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                        brightness: '', refreshRate: '', 
                        ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                        contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
                    });
                } catch (e) { console.error(e); }
            };

            const handleEdit = (item) => {
                setNewItem({ ...item, vendor: item.vendor || '', currency: item.currency || 'INR', carriage: item.carriage || 0 });
                setEditingId(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

                const handleCancelEdit = () => {
                setEditingId(null);
                setNewItem({ 
                    type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                    width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                    brightness: '', refreshRate: '', 
                    ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                    contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
                });
            };

            const handleDelete = async (id) => {
                if (confirm("Delete this item?")) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory').doc(id).delete();
                }
            };

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <Box className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Components Management
                        </h2>
                    </div>

                    {/* Add/Edit Item Form */}
                    <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 rounded-lg transition-colors ${editingId ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700' : 'bg-slate-50 dark:bg-slate-700/50'}`}>
                        <div className="col-span-2 md:col-span-4 flex justify-between items-center mb-2">
                            <h3 className="text-sm font-bold uppercase text-slate-500 dark:text-slate-400">{editingId ? 'Editing Item' : 'Add New Item'}</h3>
                            {editingId && <button onClick={handleCancelEdit} className="text-xs text-slate-500 dark:text-slate-400 hover:underline">Cancel Edit</button>}
                        </div>

                        {/* 1. Type */}
                        <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.type} onChange={e => setNewItem({...newItem, type: e.target.value})}>
                            <option value="module">Module</option>
                            <option value="cabinet">Cabinet</option>
                            <option value="ready">Ready Unit</option>
                            <option value="card">Receiving Card</option>
                            <option value="psu">SMPS</option>
                            <option value="processor">Processor</option>
                        </select>

                        {/* 2. Module Specific Inputs */}
                        {newItem.type === 'module' && (
                            <>
                                 <input placeholder="Pitch*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white border-teal-500 ring-1 ring-teal-500" value={newItem.pitch} onChange={e => setNewItem({...newItem, pitch: e.target.value})} />
                                 <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white border-teal-500 ring-1 ring-teal-500" value={newItem.indoor} onChange={e => setNewItem({...newItem, indoor: e.target.value})}>
                                    <option value="true">Indoor</option>
                                    <option value="false">Outdoor</option>
                                 </select>
                            </>
                        )}

                        <input placeholder={(newItem.type === 'module' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Brand*" : "Brand"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.brand} onChange={e => setNewItem({...newItem, brand: e.target.value})} />
                        <input placeholder={(newItem.type === 'module' || newItem.type === 'cabinet' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Model/SKU*" : "Model"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.model} onChange={e => setNewItem({...newItem, model: e.target.value})} />
                        
                        {/* Price & Carriage Inputs */}
                        <div className="flex gap-2 items-center col-span-2 md:col-span-1">
                             <div className="flex-1 min-w-[100px]" title="Base Price">
                                 <input placeholder="Base Rate*" type="number" className="p-2 w-full border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.price} onChange={e => setNewItem({...newItem, price: e.target.value})} />
                                 <div className="text-[9px] text-slate-400 mt-0.5 ml-1">BASE RATE*</div>
                             </div>
                             <span className="text-slate-400 font-bold mb-3">+</span>
                             <div className="flex-1 min-w-[80px]" title="Carriage Inwards">
                                 <input placeholder="Carriage" type="number" className="p-2 w-full border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.carriage} onChange={e => setNewItem({...newItem, carriage: e.target.value})} />
                                 <div className="text-[9px] text-slate-400 mt-0.5 ml-1">CARRIAGE</div>
                             </div>
                             <div className="flex-none mb-3">
                                 <select className="p-2 border rounded bg-slate-100 dark:bg-slate-600 dark:border-slate-600 dark:text-white" value={newItem.currency} onChange={e => setNewItem({...newItem, currency: e.target.value})}>
                                    <option value="INR">INR</option>
                                    <option value="USD">USD</option>
                                </select>
                             </div>
                        </div>

                        <input placeholder={(newItem.type === 'cabinet' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Vendor*" : "Vendor"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.vendor} onChange={e => setNewItem({...newItem, vendor: e.target.value})} />
                        
                        {(newItem.type === 'card' || newItem.type === 'processor') && (
                             <input placeholder="Ports (Optional)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ports} onChange={e => setNewItem({...newItem, ports: e.target.value})} />
                        )}

                        {newItem.type === 'psu' && (
                             <input placeholder="Capacity (Amps)*" type="number" step="0.1" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.amps} onChange={e => setNewItem({...newItem, amps: e.target.value})} />
                        )}

                        {newItem.type === 'module' && (
                            <>
                                <input placeholder="LED Type" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ledType} onChange={e => setNewItem({...newItem, ledType: e.target.value})} />
                                <input placeholder="Lamp Make" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.lampMake} onChange={e => setNewItem({...newItem, lampMake: e.target.value})} />
                                <input placeholder="Width (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                                <input placeholder="Weight/sqm (kg)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} />
                                <input placeholder="Avg Power/sqm (W)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.avgPower} onChange={e => setNewItem({...newItem, avgPower: e.target.value})} />
                                <input placeholder="Max Power/sqm (W)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.maxPower} onChange={e => setNewItem({...newItem, maxPower: e.target.value})} />
                                <input placeholder="Brightness (nits)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.brightness} onChange={e => setNewItem({...newItem, brightness: e.target.value})} />
                                <input placeholder="Refresh Rate*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.refreshRate} onChange={e => setNewItem({...newItem, refreshRate: e.target.value})} />
                                <input placeholder="Contrast* (e.g. 5000:1)" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.contrast} onChange={e => setNewItem({...newItem, contrast: e.target.value})} />
                                <input placeholder="Viewing Angle (H)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.viewAngleH} onChange={e => setNewItem({...newItem, viewAngleH: e.target.value})} />
                                <input placeholder="Viewing Angle (V)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.viewAngleV} onChange={e => setNewItem({...newItem, viewAngleV: e.target.value})} />
                                <input placeholder="IP Protection (Front)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ipFront} onChange={e => setNewItem({...newItem, ipFront: e.target.value})} />
                                <input placeholder="IP Protection (Back)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ipBack} onChange={e => setNewItem({...newItem, ipBack: e.target.value})} />
                            </>
                        )}

                        {newItem.type === 'cabinet' && (
                            <>
                                <input placeholder="Material*" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.material} onChange={e => setNewItem({...newItem, material: e.target.value})} />
                                <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.indoor} onChange={e => setNewItem({...newItem, indoor: e.target.value})}>
                                    <option value="true">Indoor</option>
                                    <option value="false">Outdoor</option>
                                </select>
                                <input placeholder="Width (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                                <input placeholder="Weight (kg)" type="number" step="1" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} />
                            </>
                        )}

                        {newItem.type === 'ready' && (
                            <>
                                <input placeholder="Width (mm)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                            </>
                        )}
                        <button
                            onClick={handleSaveItem}
                            className={`px-4 py-2 rounded text-white flex items-center justify-center gap-2 hover:opacity-90 transition ${editingId ? 'bg-amber-600' : 'bg-teal-600'} col-span-2 md:col-span-1`}
                        >
                            {editingId ? <Edit size={16} /> : <Plus size={16} />}
                            {editingId ? 'Update Item' : 'Add Item'}
                        </button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left border border-slate-200 dark:border-slate-700 rounded">
                            <thead className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 uppercase">
                                <tr>
                                    <th className="px-4 py-3">Type</th>
                                    <th className="px-4 py-3">Component</th>
                                    <th className="px-4 py-3">Specs</th>
                                    <th className="px-4 py-3">Stock</th>
                                    <th className="px-4 py-3">Landed Cost</th>
                                    <th className="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                {items.map(item => (
                                    <tr key={item.id} className={`hover:bg-slate-50 dark:hover:bg-slate-700/50 ${editingId === item.id ? 'bg-amber-50 dark:bg-amber-900/20' : ''}`}>
                                        <td className="px-4 py-3 capitalize"><span className={`px-2 py-1 rounded-full text-xs ${item.type === 'module' ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300' : item.type === 'ready' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}>{item.type === 'psu' ? 'SMPS' : item.type}</span></td>
                                        <td className="px-4 py-3 dark:text-slate-200">
                                            <div className="font-medium">{item.brand} {item.model}</div>
                                            {item.vendor && <div className="text-[10px] text-teal-600 dark:text-teal-400 mt-0.5">{item.vendor}</div>}
                                        </td>
                                        <td className="px-4 py-3 text-slate-500 dark:text-slate-400 text-xs">
                                            {item.type === 'module' && (
                                                <div className="flex flex-col">
                                                    <span>P{item.pitch} {item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                    <span>{item.width}x{item.height}mm</span>
                                                </div>
                                            )}
                                            {item.type === 'cabinet' && (
                                                <div className="flex flex-col">
                                                    <span>{item.material}</span>
                                                    <span>{item.width}x{item.height}mm</span>
                                                    <span>{item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                </div>
                                            )}
                                            {(item.type === 'card' || item.type === 'processor') && (
                                                <span>{item.ports ? `${item.ports} Ports` : ''}</span>
                                            )}
                                            {item.type === 'psu' && (
                                                <span>{item.amps ? `${item.amps} Amps` : ''}</span>
                                            )}
                                            {item.type === 'ready' && (
                                                <span>{item.width}x{item.height}mm P{item.pitch}</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3 font-bold dark:text-slate-200 text-teal-600">
                                            {transactions.filter(t => t.itemId === item.id).reduce((acc, t) => acc + (t.type === 'in' ? Number(t.qty) : -Number(t.qty)), 0)}
                                        </td>
                                        <td className="px-4 py-3 dark:text-slate-200">
                                            <div className="flex flex-col">
                                                <span className="font-semibold">{formatCurrency((item.price || 0) + (item.carriage || 0), item.currency || 'INR')}</span>
                                                {(item.carriage > 0) && <span className="text-[10px] text-slate-400">Base: {item.price} + Carr: {item.carriage}</span>}
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 flex gap-2">
                                            <button onClick={() => handleEdit(item)} className="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 dark:bg-blue-900/30 rounded"><Edit size={14} /></button>
                                            <button onClick={() => handleDelete(item.id)} className="text-red-400 hover:text-red-600 p-1 bg-red-50 dark:bg-red-900/30 rounded"><Trash2 size={14} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {items.length === 0 && !loading && <div className="text-center py-12 text-slate-400 bg-white dark:bg-slate-800">No items found.</div>}
                    </div>
                </div>
            );
        };

        // 2. Updated Technical Drawing Visualizer (Responsive & Clean)
        const ScreenVisualizer = ({ cols, rows, module, cabinet, unit }) => {
            if (!module || !cabinet) return null;
            
            // Dimensions
            const cabinetW = cabinet.width;
            const cabinetH = cabinet.height;
            const screenW = cabinetW * cols;
            const screenH = cabinetH * rows;
            
            const formatDims = (mm) => {
                const m = (mm / 1000).toFixed(2) + 'm';
                const ft = (mm / 304.8).toFixed(2) + 'ft';
                return `${m} / ${ft}`;
            };

            return (
                <div className="w-full flex flex-col bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <div className="w-full h-full min-h-[300px] p-10 flex items-center justify-center">
                        <div className="relative" style={{ aspectRatio: `${screenW}/${screenH}`, width: '100%', maxHeight: '400px' }}>
                             {/* Top Dimension */}
                             <div className="absolute -top-8 left-0 right-0 text-center text-xs font-bold text-slate-600 flex items-center justify-center gap-2">
                                <div className="h-[1px] flex-1 bg-slate-300"></div>
                                <span className="bg-white px-1 whitespace-nowrap">{formatDims(screenW)} ({cols} Cabinets)</span>
                                <div className="h-[1px] flex-1 bg-slate-300"></div>
                             </div>

                             {/* Left Dimension */}
                             <div className="absolute -left-8 top-0 bottom-0 text-center text-xs font-bold text-slate-600 flex flex-col items-center justify-center gap-2" style={{ writingMode: 'vertical-rl', transform: 'rotate(180deg)' }}>
                                <div className="w-[1px] flex-1 bg-slate-300"></div>
                                <span className="bg-white px-1 whitespace-nowrap">{formatDims(screenH)} ({rows} Cabinets)</span>
                                <div className="w-[1px] flex-1 bg-slate-300"></div>
                             </div>

                             {/* The Grid Itself */}
                             <div 
                                className="w-full h-full grid bg-white border-2 border-slate-900 shadow-sm"
                                style={{
                                    gridTemplateColumns: `repeat(${cols}, 1fr)`,
                                    gridTemplateRows: `repeat(${rows}, 1fr)`
                                }}
                            >
                                {Array.from({ length: cols * rows }).map((_, i) => (
                                    <div key={i} className="border border-slate-300 relative"></div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3.5 Inventory Ledger
        const InventoryLedger = ({ user, inventory, transactions }) => {
            const [newTx, setNewTx] = React.useState({
                date: new Date().toISOString().split('T')[0],
                type: 'in', itemId: '', qty: '', source: '', location: '', notes: ''
            });

            const handleAddTx = async () => {
                if (!newTx.itemId || !newTx.qty) return alert("Item and Quantity are required");
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions').add({
                        ...newTx,
                        qty: Number(newTx.qty),
                        createdAt: new Date()
                    });
                    setNewTx({ ...newTx, qty: '', source: '', notes: '' });
                } catch (e) { console.error(e); }
            };

            const getStock = (id) => transactions.filter(t => t.itemId === id).reduce((acc, t) => acc + (t.type === 'in' ? t.qty : -t.qty), 0);

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                     <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <Box className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Stock Ledger
                        </h2>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-7 gap-2 mb-6 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg items-end">
                        <div className="col-span-1">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Date</label>
                            <input type="date" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.date} onChange={e => setNewTx({...newTx, date: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Action</label>
                            <select className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.type} onChange={e => setNewTx({...newTx, type: e.target.value})}>
                                <option value="in">Stock IN</option>
                                <option value="out">Stock OUT</option>
                            </select>
                        </div>
                        <div className="col-span-2">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Component</label>
                             <select className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.itemId} onChange={e => setNewTx({...newTx, itemId: e.target.value})}>
                                <option value="">Select Item...</option>
                                {['module', 'cabinet', 'ready', 'card', 'processor', 'psu'].map(type => {
                                    const items = inventory.filter(i => i.type === type).sort((a,b) => (a.brand + ' ' + a.model).localeCompare(b.brand + ' ' + b.model));
                                    if (items.length === 0) return null;
                                    return (
                                        <optgroup key={type} label={type === 'psu' ? 'SMPS' : type.toUpperCase()}>
                                            {items.map(i => (
                                                <option key={i.id} value={i.id}>
                                                    {i.brand} {i.model} (Stock: {getStock(i.id)})
                                                </option>
                                            ))}
                                        </optgroup>
                                    );
                                })}
                             </select>
                        </div>
                        <div className="col-span-1">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Qty</label>
                             <input type="number" placeholder="Qty" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.qty} onChange={e => setNewTx({...newTx, qty: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Loc/Source</label>
                             <input placeholder="Source/Loc" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.source} onChange={e => setNewTx({...newTx, source: e.target.value})} />
                        </div>
                         <button onClick={handleAddTx} className="bg-teal-600 text-white p-2 rounded hover:bg-teal-700 font-bold text-sm h-[38px]">Add</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left border border-slate-200 dark:border-slate-700 rounded">
                            <thead className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 uppercase">
                                <tr>
                                    <th className="px-4 py-2">Date</th>
                                    <th className="px-4 py-2">Type</th>
                                    <th className="px-4 py-2">Component</th>
                                    <th className="px-4 py-2">Specs</th>
                                    <th className="px-4 py-2">Qty</th>
                                    <th className="px-4 py-2">Source / Loc</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                {transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(tx => {
                                    const item = inventory.find(i => i.id === tx.itemId) || {};
                                    return (
                                        <tr key={tx.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                            <td className="px-4 py-2 text-slate-500">{tx.date}</td>
                                            <td className="px-4 py-2"><span className={`px-2 py-0.5 rounded text-xs font-bold ${tx.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{tx.type.toUpperCase()}</span></td>
                                            <td className="px-4 py-2 dark:text-slate-200">
                                                <div className="font-medium">{item.brand} {item.model}</div>
                                                {item.vendor && <div className="text-[10px] text-teal-600 dark:text-teal-400 mt-0.5">{item.vendor}</div>}
                                            </td>
                                            <td className="px-4 py-2 text-slate-500 dark:text-slate-400 text-xs">
                                                {item.type === 'module' && (
                                                    <div className="flex flex-col">
                                                        <span>P{item.pitch} {item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                        <span>{item.width}x{item.height}mm</span>
                                                    </div>
                                                )}
                                                {item.type === 'cabinet' && (
                                                    <div className="flex flex-col">
                                                        <span>{item.material}</span>
                                                        <span>{item.width}x{item.height}mm</span>
                                                        <span>{item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                    </div>
                                                )}
                                                {(item.type === 'card' || item.type === 'processor') && (
                                                    <span>{item.ports ? `${item.ports} Ports` : ''}</span>
                                                )}
                                                {item.type === 'psu' && (
                                                    <span>{item.amps ? `${item.amps} Amps` : ''}</span>
                                                )}
                                                {item.type === 'ready' && (
                                                    <span>{item.width}x{item.height}mm P{item.pitch}</span>
                                                )}
                                            </td>
                                            <td className="px-4 py-2 font-bold dark:text-slate-200">{tx.qty}</td>
                                            <td className="px-4 py-2 text-slate-500">{tx.source} {tx.location ? `(${tx.location})` : ''}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 3. Saved Quotes Manager
        const SavedQuotesManager = ({ user, inventory, transactions, exchangeRate, onLoadQuote, onDeleteQuote }) => {
            const [quotes, setQuotes] = React.useState([]);
            const [viewQuote, setViewQuote] = React.useState(null);

            React.useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes')
                    .orderBy('updatedAt', 'desc')
                    .onSnapshot(snap => {
                        setQuotes(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                return () => unsub();
            }, [user]);

            const handleDelete = async (id) => {
                if(confirm("Are you sure you want to delete this quote?")) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes').doc(id).delete();
                }
            };

            const handleView = (quote) => {
                const result = calculateBOM(quote.calculatorState, inventory, transactions, exchangeRate);
                if (result) {
                    setViewQuote({ data: result, client: quote.client, project: quote.project });
                } else {
                    alert("Could not calculate quote. Inventory items might be missing.");
                }
            };

            const handleDownloadExcel = (quote) => {
                const result = calculateBOM(quote.calculatorState, inventory, transactions, exchangeRate);
                if (!result) return alert("Calculation failed.");
                
                let csv = `Project,${quote.project}\nClient,${quote.client}\nDate,${new Date().toLocaleDateString()}\n\n`;
                csv += `Bill of Materials\nComponent,Specification,Qty,Rate,Total\n`;
                
                result.detailedItems.forEach(item => {
                    csv += `"${item.name}","${item.spec}",${item.qty * result.screenQty},${item.unit},${item.total * result.screenQty}\n`;
                });
                
                csv += `\nFinancials\n`;
                csv += `Total Cost,${result.totalProjectCost}\n`;
                csv += `Selling Price,${result.totalProjectSell}\n`;
                csv += `Margin,${result.matrix.margin.total}\n`;

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${quote.project}_Quote.csv`;
                a.click();
            };

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    {viewQuote && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-4xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Eye size={20}/> View Saved Quote</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setViewQuote(null)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                        <button onClick={() => window.print()} className="px-4 py-2 bg-teal-600 text-white hover:bg-teal-700 rounded flex items-center gap-2"><Printer size={16}/> Print / PDF</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-8 bg-slate-200">
                                    <PrintLayout data={{...viewQuote.data, clientName: viewQuote.client, projectName: viewQuote.project}} currency='INR' exchangeRate={exchangeRate} />
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <FileText className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Saved Quotes
                        </h2>
                    </div>

                    <div className="grid gap-4">
                        {quotes.map(quote => {
                            const state = quote.calculatorState || {};
                            const unit = state.unit || 'm';
                            const width = state.finalWidth || state.targetWidth; // Fallback
                            const height = state.finalHeight || state.targetHeight;
                            const pitch = state.selectedPitch || 'N/A';
                            const isIndoor = state.selectedIndoor === 'true';

                            return (
                                <div key={quote.id} className="p-4 border rounded-lg bg-slate-50 dark:bg-slate-700/50 dark:border-slate-600 flex justify-between items-center">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <h3 className="font-bold text-slate-800 dark:text-white">{quote.project || 'Untitled Project'}</h3>
                                            <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${isIndoor ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-green-50 text-green-600 border-green-200'}`}>
                                                {isIndoor ? 'Indoor' : 'Outdoor'}
                                            </span>
                                            <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-200 text-slate-600">P{pitch}</span>
                                        </div>
                                        <p className="text-sm text-slate-500 mb-2">{quote.client || 'No Client'}  {new Date(quote.updatedAt?.seconds * 1000).toLocaleDateString()}</p>

                                        <div className="flex gap-2 flex-wrap text-xs text-slate-600 dark:text-slate-400">
                                            <span className="bg-white dark:bg-slate-800 border dark:border-slate-600 px-2 py-1 rounded">Size: {state.targetWidth} x {state.targetHeight} {unit}</span>
                                            <span className="bg-white dark:bg-slate-800 border dark:border-slate-600 px-2 py-1 rounded">Qty: {state.screenQty || 1}</span>
                                            <span className="bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 border border-teal-100 dark:border-teal-800 px-2 py-1 rounded font-bold">{formatCurrency(quote.finalAmount, 'INR')}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 ml-4">
                                        <button onClick={() => handleView(quote)} className="px-3 py-2 bg-teal-600 text-white rounded text-sm hover:bg-teal-700 flex items-center gap-1"><Eye size={14}/> View</button>
                                        <button onClick={() => handleDownloadExcel(quote)} className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"><Download size={14}/> Excel</button>
                                        <button onClick={() => onLoadQuote(quote, false)} className="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center gap-1"><Edit size={14}/> Edit</button>
                                        <button onClick={() => onLoadQuote(quote, true)} className="px-3 py-2 bg-slate-600 text-white rounded text-sm hover:bg-slate-700 flex items-center gap-1"><Copy size={14}/> Clone</button>
                                        <button onClick={() => handleDelete(quote.id)} className="p-2 text-red-500 hover:bg-red-50 rounded"><Trash2 size={16}/></button>
                                    </div>
                                </div>
                            );
                        })}
                        {quotes.length === 0 && <p className="text-center text-slate-400 py-10">No saved quotes found.</p>}
                    </div>
                </div>
            );
        };

        // 4. Print Layout
        const PrintLayout = ({ data, currency, exchangeRate, date }) => {
            if (!data || !data.moduleType) return null;
            
            const { 
                clientName, projectName, finalWidth, finalHeight, totalCabinets, 
                moduleType, cabinetType, processor, screenQty, totalProjectSell, 
                gridCols, gridRows
            } = data;

            // 1. Technical Calculations
            const screenWidthM = Number(finalWidth);
            const screenHeightM = Number(finalHeight);
            const areaSqm = screenWidthM * screenHeightM;
            const areaSqft = areaSqm * 10.7639;

            // Resolution
            const resW = Math.round((screenWidthM * 1000) / moduleType.pitch);
            const resH = Math.round((screenHeightM * 1000) / moduleType.pitch);

            // Weight: (Module Kg/m2 * Area) + (Cabinet Kg * Qty)
            const totalModWeight = (moduleType.weight || 0) * areaSqm;
            const totalCabWeight = (cabinetType.weight || 0) * totalCabinets;
            const totalWeight = totalModWeight + totalCabWeight;

            // Power
            const avgPower = (moduleType.avgPower || 0) * areaSqm; 
            const maxPower = (moduleType.maxPower || 0) * areaSqm; 

            // 2. Commercial Calculations
            // Get Total Sell Values from calculator state
            const comms = data.commercials || { sellProcTotal: 0, sellInstallTotal: 0, sellStructureTotal: 0 };
            
            // Per Screen Values
            const sellTotalPerScreen = totalProjectSell / screenQty;
            const sellProc = comms.sellProcTotal / screenQty;
            const sellInstall = comms.sellInstallTotal / screenQty;
            const sellStructure = comms.sellStructureTotal / screenQty;
            
            // LED Panel Base = Total - (Processor + Install + Structure)
            const sellLEDBase = sellTotalPerScreen - sellProc - sellInstall - sellStructure;

            // Spares = 2% of the LED Base
            const sellSpares = sellLEDBase * 0.02;
            
            // Final LED Panel = LED Base - Spares
            const sellLEDFinal = sellLEDBase - sellSpares;

            const commercialRows = [
                { name: "LED Panel", rate: sellLEDFinal },
                { name: "Processor", rate: sellProc },
                { name: "Installation", rate: sellInstall },
                { name: "Spares (2%)", rate: sellSpares },
                { name: "Structure", rate: sellStructure },
            ].filter(r => r.rate > 0);

            return (
                <div className="p-8 max-w-[210mm] mx-auto bg-white min-h-screen text-slate-800 print:p-0 print:w-full font-sans text-xs">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-6 border-b-2 border-slate-800 pb-4">
                        <div>
                            {/* Logo Placeholder - Text for now */}
                            <h1 className="text-2xl font-bold text-slate-900 uppercase tracking-wide">ADMIRE SIGN & DISPLAY PVT. LTD.</h1>
                            <div className="text-[10px] text-slate-600 mt-1 space-y-0.5">
                                <p>102, Priya Industrial Estate 4, K.T. Industrial Estate</p>
                                <p>Kherpada, Waliv, Vasai East, Mumbai - 401208</p>
                                <p>Email: info@admiresignage.com | Web: www.admiresignage.com</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <h2 className="text-xl font-light text-slate-500">QUOTATION</h2>
                            <p className="text-sm font-bold text-slate-700">Date: {date || new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    {/* Project & Screen Details */}
                    <div className="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2">Project Details</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Client:</span> <span className="col-span-2 font-bold">{clientName}</span>
                                <span className="font-semibold text-slate-500">Project:</span> <span className="col-span-2 font-bold">{projectName}</span>
                                <span className="font-semibold text-slate-500">Screen Size:</span> <span className="col-span-2">{screenWidthM}m (W) x {screenHeightM}m (H)</span>
                                <span className="font-semibold text-slate-500">Quantity:</span> <span className="col-span-2">{screenQty} Nos</span>
                            </div>

                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mt-4 mb-2">Module & Cabinet</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Module:</span> <span className="col-span-2">{moduleType.brand} P{moduleType.pitch}</span>
                                <span className="font-semibold text-slate-500">Mod Size:</span> <span className="col-span-2">{moduleType.width} x {moduleType.height} mm</span>
                                <span className="font-semibold text-slate-500">Lamp:</span> <span className="col-span-2">{moduleType.lampMake || '-'}</span>
                                <span className="font-semibold text-slate-500">Cabinet:</span> <span className="col-span-2">{cabinetType.material || 'Standard'}</span>
                                <span className="font-semibold text-slate-500">Cab Size:</span> <span className="col-span-2">{cabinetType.width} x {cabinetType.height} mm</span>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2">Screen Specifications</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Resolution:</span> <span className="col-span-2">{resW} x {resH} pixels</span>
                                <span className="font-semibold text-slate-500">Total Area:</span> <span className="col-span-2">{areaSqft.toFixed(2)} Sq.ft / {areaSqm.toFixed(2)} Sq.m</span>
                                <span className="font-semibold text-slate-500">Total Weight:</span> <span className="col-span-2">{totalWeight.toFixed(1)} kg</span>
                                <span className="font-semibold text-slate-500">Avg Power:</span> <span className="col-span-2">{(avgPower).toFixed(0)} Watts</span>
                                <span className="font-semibold text-slate-500">Max Power:</span> <span className="col-span-2">{(maxPower).toFixed(0)} Watts</span>
                                <span className="font-semibold text-slate-500">Brightness:</span> <span className="col-span-2">{moduleType.brightness} nits</span>
                                <span className="font-semibold text-slate-500">Refresh Rate:</span> <span className="col-span-2">{moduleType.refreshRate} Hz</span>
                                <span className="font-semibold text-slate-500">Controller:</span> <span className="col-span-2">{processor ? `${processor.brand} ${processor.model}` : 'Standard'}</span>
                                <span className="font-semibold text-slate-500">Viewing:</span> <span className="col-span-2">H: {moduleType.viewAngleH} / V: {moduleType.viewAngleV}</span>
                                <span className="font-semibold text-slate-500">IP Rating:</span> <span className="col-span-2">Front: IP{moduleType.ipFront} / Back: IP{moduleType.ipBack}</span>
                            </div>
                        </div>
                    </div>

                    {/* Visualizer */}
                    <div className="mb-8 border rounded-lg p-2 bg-slate-50 break-inside-avoid">
                        <ScreenVisualizer cols={gridCols} rows={gridRows} module={moduleType} cabinet={cabinetType} unit="m" />
                    </div>

                    {/* Commercial Quote */}
                    <div className="mb-6 break-inside-avoid">
                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2 pb-1">Commercial Proposal</h3>
                        <table className="w-full border-collapse border border-slate-300 text-[11px]">
                            <thead className="bg-slate-800 text-white">
                                <tr>
                                    <th className="p-2 border border-slate-600 text-left w-12">#</th>
                                    <th className="p-2 border border-slate-600 text-left">Item Description</th>
                                    <th className="p-2 border border-slate-600 text-right w-32">Amount (1 Screen)</th>
                                    <th className="p-2 border border-slate-600 text-right w-32">Amount ({screenQty} Screens)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {commercialRows.map((row, i) => (
                                    <tr key={i}>
                                        <td className="p-2 border border-slate-300 text-center">{i + 1}</td>
                                        <td className="p-2 border border-slate-300 font-bold">{row.name}</td>
                                        <td className="p-2 border border-slate-300 text-right">{formatCurrency(row.rate, currency)}</td>
                                        <td className="p-2 border border-slate-300 text-right font-bold">{formatCurrency(row.rate * screenQty, currency)}</td>
                                    </tr>
                                ))}
                                <tr className="bg-slate-100">
                                    <td colSpan="3" className="p-2 border border-slate-300 text-right font-bold uppercase">Grand Total (Excl. GST)</td>
                                    <td className="p-2 border border-slate-300 text-right font-bold text-sm">{formatCurrency(totalProjectSell, currency)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {/* Terms & Conditions */}
                    <div className="break-inside-avoid">
                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2 pb-1">Terms & Conditions</h3>
                        
                        <div className="text-[10px] text-slate-600 space-y-3">
                            <div className="grid grid-cols-[100px_1fr] gap-y-2 gap-x-4">
                                <div className="font-bold text-slate-800">PRICE</div>
                                <div>{data.terms?.price || 'Ex-works Mumbai'}</div>

                                <div className="font-bold text-slate-800">PAYMENT</div>
                                <div>
                                    {(data.terms?.payment || []).map((p, i) => (
                                        <span key={i}>{p.percent}% {p.name}{i < data.terms.payment.length - 1 ? ', ' : '.'} </span>
                                    ))}
                                </div>

                                <div className="font-bold text-slate-800">DELIVERY</div>
                                <div>Within {data.terms?.deliveryWeeks} weeks from the date of receipt of advance payment with order.</div>

                                <div className="font-bold text-slate-800">GST</div>
                                <div>Extra as applicable (currently 18%)</div>

                                <div className="font-bold text-slate-800">WARRANTY</div>
                                <div className="text-justify leading-snug">
                                    Against any manufacturing defect. Offsite support for troubleshooting. Client can sign up for Admires excellent AMC services for on-site support. 
                                    Serious fault will be attended to by our technical team within 48-72 hours upon receipt of written complaints with pictures/videos of the fault. 
                                    1% Extra spares includes Modules, Power Supply, Receiver Card (if there are over 100 cabinets), Flat cables, 5V connectors, Power and Data Cable. 
                                    Any damage to the screen due to force majure, natural disasters, electricity surge, earthing, accident, etc is not covered under the warranty. 
                                    Power supplies damage due to power fluctuation will not be covered under warranty. Power supply will be under the direct warranty of the OEM supplier. 
                                    If the repair requires additional components then these will be charged extra. Brightness control meter, Video Processor & Timer can be supplied at extra cost. 
                                    Maintenance team visit in six months during warranty period.
                                </div>
                            </div>
                        </div>

                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mt-4 mb-2 pb-1">Client's Scope</h3>
                        <div className="text-[10px] text-slate-600 grid gap-y-2">
                            <div>
                                <span className="font-bold text-slate-800 block">Structure:</span>
                                Foundation & Structure. Structural stability certificate from a consultant. For wall mounted outdoor screen, Client to ensure strong and solid brick wall, RCC beams and column base. 
                                For front access indoor screen, Client to ensure a strong base. Indoor Structures cannot be mounted on ACP Sheets, Gypsum boards etc. 
                                Scaffolding, Aluminium composite panelling if required. Personnel for troubleshooting training during the screen installation. Helpers for loading, unloading and installing the display at site.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Electricity:</span>
                                Electricity 3 phase electric power near the site, not more than 5m from the site, before the commencement of work. Electrical distribution board within 5m from the screen. 
                                Conduited electrical cable. 4mm 2 core armored cable or 4mm 3 core cables, 32 ampere MCB, 1 switch board with 2 sockets. 
                                Good quality Stabiliser and timers. 1 Certified electrical engineer for all connections from power Main to the unit. Ventilation machineries such as Air Conditioners or Fans.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Internet:</span>
                                CAT 6 or Optic Fiber Data cable and its terminations. Data points near the screen. Space with power sockets for Video wall Controllers. 
                                Data source/AV room within 80 meters of the screen. Connections to be availed through CAT 6 cables duly terminated with RJ45. 
                                If the length is farther then Fiber optic converter will be required. Fiber optic converters, if required, will be charged extra. 
                                In case the fiber optic converter is required, single mode Fiber optic cable is to be provided by client from source point to the display, terminated as per specs with Patch Chords from the splicing unit to connect to screen.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Software:</span>
                                3rd party Software for Content upload on screen will be provided by the controller card supplier. Admire cannot provide regular updates and application stability.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Permissions:</span>
                                All permissions such as PTW, work permits & gate passes for workers, engineers and executives.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Computer:</span>
                                As per specification, to be arranged by client.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Validity:</span>
                                30 days.
                            </div>
                        </div>

                        <div className="mt-8 pt-8 border-t border-slate-200 flex justify-between items-end">
                            <div className="text-center">
                                <div className="h-12 mb-2"></div>
                                <p className="text-[10px] font-bold border-t border-slate-400 px-4 pt-1">Client Acceptance</p>
                            </div>
                            <div className="text-center">
                                <div className="h-12 mb-2"></div>
                                <p className="text-[10px] font-bold border-t border-slate-400 px-4 pt-1">For Admire Sign & Display Pvt. Ltd.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. BOM Layout
        const BOMLayout = ({ data }) => {
            if (!data) return null;
            const { clientName, projectName, detailedItems, screenQty } = data;

            return (
                <div className="p-8 max-w-[210mm] mx-auto bg-white min-h-screen text-slate-800 print:p-0 print:w-full font-sans text-xs">
                    <div className="flex justify-between items-start mb-6 border-b-2 border-slate-800 pb-4">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900 uppercase tracking-wide">Bill of Materials</h1>
                            <div className="mt-2">
                                <p className="text-sm font-bold text-slate-700">Project: <span className="font-normal">{projectName}</span></p>
                                <p className="text-sm font-bold text-slate-700">Client: <span className="font-normal">{clientName}</span></p>
                            </div>
                        </div>
                        <div className="text-right">
                            <p className="text-sm font-bold text-slate-700">REF: {generateId()}</p>
                            <p className="text-xs text-slate-500">{new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    <table className="w-full border-collapse border border-slate-300">
                        <thead className="bg-slate-100 text-slate-700">
                            <tr>
                                <th className="p-2 border border-slate-300 text-left w-12">#</th>
                                <th className="p-2 border border-slate-300 text-left">Component</th>
                                <th className="p-2 border border-slate-300 text-left">Specification / Model</th>
                                <th className="p-2 border border-slate-300 text-center w-24">Total Qty</th>
                            </tr>
                        </thead>
                        <tbody>
                            {detailedItems.map((item, i) => (
                                <tr key={i}>
                                    <td className="p-2 border border-slate-300 text-center">{i + 1}</td>
                                    <td className="p-2 border border-slate-300 font-bold">{item.name}</td>
                                    <td className="p-2 border border-slate-300">{item.spec}</td>
                                    <td className="p-2 border border-slate-300 text-center font-bold">{item.qty * screenQty}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                    
                    <div className="mt-8 text-[10px] text-slate-400 border-t border-slate-200 pt-2 text-center">
                        Internal Document  Generated by Admire Signage Tool
                    </div>
                </div>
            );
        };

        // Helper: Extra Input
        const ExtraInput = ({ label, fieldKey, extras, updateExtra, currency }) => (
            <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-500 dark:text-slate-400">{label}</label>
                <div className="flex items-center">
                    <input
                        type="number"
                        value={extras[fieldKey].val}
                        onChange={e => updateExtra(fieldKey, 'val', e.target.value)}
                        className="w-full p-2 border rounded-l text-sm border-r-0 dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    />
                    <button
                        onClick={() => updateExtra(fieldKey, 'type', extras[fieldKey].type === 'abs' ? 'pct' : 'abs')}
                        className={`px-3 py-2 text-xs font-bold border rounded-r w-16 transition-colors dark:border-slate-600 ${extras[fieldKey].type === 'pct' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-100 dark:bg-slate-800 border-slate-300 text-slate-600 dark:text-slate-300'}`}
                    >
                        {extras[fieldKey].type === 'abs' ? (currency === 'INR' ? '' : '$') : '%'}
                    </button>
                </div>
            </div>
        );
// Helper: Shared Calculation Logic
        const calculateBOM = (state, inventory, transactions, exchangeRate) => {
            const {
                screenQty, targetWidth, targetHeight, unit, 
                selectedIndoor, assemblyMode, selectedPitch, selectedModuleId, 
                selectedCabinetId, selectedCardId, selectedPSUId, selectedProcId, 
                sizingMode, readyId, margin, extras, overrides, extraComponents,
                pricingMode, targetSellPrice, commercials, terms
            } = state;

            const getPriceInInr = (item) => {
                if (!item) return 0;
                const basePrice = Number(item.price || 0);
                const carriage = Number(item.carriage || 0);
                const totalBase = basePrice + carriage; 
                if (item.currency === 'USD') return totalBase * exchangeRate;
                return totalBase; 
            };

            let module, cabinet, card, psu, proc;
            let totalModules = 0;

            if (assemblyMode === 'assembled') {
                module = inventory.find(i => i.id === selectedModuleId);
                cabinet = inventory.find(i => i.id === selectedCabinetId);
                card = inventory.find(i => i.id === selectedCardId);
                psu = inventory.find(i => i.id === selectedPSUId);
                proc = inventory.find(i => i.id === selectedProcId);
                if (!module || !cabinet) return null;
            } else {
                const readyUnit = inventory.find(i => i.id === readyId);
                proc = inventory.find(i => i.id === selectedProcId);
                if (!readyUnit) return null;
                module = readyUnit; 
                cabinet = readyUnit;
            }

            // Dimensions
            const w_mm = unit === 'm' ? targetWidth * 1000 : targetWidth * 304.8;
            const h_mm = unit === 'm' ? targetHeight * 1000 : targetHeight * 304.8;

            // Sizing Logic
            const rawCols = w_mm / cabinet.width;
            const rawRows = h_mm / cabinet.height;
            let cols, rows;
            if (sizingMode === 'up') { cols = Math.ceil(rawCols); rows = Math.ceil(rawRows); }
            else if (sizingMode === 'down') { cols = Math.max(1, Math.floor(rawCols)); rows = Math.max(1, Math.floor(rawRows)); }
            else { cols = Math.max(1, Math.round(rawCols)); rows = Math.max(1, Math.round(rawRows)); }

            const finalW_mm = cols * cabinet.width;
            const finalH_mm = rows * cabinet.height;
            const totalCabinetsPerScreen = cols * rows;

            // Area Calculation
            const areaSqFt = (finalW_mm * finalH_mm) / 92903; 

            // --- BUILD ITEM LIST ---
            let rawItems = [];
            if (assemblyMode === 'assembled') {
                const modsPerCab = (Math.floor(cabinet.width / module.width) * Math.floor(cabinet.height / module.height));
                totalModules = totalCabinetsPerScreen * modsPerCab;
                rawItems = [
                    { id: 'modules', inventoryId: selectedModuleId, name: 'Modules', spec: `${module.brand} ${module.model}`, qty: totalModules, unit: getPriceInInr(module), total: totalModules * getPriceInInr(module), type: 'led' },
                    { id: 'cabinets', inventoryId: selectedCabinetId, name: 'Cabinets', spec: `${cabinet.brand} ${cabinet.model}`, qty: totalCabinetsPerScreen, unit: getPriceInInr(cabinet), total: totalCabinetsPerScreen * getPriceInInr(cabinet), type: 'led' },
                    { id: 'cards', inventoryId: selectedCardId, name: 'Cards', spec: card ? card.brand : '-', qty: totalCabinetsPerScreen, unit: getPriceInInr(card), total: totalCabinetsPerScreen * getPriceInInr(card), type: 'led' },
                    { id: 'psu', inventoryId: selectedPSUId, name: 'SMPS', spec: psu ? psu.brand : '-', qty: totalCabinetsPerScreen, unit: getPriceInInr(psu), total: totalCabinetsPerScreen * getPriceInInr(psu), type: 'led' },
                ];
            } else {
                rawItems = [
                    { id: 'ready', inventoryId: readyId, name: 'LED Panels (Ready)', spec: `${cabinet.brand} ${cabinet.model}`, qty: totalCabinetsPerScreen, unit: getPriceInInr(cabinet), total: totalCabinetsPerScreen * getPriceInInr(cabinet), type: 'led' }
                ];
                totalModules = totalCabinetsPerScreen;
            }
            if (proc) {
                // Processor is NOT type 'led', it is 'service' or 'other'
                rawItems.push({ id: 'processor', inventoryId: selectedProcId, name: 'Processor', spec: proc.brand, qty: 1, unit: getPriceInInr(proc), total: getPriceInInr(proc), type: 'service' });
            }

            // Add Extra Components
            if (extraComponents && extraComponents.length > 0) {
                extraComponents.forEach(extra => {
                    const invItem = inventory.find(i => i.id === extra.componentId);
                    if (invItem) {
                        const extraQty = extra.type === 'cabinet' ? (extra.qty * totalCabinetsPerScreen) : extra.qty;
                        rawItems.push({
                            id: extra.id,
                            inventoryId: extra.componentId,
                            name: `Extra: ${invItem.type}`,
                            spec: `${invItem.brand} ${invItem.model}`,
                            qty: extraQty,
                            unit: getPriceInInr(invItem),
                            total: extraQty * getPriceInInr(invItem),
                            type: invItem.type === 'processor' ? 'service' : 'led' // Categorize extra components
                        });
                    }
                });
            }

            // --- APPLY OVERRIDES ---
            const finalItems = rawItems.map(item => {
                if (overrides && overrides[item.id]) {
                    const ov = overrides[item.id];
                    const finalQty = ov.qty !== undefined && ov.qty !== '' ? Number(ov.qty) : item.qty;
                    const finalRate = ov.rate !== undefined && ov.rate !== '' ? Number(ov.rate) : item.unit;
                    return { ...item, qty: finalQty, unit: finalRate, total: finalQty * finalRate, isOverridden: true };
                }
                return item;
            });

            // --- SPLIT COSTS: LED vs SERVICES ---
            const ledItemsTotal = finalItems.filter(i => i.type === 'led').reduce((acc, i) => acc + i.total, 0);
            const serviceItemsTotal = finalItems.filter(i => i.type !== 'led').reduce((acc, i) => acc + i.total, 0);

            // Extras: Split logic
            const calculatedExtras = {};
            let ledOpsCost = 0;
            let serviceOpsCost = 0;

            if(extras) {
                Object.keys(extras).forEach(key => {
                    const item = extras[key];
                    let val = 0;
                    
                    // NEW: Sync Cost Unit with Sell Unit
                    if (key === 'install') {
                         const mode = commercials?.installation?.unit || 'sqft';
                         const rate = Number(item.val); // Input is now treated as Rate based on mode
                         if (mode === 'sqft') val = rate * areaSqFt; // Rate * Area
                         else val = rate; // Rate is Flat Amount
                    } 
                    else if (key === 'structure') {
                         const mode = commercials?.structure?.unit || 'sqft';
                         const rate = Number(item.val);
                         if (mode === 'sqft') val = rate * areaSqFt;
                         else val = rate;
                    }
                    // Standard Logic for other overheads
                    else {
                        const baseForPct = ledItemsTotal; 
                        if (item.type === 'pct') val = baseForPct * (item.val / 100);
                        else val = Number(item.val);
                    }

                    calculatedExtras[key] = val;

                    if (key === 'structure' || key === 'install') {
                        serviceOpsCost += val;
                    } else {
                        ledOpsCost += val;
                    }
                });
            }
            
            // COST TOTALS (Per Screen)
            const costLEDPerScreen = ledItemsTotal + ledOpsCost;
            const costServicesPerScreen = serviceItemsTotal + serviceOpsCost;
            const costPerScreenTotal = costLEDPerScreen + costServicesPerScreen;

            const totalProjectCost = costPerScreenTotal * screenQty;

            // --- COMMERCIALS / SELL PRICE LOGIC ---
            
            // 1. Calculate Service Sell Prices (Fixed Inputs)
            const comms = commercials || { processor: {val:0}, installation: {val:0}, structure: {val:0} };
            
            // Processor SP
            let sellProcTotal = 0;
            if (comms.processor.unit === 'unit') {
                const procItem = finalItems.find(i => i.id === 'processor'); // Find overridden qty if exists
                const procQty = procItem ? procItem.qty : 1; 
                sellProcTotal = Number(comms.processor.val) * procQty * screenQty;
            } else { // per screen
                sellProcTotal = Number(comms.processor.val) * screenQty;
            }

            // Installation SP
            let sellInstallTotal = 0;
            if (comms.installation.unit === 'sqft') {
                sellInstallTotal = Number(comms.installation.val) * areaSqFt * screenQty;
            } else { // per screen
                sellInstallTotal = Number(comms.installation.val) * screenQty;
            }

            // Structure SP
            let sellStructureTotal = 0;
            if (comms.structure.unit === 'sqft') {
                sellStructureTotal = Number(comms.structure.val) * areaSqFt * screenQty;
            } else { // per screen
                sellStructureTotal = Number(comms.structure.val) * screenQty;
            }
            
            const totalServiceSell = sellProcTotal + sellInstallTotal + sellStructureTotal;
            const sellServicesPerScreen = totalServiceSell / screenQty;

            // 2. Calculate LED Panel Sell Price (The Variable/Target)
            let sellLEDPerScreen = 0;
            let effectiveMargin = margin;
            const mode = pricingMode || 'margin';

            if (mode === 'margin') {
                // Formula: Cost / (1 - Margin%) -> GROSS MARGIN Logic
                // If user enters 30%, they expect 30% profit on the sell price.
                // However, standard markup is Cost * (1 + Margin%).
                // Let's stick to the industry standard requested: "Cost + Margin%" usually implies Markup in simple tools,
                // BUT the user explicitly compared to Excel which used Gross Margin logic (Profit/Sell).
                // Let's use Markup (Cost * 1.X) as it's safer/standard for simple calculators unless 'Gross Margin' is explicitly requested.
                // Re-reading prompt: "User input of Margin %... should only be for the LED Panel".
                // I will use simple Markup for now: Cost * (1 + M/100). 
                sellLEDPerScreen = costLEDPerScreen * (1 + margin/100);
            } else {
                const target = Number(targetSellPrice || 0);
                if (mode === 'screen') sellLEDPerScreen = target;
                else if (mode === 'sqft') sellLEDPerScreen = target * areaSqFt;
                else if (mode === 'sqm') sellLEDPerScreen = target * (areaSqFt / 10.7639);
                
                // Reverse Calculate Effective Margin for LED Panel
                if (costLEDPerScreen > 0) effectiveMargin = ((sellLEDPerScreen - costLEDPerScreen) / costLEDPerScreen) * 100;
                else effectiveMargin = 0;
            }

            const totalLEDSell = sellLEDPerScreen * screenQty;
            
            // --- FINAL TOTALS ---
            const totalProjectSell = totalLEDSell + totalServiceSell;
            const totalMargin = totalProjectSell - totalProjectCost;

            return {
                gridCols: cols, gridRows: rows,
                finalWidth: (finalW_mm / 1000).toFixed(2), finalHeight: (finalH_mm / 1000).toFixed(2),
                totalCabinets: totalCabinetsPerScreen, moduleType: module, cabinetType: cabinet, processor: proc,
                breakdown: { 
                    qtyModules: totalModules, 
                    ledOps: ledOpsCost,
                    serviceOps: serviceOpsCost 
                },
                detailedItems: finalItems, calculatedExtras, 
                
                // Costs
                costLEDPerScreen,
                costServicesPerScreen,
                costPerScreen: costPerScreenTotal,
                totalProjectCost,
                
                // Sales
                finalPrice: totalProjectSell, 
                totalProjectSell, 
                
                assemblyMode, screenQty, 
                commercials: { sellProcTotal, sellInstallTotal, sellStructureTotal },
                terms: terms || { price: 'Ex-works Mumbai', deliveryWeeks: 10, payment: [] },
                
                // Matrix for UI
                matrix: {
                    cost: { sqft: costPerScreenTotal / areaSqFt, unit: costPerScreenTotal, total: totalProjectCost },
                    margin: { sqft: (totalMargin/screenQty) / areaSqFt, unit: (totalMargin/screenQty), total: totalMargin },
                    sell: { sqft: (totalProjectSell/screenQty) / areaSqFt, unit: (totalProjectSell/screenQty), total: totalProjectSell },
                    
                    // Specific LED Panel Metrics (for the Calculator UI focus)
                    led: {
                        cost: costLEDPerScreen,
                        sell: sellLEDPerScreen,
                        margin: sellLEDPerScreen - costLEDPerScreen,
                        marginPct: effectiveMargin
                    },
                    
                    sqft: { perScreen: areaSqFt, total: areaSqFt * screenQty }
                }
            };
        };
        // 5. Main Calculator (Stateless - Props Only)
        const QuoteCalculator = ({ user, inventory, transactions, state, setState, exchangeRate, setExchangeRate, onSaveQuote }) => {
            const {
                client, project, screenQty, targetWidth, targetHeight, unit, 
                selectedIndoor, assemblyMode, selectedPitch, selectedModuleId, 
                selectedCabinetId, selectedCardId, selectedPSUId, selectedProcId, 
                sizingMode, readyId, margin, extras, overrides, editingRow
            } = state;

            const [calculation, setCalculation] = React.useState(null);
            const [showPreview, setShowPreview] = React.useState(false); 
            const [showStock, setShowStock] = React.useState(false);
            const [showBOM, setShowBOM] = React.useState(false);

            const getStock = (id) => transactions ? transactions.filter(t => t.itemId === id).reduce((acc, t) => acc + (t.type === 'in' ? Number(t.qty) : -Number(t.qty)), 0) : 0;

            const updateState = (key, value) => setState(prev => ({ ...prev, [key]: value }));
            const updateExtra = (key, field, val) => {
                setState(prev => ({ ...prev, extras: { ...prev.extras, [key]: { ...prev.extras[key], [field]: val } } }));
            };

            const handleOverride = (id, field, value) => {
                setState(prev => ({
                    ...prev, overrides: { ...prev.overrides, [id]: { ...prev.overrides[id], [field]: value } }
                }));
            };

            const clearOverride = (id) => {
                const newOverrides = { ...overrides };
                delete newOverrides[id];
                updateState('overrides', newOverrides);
                updateState('editingRow', null);
            };

            const toggleEditRow = (id) => {
                updateState('editingRow', editingRow === id ? null : id);
            };

            const handleReset = () => {
                if (confirm("Reset calculator to defaults?")) {
                    setState({
                        client: '', project: '', screenQty: '', targetWidth: '', targetHeight: '', unit: 'ft', 
                        selectedIndoor: 'true', assemblyMode: 'assembled', selectedPitch: '',
                        selectedModuleId: '', selectedCabinetId: '', selectedCardId: '',
                        selectedPSUId: '', selectedProcId: '', sizingMode: 'closest', readyId: '',
                        margin: 30, pricingMode: 'margin', targetSellPrice: 0,
                        extraComponents: [],
                        commercials: { 
                            processor: {val: 0, unit: 'screen'}, 
                            installation: {val: 0, unit: 'sqft'}, 
                            structure: {val: 0, unit: 'sqft'} 
                        },
                        terms: {
                            price: 'Ex-works Mumbai',
                            deliveryWeeks: 10,
                            payment: [
                                { name: "Advance with order", percent: 60 },
                                { name: "Before dispatch", percent: 30 },
                                { name: "After installation", percent: 10 }
                            ]
                        },
                        extras: {
                            assembly: { val: 0, type: 'abs' }, 
                            hardware: { val: 0, type: 'abs' }, 
                            packaging: { val: 0, type: 'abs' }, 
                            transport: { val: 0, type: 'abs' }, 
                            install: { val: 0, type: 'abs' }, 
                            wastage: { val: 0, type: 'abs' }, 
                            overheads: { val: 0, type: 'abs' }, 
                            structure: { val: 0, type: 'abs' } 
                        },
                        overrides: {},
                        editingRow: null
                    });
                }
            };

            // Filters
            const isIndoor = selectedIndoor === 'true';
            const availableModules = inventory.filter(i => i.type === 'module' && i.indoor === isIndoor);
            const uniquePitches = [...new Set(availableModules.map(m => m.pitch))].sort((a, b) => a - b);
            const filteredModules = selectedPitch ? availableModules.filter(m => m.pitch == selectedPitch) : [];
            const readyUnits = inventory.filter(i => i.type === 'ready' && i.indoor === isIndoor);

            const selectedModule = inventory.find(i => i.id === selectedModuleId);
            const cabinets = inventory.filter(i => {
                if (i.type !== 'cabinet') return false;
                if (!selectedModule) return true;
                const wMod = i.width % selectedModule.width;
                const hMod = i.height % selectedModule.height;
                return wMod === 0 && hMod === 0;
            });

            const cards = inventory.filter(i => i.type === 'card');
            const psus = inventory.filter(i => i.type === 'psu');
            const processors = inventory.filter(i => i.type === 'processor');

            // --- REAL-TIME CALCULATION ---
            React.useEffect(() => {
                const result = calculateBOM(state, inventory, transactions, exchangeRate);
                setCalculation(result);
}, [targetWidth, targetHeight, unit, selectedIndoor, assemblyMode, selectedPitch, selectedModuleId, selectedCabinetId, selectedCardId, selectedPSUId, selectedProcId, readyId, sizingMode, margin, extras, inventory, exchangeRate, screenQty, overrides, state.pricingMode, state.targetSellPrice, state.extraComponents, state.commercials, state.terms]);

             return (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 relative">

                    {/* PDF Preview Modal */}
                    {showPreview && calculation && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-4xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Eye size={20} /> Print Preview</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowPreview(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                        <button onClick={() => window.print()} className="px-4 py-2 bg-teal-600 text-white hover:bg-teal-700 rounded flex items-center gap-2"><Printer size={16} /> Print / Save PDF</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-8 bg-slate-200">
                                    <PrintLayout data={{ ...calculation, clientName: client, projectName: project, margin }} currency='INR' exchangeRate={exchangeRate} />
                                </div>
                            </div>
                       </div>
                    )}

                    {/* BOM Preview Modal */}
                    {showBOM && calculation && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-4xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><FileText size={20}/> Bill of Materials</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowBOM(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                        <button onClick={() => window.print()} className="px-4 py-2 bg-slate-800 text-white hover:bg-slate-900 rounded flex items-center gap-2"><Printer size={16}/> Print BOM</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-8 bg-slate-200">
                                    <BOMLayout data={{...calculation, clientName: client, projectName: project}} />
                                </div>
                            </div>
                        </div>
                    )}
                    
                    <div className="print-only">
                         {showBOM && calculation && <BOMLayout data={{...calculation, clientName: client, projectName: project}} />}
                    </div>

                    {/* Stock Check Modal */}
                    {showStock && calculation && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-2xl w-full rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Box size={20}/> Stock Availability Check</h2>
                                    <button onClick={() => setShowStock(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                </div>
                                <div className="p-6">
                                    <table className="w-full text-sm text-left border border-slate-200">
                                        <thead className="bg-slate-50 text-slate-600 uppercase font-bold text-xs">
                                            <tr>
                                                <th className="px-4 py-2">Component</th>
                                                <th className="px-4 py-2 text-center">Required</th>
                                                <th className="px-4 py-2 text-center">In Stock</th>
                                                <th className="px-4 py-2 text-center">Balance</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {calculation.detailedItems.map((item, i) => {
                                                const reqQty = item.qty * screenQty;
                                                const stock = item.inventoryId ? getStock(item.inventoryId) : 0;
                                                const balance = stock - reqQty;
                                                
                                                return (
                                                    <tr key={i}>
                                                        <td className="px-4 py-2">
                                                            <div className="font-medium text-slate-800">{item.name}</div>
                                                            <div className="text-xs text-slate-500">{item.spec}</div>
                                                        </td>
                                                        <td className="px-4 py-2 text-center font-bold">{reqQty}</td>
                                                        <td className="px-4 py-2 text-center text-slate-600">{stock}</td>
                                                        <td className={`px-4 py-2 text-center font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                            {balance}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="print-only">
                        {calculation && <PrintLayout data={{ ...calculation, clientName: client, projectName: project, margin }} currency='INR' exchangeRate={exchangeRate} />}
                    </div>

                    {/* Left: Configuration */}
                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><Settings className="w-4 h-4 text-teal-600 dark:text-teal-400" /> Project Specs</h3>
                                <div className="flex items-center gap-2">
                                    <button onClick={handleReset} className="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase hover:bg-red-50 dark:hover:bg-red-900/20 px-2 py-1 rounded transition-colors mr-1">Reset</button>
                                    <div className="flex items-center bg-slate-100 dark:bg-slate-700 rounded px-2" title="Exchange rate for USD items">
                                        <span className="text-[10px] text-slate-500 mr-1">1$ = </span>
                                        <input
                                            type="number"
                                            value={exchangeRate}
                                            onChange={e => setExchangeRate(Number(e.target.value))}
                                            className="w-10 bg-transparent text-xs py-1 outline-none font-bold dark:text-white"
                                        />
                                    </div>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3 mb-4">
                                <input value={client} onChange={e => updateState('client', e.target.value)} className="p-2 border rounded text-sm w-full dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Client Name" />
                                <input value={project} onChange={e => updateState('project', e.target.value)} className="p-2 border rounded text-sm w-full dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Project Name" />
                            </div>

                            <div className="grid grid-cols-3 gap-3 mb-4">
                                <div className="flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs text-slate-500 dark:text-slate-400">Width</label>
                                        <div className="flex text-[10px] bg-slate-100 dark:bg-slate-700 rounded p-0.5">
                                            <button onClick={() => updateState('unit', 'm')} className={`px-1.5 rounded ${unit === 'm' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-400'}`}>m</button>
                                            <button onClick={() => updateState('unit', 'ft')} className={`px-1.5 rounded ${unit === 'ft' ? 'bg-white dark:bg-slate-600 shadow text-slate-800 dark:text-white' : 'text-slate-400'}`}>ft</button>
                                        </div>
                                    </div>
                                    <input type="number" value={targetWidth} onChange={e => updateState('targetWidth', e.target.value)} className="w-full p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
                                </div>
                                <div className="flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs text-slate-500 dark:text-slate-400">Height</label>
                                        <span className="text-[10px] text-slate-400 px-1 py-0.5">{unit}</span>
                                    </div>
                                    <input type="number" value={targetHeight} onChange={e => updateState('targetHeight', e.target.value)} className="w-full p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" />
                                </div>
                                <div className="flex flex-col gap-1">
                                    <div className="flex justify-between items-center">
                                        <label className="text-xs text-slate-500 dark:text-slate-400 font-bold text-teal-600">Quantity</label>
                                    </div>
                                    <input type="number" min="1" value={screenQty} onChange={e => updateState('screenQty', Math.max(1, parseInt(e.target.value)) || 1)} className="w-full p-2 border border-teal-200 rounded text-sm dark:bg-slate-700 dark:border-teal-900 dark:text-white font-bold" />
                                </div>
                            </div>

                            <div className="mb-4">
                                <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Sizing Mode</label>
                                <div className="flex gap-1 mt-1 text-xs">
                                    {['closest', 'up', 'down'].map(m => (
                                        <button key={m} onClick={() => updateState('sizingMode', m)} className={`flex-1 py-2 rounded border capitalize ${sizingMode === m ? 'bg-teal-600 text-white border-teal-600' : 'bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white'}`}>{m === 'closest' ? 'Closest' : `Round ${m}`}</button>
                                    ))}
                                </div>
                            </div>

                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">1. Application</label>
                                    <div className="flex gap-2 mt-1">
                                        <button onClick={() => { updateState('selectedIndoor', 'true'); updateState('selectedModuleId', ''); updateState('readyId', ''); }} className={`flex-1 py-2 text-sm rounded border transition-colors ${selectedIndoor === 'true' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>Indoor</button>
                                        <button onClick={() => { updateState('selectedIndoor', 'false'); updateState('selectedModuleId', ''); updateState('readyId', ''); }} className={`flex-1 py-2 text-sm rounded border transition-colors ${selectedIndoor === 'false' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>Outdoor</button>
                                    </div>
                                </div>

                                <div>
                                    <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">2. Supply Type</label>
                                    <div className="flex gap-2 mt-1">
                                        <button onClick={() => updateState('assemblyMode', 'assembled')} className={`flex-1 py-2 text-sm rounded border transition-colors ${assemblyMode === 'assembled' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>Assembled</button>
                                        <button onClick={() => updateState('assemblyMode', 'ready')} className={`flex-1 py-2 text-sm rounded border transition-colors ${assemblyMode === 'ready' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-50 dark:bg-slate-700 dark:border-slate-600 dark:text-slate-300'}`}>Ready Cabinet</button>
                                    </div>
                                </div>

                                {assemblyMode === 'assembled' ? (
                                    <>
                                        <div className="grid grid-cols-2 gap-2 mt-1">
                                            <select value={selectedPitch} onChange={e => { updateState('selectedPitch', e.target.value); updateState('selectedModuleId', ''); }} className="p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                                <option value="">Pitch...</option>
                                                {uniquePitches.map(p => <option key={p} value={p}>P{p}</option>)}
                                            </select>
                                            <select value={selectedModuleId} onChange={e => updateState('selectedModuleId', e.target.value)} className="p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white" disabled={!selectedPitch}>
                                                <option value="">Select Variant...</option>
                                                {filteredModules.map(m => <option key={m.id} value={m.id}>{m.brand} {m.model}</option>)}
                                            </select>
                                        </div>
                                        {selectedModule ? (
                                            <select value={selectedCabinetId} onChange={e => updateState('selectedCabinetId', e.target.value)} className="w-full p-2 border rounded text-sm mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                                <option value="">Select Cabinet...</option>
                                                {cabinets.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model} ({c.width}x{c.height})</option>)}
                                            </select>
                                        ) : (
                                            <div className="text-xs text-amber-600 p-2 bg-amber-50 dark:bg-amber-900/20 rounded mt-1">Select a module first</div>
                                        )}
                                        <div className="space-y-2 mt-1">
                                            <select value={selectedCardId} onChange={e => updateState('selectedCardId', e.target.value)} className="w-full p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">Receiving Card...</option>{cards.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model}</option>)}</select>
                                            <select value={selectedPSUId} onChange={e => updateState('selectedPSUId', e.target.value)} className="w-full p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">SMPS...</option>{psus.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model}</option>)}</select>
                                        </div>
                                    </>
                                ) : (
                                    <div className="mt-2">
                                        <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Select Screen Model</label>
                                        <select value={readyId} onChange={e => updateState('readyId', e.target.value)} className="w-full p-2 border rounded text-sm mt-1 dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                                            <option value="">Select Ready Unit...</option>
                                            {readyUnits.map(u => <option key={u.id} value={u.id}>{u.brand} {u.model} (P{u.pitch})</option>)}
                                        </select>
                                    </div>
                                )}
                                <select value={selectedProcId} onChange={e => updateState('selectedProcId', e.target.value)} className="w-full p-2 border rounded text-sm dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">Processor...</option>{processors.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model}</option>)}</select>
                            </div>

                            <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 block">Extra Components</label>
                                {(state.extraComponents || []).map((extra, idx) => (
                                    <div key={extra.id} className="flex gap-2 mb-2 items-center">
                                        <select 
                                            className="flex-1 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white w-24"
                                            value={extra.componentId}
                                            onChange={e => {
                                                const newExtras = [...state.extraComponents];
                                                newExtras[idx].componentId = e.target.value;
                                                updateState('extraComponents', newExtras);
                                            }}
                                        >
                                            <option value="">Select...</option>
                                            {['module', 'cabinet', 'ready', 'card', 'processor', 'psu'].map(type => {
                                                const items = inventory.filter(i => i.type === type).sort((a,b) => (a.brand + ' ' + a.model).localeCompare(b.brand + ' ' + b.model));
                                                if (items.length === 0) return null;
                                                return (
                                                    <optgroup key={type} label={type === 'psu' ? 'SMPS' : type.toUpperCase()}>
                                                        {items.map(i => <option key={i.id} value={i.id}>{i.brand} {i.model}</option>)}
                                                    </optgroup>
                                                );
                                            })}
                                        </select>
                                        <input 
                                            type="number" 
                                            className="w-12 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                                            value={extra.qty}
                                            onChange={e => {
                                                const newExtras = [...state.extraComponents];
                                                newExtras[idx].qty = Number(e.target.value);
                                                updateState('extraComponents', newExtras);
                                            }}
                                        />
                                        <select 
                                            className="w-20 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                                            value={extra.type}
                                            onChange={e => {
                                                const newExtras = [...state.extraComponents];
                                                newExtras[idx].type = e.target.value;
                                                updateState('extraComponents', newExtras);
                                            }}
                                        >
                                            <option value="screen">/Screen</option>
                                            <option value="cabinet">/Cab</option>
                                        </select>
                                        <button 
                                            onClick={() => {
                                                const newExtras = state.extraComponents.filter((_, i) => i !== idx);
                                                updateState('extraComponents', newExtras);
                                            }}
                                            className="p-1 text-red-400 hover:text-red-600"
                                        ><X size={14}/></button>
                                    </div>
                                ))}
                                <button 
                                    onClick={() => updateState('extraComponents', [...(state.extraComponents || []), { id: generateId(), componentId: '', qty: 1, type: 'screen' }])}
                                    className="text-xs flex items-center gap-1 text-teal-600 font-bold hover:underline"
                                >
                                    <Plus size={12}/> Add Extra Component
                                </button>
                            </div>
                        </div>
                    </div>

{/* Middle: Extras & Costs */}
<div className="lg:col-span-4 space-y-6">
    <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
        <h3 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2">
            <Wrench className="w-4 h-4 text-teal-600 dark:text-teal-400" /> Commercials & Overheads
        </h3>

        {/* REVISED: Commercials (Cost & Sell Grouped) */}
        <div className="mb-6 bg-slate-50 dark:bg-slate-700/30 p-3 rounded border border-slate-200 dark:border-slate-600">
            <div className="flex justify-between items-end mb-3">
                <h4 className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase">Cost vs Sell</h4>
                <div className="flex gap-4 text-[10px] uppercase font-bold text-slate-400 mr-2">
                    <span className="w-24 text-center">Est. Cost</span>
                    <span className="w-24 text-center">Selling Price</span>
                </div>
            </div>

            <div className="space-y-3">
                {/* 1. Processor (Cost is usually BOM based, so mostly Sell here) */}
                <div className="flex items-center justify-between gap-2">
                    <label className="text-xs text-slate-500 dark:text-slate-400 font-bold w-20">Processor</label>
                    <div className="flex-1 flex gap-2 justify-end">
                        <div className="w-full max-w-[140px] flex items-center justify-end text-xs text-slate-400 italic pr-2">
                            (See BOM)
                        </div>
                        <div className="w-full max-w-[180px] flex items-center gap-1">
                            <input 
                                type="number" 
                                className="flex-1 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.processor?.val} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, processor: {...p.commercials.processor, val: e.target.value}}}))} 
                            />
                            <select 
                                className="w-16 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.processor?.unit} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, processor: {...p.commercials.processor, unit: e.target.value}}}))}
                            >
                                <option value="screen">/Scrn</option>
                                <option value="unit">/Unit</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* 2. Installation (Cost Input + Sell Input) */}
                <div className="flex items-center justify-between gap-2">
                    <label className="text-xs text-slate-500 dark:text-slate-400 font-bold w-20">Installation</label>
                    <div className="flex-1 flex gap-2 justify-end">
                        {/* Cost Input (Moved from Extras) */}
                        <div className="w-full max-w-[140px] flex items-center">
                            <input
                                type="number"
                                value={extras['install'].val}
                                onChange={e => updateExtra('install', 'val', e.target.value)}
                                className="w-full p-1.5 border rounded-l text-xs border-r-0 dark:bg-slate-700 dark:border-slate-500 dark:text-white"
                                placeholder="Cost"
                            />
                            <button
                                onClick={() => updateExtra('install', 'type', extras['install'].type === 'abs' ? 'pct' : 'abs')}
                                className={`px-1.5 py-1.5 text-[10px] font-bold border rounded-r w-8 transition-colors dark:border-slate-500 ${extras['install'].type === 'pct' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-100 dark:bg-slate-800 border-slate-300 text-slate-600 dark:text-slate-300'}`}
                            >
                                {extras['install'].type === 'abs' ? '' : '%'}
                            </button>
                        </div>
                        
                        {/* Sell Input */}
                        <div className="w-full max-w-[180px] flex items-center gap-1">
                            <input 
                                type="number" 
                                className="flex-1 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.installation?.val} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, installation: {...p.commercials.installation, val: e.target.value}}}))} 
                            />
                            <select 
                                className="w-16 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.installation?.unit} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, installation: {...p.commercials.installation, unit: e.target.value}}}))}
                            >
                                <option value="sqft">/Sft</option>
                                <option value="screen">/Scrn</option>
                            </select>
                        </div>
                    </div>
                </div>

                {/* 3. Structure (Cost Input + Sell Input) */}
                <div className="flex items-center justify-between gap-2">
                    <label className="text-xs text-slate-500 dark:text-slate-400 font-bold w-20">Structure</label>
                    <div className="flex-1 flex gap-2 justify-end">
                        {/* Cost Input (Moved from Extras) */}
                        <div className="w-full max-w-[140px] flex items-center">
                            <input
                                type="number"
                                value={extras['structure'].val}
                                onChange={e => updateExtra('structure', 'val', e.target.value)}
                                className="w-full p-1.5 border rounded-l text-xs border-r-0 dark:bg-slate-700 dark:border-slate-500 dark:text-white"
                                placeholder="Cost"
                            />
                            <button
                                onClick={() => updateExtra('structure', 'type', extras['structure'].type === 'abs' ? 'pct' : 'abs')}
                                className={`px-1.5 py-1.5 text-[10px] font-bold border rounded-r w-8 transition-colors dark:border-slate-500 ${extras['structure'].type === 'pct' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-100 dark:bg-slate-800 border-slate-300 text-slate-600 dark:text-slate-300'}`}
                            >
                                {extras['structure'].type === 'abs' ? '' : '%'}
                            </button>
                        </div>

                        {/* Sell Input */}
                        <div className="w-full max-w-[180px] flex items-center gap-1">
                            <input 
                                type="number" 
                                className="flex-1 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.structure?.val} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, structure: {...p.commercials.structure, val: e.target.value}}}))} 
                            />
                            <select 
                                className="w-16 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" 
                                value={state.commercials?.structure?.unit} 
                                onChange={e => setState(p => ({...p, commercials: {...p.commercials, structure: {...p.commercials.structure, unit: e.target.value}}}))}
                            >
                                <option value="sqft">/Sft</option>
                                <option value="screen">/Scrn</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {/* REVISED: Terms & Conditions Inputs (No changes needed here, just kept for context) */}
        <div className="mb-6 bg-slate-50 dark:bg-slate-700/30 p-3 rounded border border-slate-200 dark:border-slate-600">
             {/* ... (Keep existing Terms code) ... */}
            <h4 className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-3">Terms & Conditions</h4>
            <div className="space-y-3">
                <div className="flex flex-col gap-1">
                    <label className="text-xs text-slate-500 dark:text-slate-400">Price Basis</label>
                    <input className="w-full p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" value={state.terms?.price || ''} onChange={e => setState(p => ({...p, terms: {...p.terms, price: e.target.value}}))} />
                </div>
                <div className="flex flex-col gap-1">
                    <label className="text-xs text-slate-500 dark:text-slate-400">Delivery (Weeks)</label>
                    <div className="flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                        <span>Within</span>
                        <input type="number" className="w-12 p-1.5 border rounded text-center dark:bg-slate-700 dark:border-slate-500 dark:text-white font-bold" value={state.terms?.deliveryWeeks || 0} onChange={e => setState(p => ({...p, terms: {...p.terms, deliveryWeeks: e.target.value}}))} />
                        <span>weeks from advance</span>
                    </div>
                </div>
                <div className="flex flex-col gap-1">
                    <label className="text-xs text-slate-500 dark:text-slate-400 flex justify-between">
                        <span>Payment Milestones</span>
                        <button onClick={() => setState(p => ({...p, terms: {...p.terms, payment: [...(p.terms.payment || []), {name: '', percent: 0}]}}))} className="text-teal-600 hover:underline font-bold">+ Add</button>
                    </label>
                    {(state.terms?.payment || []).map((ms, idx) => (
                        <div key={idx} className="flex gap-1 items-center">
                            <input placeholder="Name" className="flex-1 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white" value={ms.name} onChange={e => {
                                const newPay = [...state.terms.payment];
                                newPay[idx].name = e.target.value;
                                setState(p => ({...p, terms: {...p.terms, payment: newPay}}));
                            }} />
                            <input type="number" placeholder="%" className="w-10 p-1.5 border rounded text-xs dark:bg-slate-700 dark:border-slate-500 dark:text-white text-center" value={ms.percent} onChange={e => {
                                const newPay = [...state.terms.payment];
                                newPay[idx].percent = Number(e.target.value);
                                setState(p => ({...p, terms: {...p.terms, payment: newPay}}));
                            }} />
                            <span className="text-xs text-slate-400">%</span>
                            <button onClick={() => {
                                const newPay = state.terms.payment.filter((_, i) => i !== idx);
                                setState(p => ({...p, terms: {...p.terms, payment: newPay}}));
                            }} className="text-red-400 hover:text-red-600 p-1"><X size={12}/></button>
                        </div>
                    ))}
                </div>
            </div>
        </div>

        {/* REVISED: Other Costs Grid (Removed Structure and Install from here) */}
        <h4 className="text-xs font-bold text-slate-700 dark:text-slate-300 uppercase mb-2">Operational Costs</h4>
        <div className="grid grid-cols-2 gap-4 text-sm">
            <ExtraInput label="Hardware & Cables" fieldKey="hardware" extras={extras} updateExtra={updateExtra} currency='INR' />
            <ExtraInput label="Assembly Labour" fieldKey="assembly" extras={extras} updateExtra={updateExtra} currency='INR' />
            <ExtraInput label="Packaging" fieldKey="packaging" extras={extras} updateExtra={updateExtra} currency='INR' />
            <ExtraInput label="Transport" fieldKey="transport" extras={extras} updateExtra={updateExtra} currency='INR' />
            {/* Removed Install Labour */}
            <ExtraInput label="Wastage / Buffer" fieldKey="wastage" extras={extras} updateExtra={updateExtra} currency='INR' />
            <ExtraInput label="Operational Overheads" fieldKey="overheads" extras={extras} updateExtra={updateExtra} currency='INR' />
        </div>

        {/* ... (Keep existing Financial Matrix / Total table) ... */}
        {calculation && (
             <div className="mt-6 pt-6 border-t border-slate-100 dark:border-slate-700">
                {/* ... existing table code ... */}
                <div className="mb-4 overflow-x-auto">
                    <table className="w-full text-xs text-slate-600 dark:text-slate-300">
                        {/* ... table content same as before ... */}
                        <thead>
                            <tr className="border-b border-slate-200 dark:border-slate-600">
                                <th className="text-left pb-1">Item</th>
                                <th className="text-right pb-1">Rate</th>
                                <th className="text-center pb-1 border-l border-slate-200 dark:border-slate-700 px-1">Qty(1)</th>
                                <th className="text-right pb-1">Amt(1)</th>
                                <th className="text-center pb-1 border-l border-slate-200 dark:border-slate-700 px-1 font-bold">Qty({screenQty})</th>
                                <th className="text-right pb-1 font-bold">Amt({screenQty})</th>
                            </tr>
                        </thead>
                        <tbody>
                            {calculation.detailedItems.map((item, i) => (
                                <tr key={i} className={`border-b border-slate-100 dark:border-slate-700/50 ${item.isOverridden ? 'bg-yellow-50 dark:bg-yellow-900/20' : ''}`}>
                                    <td className="py-2 flex items-center gap-1">
                                        {item.name}
                                        <button onClick={() => toggleEditRow(item.id)} className={`p-1 rounded hover:bg-slate-200 dark:hover:bg-slate-700 ${item.isOverridden ? 'text-amber-500' : 'text-slate-300 hover:text-slate-500'}`}>
                                            <Edit size={12} />
                                        </button>
                                        {item.isOverridden && (
                                            <button onClick={() => clearOverride(item.id)} className="p-1 text-slate-400 hover:text-red-500" title="Reset to calculated"><RefreshCw size={12} /></button>
                                        )}
                                    </td>
                                    <td className="text-right py-2">
                                        {editingRow === item.id ? (
                                            <input
                                                type="number"
                                                className="w-16 p-1 text-right text-xs border rounded dark:bg-slate-700 dark:border-slate-500"
                                                value={overrides[item.id]?.rate !== undefined ? overrides[item.id].rate : item.unit}
                                                onChange={e => handleOverride(item.id, 'rate', e.target.value)}
                                            />
                                        ) : (
                                            formatCurrency(item.unit, 'INR', false)
                                        )}
                                    </td>
                                    <td className="text-center py-2 border-l border-slate-100 dark:border-slate-700">
                                        {editingRow === item.id ? (
                                            <input
                                                type="number"
                                                className="w-12 p-1 text-center text-xs border rounded dark:bg-slate-700 dark:border-slate-500"
                                                value={overrides[item.id]?.qty !== undefined ? overrides[item.id].qty : item.qty}
                                                onChange={e => handleOverride(item.id, 'qty', e.target.value)}
                                            />
                                        ) : (
                                            item.qty
                                        )}
                                    </td>
                                    <td className="text-right py-2">{formatCurrency(item.total, 'INR', false)}</td>
                                    <td className="text-center py-2 border-l border-slate-100 dark:border-slate-700 font-bold">
                                        {item.qty * screenQty}
                                    </td>
                                    <td className="text-right py-2 font-bold">
                                        {formatCurrency(item.total * screenQty, 'INR', false)}
                                    </td>
                                </tr>
                            ))}
                            <tr>
                                <td colSpan="2" className="text-right font-medium py-2 text-xs text-slate-400 uppercase">Add. Costs</td>
                                <td className="text-center py-2 border-l border-slate-100 dark:border-slate-700 text-slate-400">-</td>
                                <td className="text-right font-medium py-2 text-slate-400">{formatCurrency(calculation.breakdown.extras, 'INR', false)}</td>
                                <td className="text-center py-2 border-l border-slate-100 dark:border-slate-700 font-bold text-slate-400">-</td>
                                <td className="text-right font-bold py-2 text-slate-400">{formatCurrency(calculation.breakdown.extras * screenQty, 'INR', false)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                {/* Pricing Mode & Margin Inputs */}
                <div className="bg-teal-50 dark:bg-teal-900/30 p-4 rounded-lg">
                    <div className="flex justify-between items-center mb-2 gap-2">
                        <select 
                            value={state.pricingMode || 'margin'} 
                            onChange={e => {
                                const newMode = e.target.value;
                                updateState('pricingMode', newMode);
                                if (newMode !== 'margin' && calculation) {
                                    let newTarget = 0;
                                    if (newMode === 'screen') newTarget = calculation.matrix.sell.unit;
                                    else if (newMode === 'sqft') newTarget = calculation.matrix.sell.sqft;
                                    else if (newMode === 'sqm') newTarget = calculation.matrix.sell.sqft * 10.7639;
                                    updateState('targetSellPrice', Math.round(newTarget));
                                }
                            }}
                            className="bg-teal-100 text-teal-800 dark:bg-teal-800 dark:text-teal-200 text-xs font-bold p-1 rounded border-none cursor-pointer focus:ring-0"
                        >
                            <option value="margin">Margin %</option>
                            <option value="sqft">Price / Sq.Ft</option>
                            <option value="sqm">Price / Sq.Mtr</option>
                            <option value="screen">Price / Screen</option>
                        </select>
                    </div>
                    <input 
                        type="number" 
                        className="w-full p-2 text-sm border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white font-bold"
                        value={state.pricingMode === 'margin' ? margin : state.targetSellPrice}
                        onChange={e => {
                            const val = parseFloat(e.target.value) || 0;
                            const mode = state.pricingMode || 'margin';
                            if (mode === 'margin') {
                                updateState('margin', val);
                            } else {
                                updateState('targetSellPrice', val);
                            }
                        }}
                    />
                    {(state.pricingMode && state.pricingMode !== 'margin' && calculation) && (
                        <div className="text-right mt-1">
                            <span className="text-[10px] text-teal-600 dark:text-teal-400 font-bold">
                                = {(((calculation.totalProjectSell - calculation.totalProjectCost) / calculation.totalProjectCost) * 100 || 0).toFixed(2)}% Margin
                            </span>
                        </div>
                    )}
                </div>

                {/* Financial Matrix UI */}
                                    <div className="mt-4 border border-slate-200 dark:border-slate-700 rounded overflow-hidden">
                                        <table className="w-full text-xs">
                                            <thead className="bg-slate-100 dark:bg-slate-700 font-bold text-slate-600 dark:text-slate-300">
                                                <tr>
                                                    <th className="p-2 text-left">Component</th>
                                                    <th className="p-2 text-right">Cost (Unit)</th>
                                                    <th className="p-2 text-right">Margin</th>
                                                    <th className="p-2 text-right">Sell (Unit)</th>
                                                    <th className="p-2 text-right bg-teal-100 dark:bg-teal-900 text-teal-800 dark:text-teal-200">Total Project</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700 dark:text-slate-200">
                                                {/* LED Panel Row - The Core Focus */}
                                                <tr>
                                                    <td className="p-2 font-bold text-slate-700 dark:text-slate-200">LED Panel (H/W)</td>
                                                    <td className="p-2 text-right">{formatCurrency(calculation.matrix.led.cost, 'INR', false)}</td>
                                                    <td className="p-2 text-right text-green-600">
                                                        {formatCurrency(calculation.matrix.led.margin, 'INR', false)} <span className="text-[10px] text-slate-400">({calculation.matrix.led.marginPct.toFixed(1)}%)</span>
                                                    </td>
                                                    <td className="p-2 text-right font-bold">{formatCurrency(calculation.matrix.led.sell, 'INR', false)}</td>
                                                    <td className="p-2 text-right text-slate-400">{formatCurrency(calculation.matrix.led.sell * screenQty, 'INR', false)}</td>
                                                </tr>
                                                
                                                {/* Services Row */}
                                                <tr>
                                                    <td className="p-2 font-medium text-slate-500">Services (Install/Str/Proc)</td>
                                                    <td className="p-2 text-right text-slate-500">{formatCurrency(calculation.costServicesPerScreen, 'INR', false)}</td>
                                                    <td className="p-2 text-right text-slate-400">-</td>
                                                    <td className="p-2 text-right text-slate-500">{formatCurrency(calculation.commercials.sellProcTotal/screenQty + calculation.commercials.sellInstallTotal/screenQty + calculation.commercials.sellStructureTotal/screenQty, 'INR', false)}</td>
                                                    <td className="p-2 text-right text-slate-400">{formatCurrency(calculation.commercials.sellProcTotal + calculation.commercials.sellInstallTotal + calculation.commercials.sellStructureTotal, 'INR', false)}</td>
                                                </tr>

                                                {/* Grand Total Row */}
                                                <tr className="bg-slate-50 dark:bg-slate-800/50 border-t-2 border-slate-200 dark:border-slate-600">
                                                    <td className="p-2 font-bold uppercase text-teal-800 dark:text-teal-400">Grand Total</td>
                                                    <td className="p-2 text-right font-medium">{formatCurrency(calculation.matrix.cost.unit, 'INR', false)}</td>
                                                    <td className="p-2 text-right font-medium text-green-600">{formatCurrency(calculation.matrix.margin.unit, 'INR', false)}</td>
                                                    <td className="p-2 text-right font-bold">{formatCurrency(calculation.matrix.sell.unit, 'INR', false)}</td>
                                                    <td className="p-2 text-right font-bold text-teal-700 dark:text-teal-400 bg-teal-100 dark:bg-teal-900/40">{formatCurrency(calculation.matrix.sell.total, 'INR', false)}</td>
                                                </tr>
                                                
                                                {/* Stats Row */}
                                                <tr>
                                                    <td className="p-2 text-[10px] text-slate-400" colSpan="5">
                                                        Area: {calculation.matrix.sqft.total.toFixed(2)} Sq.Ft  
                                                        Avg Rate: {formatCurrency(calculation.matrix.sell.total / calculation.matrix.sqft.total, 'INR')}/Sq.Ft
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
             </div>
        )}
    </div>
</div>

                    {/* Right: Visualizer & Actions */}
                    <div className="lg:col-span-4 space-y-6">
                        {calculation ? (
                            <div className="space-y-6">
                                <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                                    <h3 className="font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Monitor className="w-4 h-4 text-teal-600 dark:text-teal-400" /> Layout</h3>
                                    <ScreenVisualizer cols={calculation.gridCols} rows={calculation.gridRows} module={calculation.moduleType} cabinet={calculation.cabinetType} unit={unit} />

                                    <div className="grid grid-cols-2 gap-2 mt-4">
                                        <div className="col-span-2 flex gap-2 mb-2">
                                            <button onClick={() => setShowStock(true)} className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 border border-slate-300 px-4 py-2 rounded flex items-center justify-center gap-2 font-bold text-sm transition-colors">
                                                <Box size={16} /> Check Stock
                                            </button>
                                            <button onClick={() => setShowBOM(true)} className="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 px-4 py-2 rounded flex items-center justify-center gap-2 font-bold text-sm transition-colors">
                                                <FileText size={16} /> View BOM
                                            </button>
                                        </div>
                                        <button onClick={() => onSaveQuote(calculation.finalPrice)} className="bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded flex items-center justify-center gap-2 shadow-sm font-semibold transition-colors">
                                            <Save size={16} /> Save Quote
                                        </button>
                                        <button onClick={() => setShowPreview(true)} className="bg-teal-600 hover:bg-teal-700 text-white px-4 py-3 rounded flex items-center justify-center gap-2 shadow-sm font-semibold transition-colors">
                                            <Eye size={16} /> Preview PDF
                                        </button>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div className="h-full flex flex-col items-center justify-center text-slate-400 dark:text-slate-500 bg-slate-100 dark:bg-slate-800 rounded-xl border-2 border-dashed border-slate-200 dark:border-slate-700 min-h-[300px]">
                                <Calculator className="w-12 h-12 mb-4 opacity-30" />
                                <p>Enter details to see preview</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('quote');
            const [inventory, setInventory] = React.useState([]);
            const [transactions, setTransactions] = React.useState([]);
            const [darkMode, setDarkMode] = React.useState(false);
            const [exchangeRate, setExchangeRate] = React.useState(84);

            // Lifted State for Sticky Behavior
            const initialCalcState = {
                client: '', project: '', screenQty: 1, targetWidth: 3, targetHeight: 2, unit: 'ft', // Changed default to ft
                selectedIndoor: 'true', assemblyMode: 'assembled', selectedPitch: '',
                selectedModuleId: '', selectedCabinetId: '', selectedCardId: '',
                selectedPSUId: '', selectedProcId: '', sizingMode: 'closest', readyId: '',
                margin: 30, targetSellPrice: 0,
                commercials: { 
                    processor: {val: 0, unit: 'screen'}, 
                    installation: {val: 0, unit: 'sqft'}, 
                    structure: {val: 0, unit: 'sqft'} 
                },
                terms: {
                    price: 'Ex-works Mumbai',
                    deliveryWeeks: 10,
                    payment: [
                        { name: "Advance with order", percent: 60 },
                        { name: "Before dispatch", percent: 30 },
                        { name: "After installation", percent: 10 }
                    ]
                },
                extraComponents: [],
                extras: {
                    assembly: { val: 0, type: 'abs' },
                    hardware: { val: 5000, type: 'abs' },
                    packaging: { val: 2000, type: 'abs' },
                    transport: { val: 5000, type: 'abs' },
                    install: { val: 10000, type: 'abs' },
                    wastage: { val: 2000, type: 'abs' },
                    overheads: { val: 5000, type: 'abs' },
                    structure: { val: 0, type: 'abs' }
                },
                overrides: {},
                editingRow: null
            };

            const [calcState, setCalcState] = React.useState(initialCalcState);

            React.useEffect(() => {
                const init = async () => {
                    if (!isConfigured) return;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                init();
                if (isConfigured) auth.onAuthStateChanged(setUser);
            }, []);

            React.useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
            }, [darkMode]);

            React.useEffect(() => {
                if (!user || !db) return;
                const unsubInv = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory')
                         .onSnapshot(snap => setInventory(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubTx = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions')
                         .onSnapshot(snap => setTransactions(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubInv(); unsubTx(); };
            }, [user]);

            const handleSaveQuote = async (finalAmount) => {
                if (!calcState.client || !calcState.project) return alert("Please enter Client and Project names.");
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes').add({
                        client: calcState.client,
                        project: calcState.project,
                        calculatorState: calcState,
                        finalAmount: finalAmount || 0,
                        updatedAt: new Date()
                    });
                    alert("Quote Saved Successfully!");
                } catch (e) { console.error(e); alert("Error saving quote."); }
            };

            const handleLoadQuote = (quote, isDuplicate) => {
                const newState = { ...quote.calculatorState };
                if (isDuplicate) {
                    newState.client = newState.client + ' (Copy)';
                    newState.project = newState.project + ' (Copy)';
                }
                setCalcState(newState);
                setView('quote');
            };

            if (!isConfigured) return <div className="p-10 text-center">Config Missing</div>;
            if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div></div>;

            return (
                <div className="min-h-screen no-print pb-20 bg-slate-50 dark:bg-slate-900 transition-colors">
                    <nav className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50 px-6 h-16 flex items-center justify-between shadow-sm transition-colors">
                        <span className="font-bold text-lg text-slate-900 dark:text-white">ADMIRE <span className="text-teal-600 dark:text-teal-400 font-light">SIGNAGE</span></span>
                        <div className="flex gap-4 items-center">
                            <div className="flex gap-2">
                                <button onClick={() => setView('quote')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors ${view === 'quote' ? 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Calculator</button>
                                <button onClick={() => setView('inventory')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors ${view === 'inventory' ? 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Components</button>
                                <button onClick={() => setView('ledger')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors ${view === 'ledger' ? 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Inventory</button>
                                <button onClick={() => setView('saved')} className={`px-4 py-2 rounded-full text-sm font-bold transition-colors ${view === 'saved' ? 'bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-slate-200'}`}>Saved Quotes</button>
                            </div>
                            <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                {darkMode ? <Sun size={20} /> : <Moon size={20} />}
                            </button>
                        </div>
                    </nav>
                    <main className="max-w-[1600px] mx-auto p-6">
                        {view === 'inventory' && <InventoryManager user={user} transactions={transactions} />}
                        {view === 'ledger' && <InventoryLedger user={user} inventory={inventory} transactions={transactions} />}
                        {view === 'saved' && <SavedQuotesManager user={user} inventory={inventory} transactions={transactions} exchangeRate={exchangeRate} onLoadQuote={handleLoadQuote} />}
                        {view === 'quote' && (
                            <QuoteCalculator 
                                user={user} 
                                inventory={inventory}
                                transactions={transactions} 
                                state={calcState} 
                                setState={setCalcState}
                                exchangeRate={exchangeRate}
                                setExchangeRate={setExchangeRate}
                                onSaveQuote={handleSaveQuote}
                            />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
