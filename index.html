<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admire Signage - LED Quoting Tool v8</title>

    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        /* Print Styles */
        @media print {
            @page {
                size: A4;
                margin: 0;
            }

            .no-print {
                display: none !important;
            }

            .print-only {
                display: block !important;
            }

            body {
                background: white;
                -webkit-print-color-adjust: exact;
            }

            #root {
                margin: 0;
                padding: 0;
            }

            .dark {
                color: black !important;
                background: white !important;
            }

            .modal-content {
                box-shadow: none !important;
                border: none !important;
            }
        }

        .print-only {
            display: none;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-900 transition-colors duration-200">
    <div id="root"></div>

    <script type="text/babel">
        // --- Icons ---
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
        );

        const Icons = {
            Calculator: (props) => <IconBase {...props}><rect width="16" height="20" x="4" y="2" rx="2" /><line x1="8" x2="16" y1="6" y2="6" /><line x1="16" x2="16" y1="14" y2="18" /><path d="M16 10h.01" /><path d="M12 10h.01" /><path d="M8 10h.01" /><path d="M12 14h.01" /><path d="M8 14h.01" /><path d="M12 18h.01" /><path d="M8 18h.01" /></IconBase>,
            Settings: (props) => <IconBase {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" /><circle cx="12" cy="12" r="3" /></IconBase>,
            Printer: (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9" /><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2" /><rect width="12" height="8" x="6" y="14" /></IconBase>,
            Plus: (props) => <IconBase {...props}><path d="M5 12h14" /><path d="M12 5v14" /></IconBase>,
            Trash2: (props) => <IconBase {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></IconBase>,
            Monitor: (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="3" rx="2" /><line x1="8" x2="16" y1="21" y2="21" /><line x1="12" x2="12" y1="17" y2="21" /></IconBase>,
            DollarSign: (props) => <IconBase {...props}><line x1="12" x2="12" y1="2" y2="22" /><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" /></IconBase>,
            Box: (props) => <IconBase {...props}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" x2="12" y1="22.08" y2="12" /></IconBase>,
            Wrench: (props) => <IconBase {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z" /></IconBase>,
            Percent: (props) => <IconBase {...props}><line x1="19" x2="5" y1="5" y2="19" /><circle cx="6.5" cy="6.5" r="2.5" /><circle cx="17.5" cy="17.5" r="2.5" /></IconBase>,
            Edit: (props) => <IconBase {...props}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" /></IconBase>,
            Sun: (props) => <IconBase {...props}><circle cx="12" cy="12" r="4" /><path d="M12 2v2" /><path d="M12 20v2" /><path d="m4.93 4.93 1.41 1.41" /><path d="m17.66 17.66 1.41 1.41" /><path d="M2 12h2" /><path d="M20 12h2" /><path d="m6.34 17.66-1.41 1.41" /><path d="m19.07 4.93-1.41 1.41" /></IconBase>,
            Moon: (props) => <IconBase {...props}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" /></IconBase>,
            X: (props) => <IconBase {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></IconBase>,
            Eye: (props) => <IconBase {...props}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" /><circle cx="12" cy="12" r="3" /></IconBase>,
            Copy: (props) => <IconBase {...props}><rect width="14" height="14" x="8" y="8" rx="2" ry="2" /><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" /></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8" /><path d="M21 3v5h-5" /><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16" /><path d="M8 16H3v5" /></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" /><polyline points="17 21 17 13 7 13 7 21" /><polyline points="7 3 7 8 15 8" /></IconBase>,
            FileText: (props) => <IconBase {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" /><polyline points="14 2 14 8 20 8" /><line x1="16" x2="8" y1="13" y2="13" /><line x1="16" x2="8" y1="17" y2="17" /><polyline points="10 9 9 9 8 9" /></IconBase>,
            Download: (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" /><polyline points="7 10 12 15 17 10" /><line x1="12" x2="12" y1="15" y2="3" /></IconBase>
        };

        const { Calculator, Settings, Printer, Plus, Trash2, Monitor, DollarSign, Box, Wrench, Percent, Edit, Sun, Moon, X, Eye, Copy, RefreshCw, Save, FileText, Download } = Icons;

        // --- Firebase Config Logic ---
        const externalConfig = {
              apiKey: "AIzaSyAvueWxge1MyGoj9JRPFP5cGF8EVb240XE",
  authDomain: "led-single.firebaseapp.com",
  projectId: "led-single",
  storageBucket: "led-single.firebasestorage.app",
  messagingSenderId: "820851571866",
  appId: "1:820851571866:web:516f653701a684d78e7323",
  measurementId: "G-9LDX0M4YH8"
        };

        let firebaseConfig;
        let appId = 'admire-signage-external';

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            appId = typeof __app_id !== 'undefined' ? __app_id : appId;
        } else {
            firebaseConfig = externalConfig;
        }

        let app, auth, db, isConfigured = true;

        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("REPLACE_WITH")) {
            isConfigured = false;
        } else {
            try {
                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
                db = firebase.firestore();
            } catch (e) {
                console.error("Firebase Init Failed:", e);
                isConfigured = false;
            }
        }

        // --- Utils ---
        const formatCurrency = (amount, currency = 'INR', compact = false) => {
            return new Intl.NumberFormat(currency === 'INR' ? 'en-IN' : 'en-US', {
                style: 'currency',
                currency: currency,
                maximumFractionDigits: 0,
                notation: compact ? "compact" : "standard"
            }).format(amount);
        };

        const generateId = () => Math.random().toString(36).substr(2, 9).toUpperCase();

        // --- Components ---

        // 1. Inventory Manager
        const InventoryManager = ({ user, transactions = [] }) => {
            const [items, setItems] = React.useState([]);
            const [editingId, setEditingId] = React.useState(null);
            const [newItem, setNewItem] = React.useState({ 
                type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                brightness: '', refreshRate: '', 
                ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
            });
            const [loading, setLoading] = React.useState(true);

            React.useEffect(() => {
                if (!user || !db) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory')
                    .onSnapshot(snap => {
                        const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                        setItems(data);
                        setLoading(false);
                    }, err => console.error(err));
                return () => unsub();
            }, [user]);

            const handleSaveItem = async () => {
                if (newItem.type === 'module') {
                    if (!newItem.pitch || !newItem.brand || !newItem.model || !newItem.price || !newItem.width || !newItem.height || !newItem.weight || !newItem.avgPower || !newItem.maxPower || !newItem.brightness || !newItem.refreshRate || !newItem.contrast || !newItem.viewAngleH || !newItem.viewAngleV || !newItem.ipFront || !newItem.ipBack) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'cabinet') {
                    if (!newItem.material || !newItem.model || !newItem.price || !newItem.vendor || !newItem.width || !newItem.height) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'card' || newItem.type === 'processor') {
                     if (!newItem.brand || !newItem.model || !newItem.price || !newItem.vendor) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (newItem.type === 'psu') {
                     if (!newItem.brand || !newItem.model || !newItem.price || !newItem.vendor || !newItem.amps) {
                        return alert("Please fill all compulsory (*) fields.");
                    }
                } else if (!newItem.brand || !newItem.model) {
                    return alert("Brand and Model are required");
                }
                
                try {
                    const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory');
                    
                    const itemData = {
                        ...newItem,
                        width: Number(newItem.width),
                        height: Number(newItem.height),
                        price: Number(newItem.price),
                        carriage: Number(newItem.carriage || 0),
                        pitch: Number(newItem.pitch),
                        currency: newItem.currency || 'INR', 
                        indoor: newItem.indoor === 'true' || newItem.indoor === true,
                        material: newItem.material || '',
                        weight: newItem.weight ? Number(newItem.weight) : 0,
                        avgPower: newItem.avgPower ? Number(newItem.avgPower) : 0,
                        maxPower: newItem.maxPower ? Number(newItem.maxPower) : 0,
                        brightness: newItem.brightness ? parseInt(newItem.brightness) : 0,
                        refreshRate: newItem.refreshRate ? parseInt(newItem.refreshRate) : 0,
                        viewAngleH: newItem.viewAngleH ? parseInt(newItem.viewAngleH) : 0,
                        viewAngleV: newItem.viewAngleV ? parseInt(newItem.viewAngleV) : 0,
                        ipFront: newItem.ipFront ? parseInt(newItem.ipFront) : 0,
                        ipBack: newItem.ipBack ? parseInt(newItem.ipBack) : 0,
                        ports: newItem.ports ? parseInt(newItem.ports) : 0,
                        amps: newItem.amps ? Number(newItem.amps) : 0,
                        updatedAt: new Date()
                    };

                    if (editingId) {
                        await collectionRef.doc(editingId).update(itemData);
                        setEditingId(null);
                    } else {
                        await collectionRef.add({ ...itemData, createdAt: new Date() });
                    }
                    setNewItem({ 
                        type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                        width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                        brightness: '', refreshRate: '', 
                        ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                        contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
                    });
                } catch (e) { console.error(e); }
            };

            const handleEdit = (item) => {
                setNewItem({ ...item, vendor: item.vendor || '', currency: item.currency || 'INR', carriage: item.carriage || 0 });
                setEditingId(item.id);
                window.scrollTo({ top: 0, behavior: 'smooth' });
            };

                const handleCancelEdit = () => {
                setEditingId(null);
                setNewItem({ 
                    type: 'module', brand: '', model: '', vendor: '', pitch: '', 
                    width: '', height: '', price: '', carriage: '', currency: 'INR', indoor: true,
                    brightness: '', refreshRate: '', 
                    ledType: '', lampMake: '', material: '', weight: '', avgPower: '', maxPower: '', 
                    contrast: '', viewAngleH: '', viewAngleV: '', ipFront: '', ipBack: '', ports: '', amps: ''
                });
            };

            const handleDelete = async (id) => {
                if (confirm("Delete this item?")) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory').doc(id).delete();
                }
            };

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <Box className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Components Management
                        </h2>
                    </div>

                    {/* Add/Edit Item Form */}
                    <div className={`grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 rounded-lg transition-colors ${editingId ? 'bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-700' : 'bg-slate-50 dark:bg-slate-700/50'}`}>
                        <div className="col-span-2 md:col-span-4 flex justify-between items-center mb-2">
                            <h3 className="text-sm font-bold uppercase text-slate-500 dark:text-slate-400">{editingId ? 'Editing Item' : 'Add New Item'}</h3>
                            {editingId && <button onClick={handleCancelEdit} className="text-xs text-slate-500 dark:text-slate-400 hover:underline">Cancel Edit</button>}
                        </div>

                        {/* 1. Type */}
                        <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.type} onChange={e => setNewItem({...newItem, type: e.target.value})}>
                            <option value="module">Module</option>
                            <option value="cabinet">Cabinet</option>
                            <option value="ready">Ready Unit</option>
                            <option value="card">Receiving Card</option>
                            <option value="psu">SMPS</option>
                            <option value="processor">Processor</option>
                        </select>

                        {/* 2. Module Specific Inputs */}
                        {newItem.type === 'module' && (
                            <>
                                 <input placeholder="Pitch*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white border-teal-500 ring-1 ring-teal-500" value={newItem.pitch} onChange={e => setNewItem({...newItem, pitch: e.target.value})} />
                                 <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white border-teal-500 ring-1 ring-teal-500" value={newItem.indoor} onChange={e => setNewItem({...newItem, indoor: e.target.value})}>
                                    <option value="true">Indoor</option>
                                    <option value="false">Outdoor</option>
                                 </select>
                            </>
                        )}

                        <input placeholder={(newItem.type === 'module' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Brand*" : "Brand"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.brand} onChange={e => setNewItem({...newItem, brand: e.target.value})} />
                        <input placeholder={(newItem.type === 'module' || newItem.type === 'cabinet' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Model/SKU*" : "Model"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.model} onChange={e => setNewItem({...newItem, model: e.target.value})} />
                        
                        {/* Price & Carriage Inputs */}
                        <div className="flex gap-2 items-center col-span-2 md:col-span-1">
                             <div className="flex-1 min-w-[100px]" title="Base Price">
                                 <input placeholder="Base Rate*" type="number" className="p-2 w-full border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.price} onChange={e => setNewItem({...newItem, price: e.target.value})} />
                                 <div className="text-[9px] text-slate-400 mt-0.5 ml-1">BASE RATE*</div>
                             </div>
                             <span className="text-slate-400 font-bold mb-3">+</span>
                             <div className="flex-1 min-w-[80px]" title="Carriage Inwards">
                                 <input placeholder="Carriage" type="number" className="p-2 w-full border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.carriage} onChange={e => setNewItem({...newItem, carriage: e.target.value})} />
                                 <div className="text-[9px] text-slate-400 mt-0.5 ml-1">CARRIAGE</div>
                             </div>
                             <div className="flex-none mb-3">
                                 <select className="p-2 border rounded bg-slate-100 dark:bg-slate-600 dark:border-slate-600 dark:text-white" value={newItem.currency} onChange={e => setNewItem({...newItem, currency: e.target.value})}>
                                    <option value="INR">INR</option>
                                    <option value="USD">USD</option>
                                </select>
                             </div>
                        </div>

                        <input placeholder={(newItem.type === 'cabinet' || newItem.type === 'card' || newItem.type === 'processor' || newItem.type === 'psu') ? "Vendor*" : "Vendor"} className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.vendor} onChange={e => setNewItem({...newItem, vendor: e.target.value})} />
                        
                        {(newItem.type === 'card' || newItem.type === 'processor') && (
                             <input placeholder="Ports (Optional)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ports} onChange={e => setNewItem({...newItem, ports: e.target.value})} />
                        )}

                        {newItem.type === 'psu' && (
                             <input placeholder="Capacity (Amps)*" type="number" step="0.1" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.amps} onChange={e => setNewItem({...newItem, amps: e.target.value})} />
                        )}

                        {newItem.type === 'module' && (
                            <>
                                <input placeholder="LED Type" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ledType} onChange={e => setNewItem({...newItem, ledType: e.target.value})} />
                                <input placeholder="Lamp Make" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.lampMake} onChange={e => setNewItem({...newItem, lampMake: e.target.value})} />
                                <input placeholder="Width (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                                <input placeholder="Weight/sqm (kg)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} />
                                <input placeholder="Avg Power/sqm (W)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.avgPower} onChange={e => setNewItem({...newItem, avgPower: e.target.value})} />
                                <input placeholder="Max Power/sqm (W)*" type="number" step="0.01" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.maxPower} onChange={e => setNewItem({...newItem, maxPower: e.target.value})} />
                                <input placeholder="Brightness (nits)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.brightness} onChange={e => setNewItem({...newItem, brightness: e.target.value})} />
                                <input placeholder="Refresh Rate*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.refreshRate} onChange={e => setNewItem({...newItem, refreshRate: e.target.value})} />
                                <input placeholder="Contrast* (e.g. 5000:1)" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.contrast} onChange={e => setNewItem({...newItem, contrast: e.target.value})} />
                                <input placeholder="Viewing Angle (H)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.viewAngleH} onChange={e => setNewItem({...newItem, viewAngleH: e.target.value})} />
                                <input placeholder="Viewing Angle (V)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.viewAngleV} onChange={e => setNewItem({...newItem, viewAngleV: e.target.value})} />
                                <input placeholder="IP Protection (Front)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ipFront} onChange={e => setNewItem({...newItem, ipFront: e.target.value})} />
                                <input placeholder="IP Protection (Back)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.ipBack} onChange={e => setNewItem({...newItem, ipBack: e.target.value})} />
                            </>
                        )}

                        {newItem.type === 'cabinet' && (
                            <>
                                <input placeholder="Material*" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.material} onChange={e => setNewItem({...newItem, material: e.target.value})} />
                                <select className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.indoor} onChange={e => setNewItem({...newItem, indoor: e.target.value})}>
                                    <option value="true">Indoor</option>
                                    <option value="false">Outdoor</option>
                                </select>
                                <input placeholder="Width (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)*" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                                <input placeholder="Weight (kg)" type="number" step="1" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.weight} onChange={e => setNewItem({...newItem, weight: e.target.value})} />
                            </>
                        )}

                        {newItem.type === 'ready' && (
                            <>
                                <input placeholder="Width (mm)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.width} onChange={e => setNewItem({...newItem, width: e.target.value})} />
                                <input placeholder="Height (mm)" type="number" className="p-2 border rounded dark:bg-slate-700 dark:border-slate-600 dark:text-white" value={newItem.height} onChange={e => setNewItem({...newItem, height: e.target.value})} />
                            </>
                        )}
                        <button
                            onClick={handleSaveItem}
                            className={`px-4 py-2 rounded text-white flex items-center justify-center gap-2 hover:opacity-90 transition ${editingId ? 'bg-amber-600' : 'bg-teal-600'} col-span-2 md:col-span-1`}
                        >
                            {editingId ? <Edit size={16} /> : <Plus size={16} />}
                            {editingId ? 'Update Item' : 'Add Item'}
                        </button>
                    </div>

                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left border border-slate-200 dark:border-slate-700 rounded">
                            <thead className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 uppercase">
                                <tr>
                                    <th className="px-4 py-3">Type</th>
                                    <th className="px-4 py-3">Component</th>
                                    <th className="px-4 py-3">Specs</th>
                                    <th className="px-4 py-3">Stock</th>
                                    <th className="px-4 py-3">Landed Cost</th>
                                    <th className="px-4 py-3">Action</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                {items.map(item => (
                                    <tr key={item.id} className={`hover:bg-slate-50 dark:hover:bg-slate-700/50 ${editingId === item.id ? 'bg-amber-50 dark:bg-amber-900/20' : ''}`}>
                                        <td className="px-4 py-3 capitalize"><span className={`px-2 py-1 rounded-full text-xs ${item.type === 'module' ? 'bg-blue-100 dark:bg-blue-900 text-blue-700 dark:text-blue-300' : item.type === 'ready' ? 'bg-purple-100 dark:bg-purple-900 text-purple-700 dark:text-purple-300' : 'bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300'}`}>{item.type === 'psu' ? 'SMPS' : item.type}</span></td>
                                        <td className="px-4 py-3 dark:text-slate-200">
                                            <div className="font-medium">{item.brand} {item.model}</div>
                                            {item.vendor && <div className="text-[10px] text-teal-600 dark:text-teal-400 mt-0.5">{item.vendor}</div>}
                                        </td>
                                        <td className="px-4 py-3 text-slate-500 dark:text-slate-400 text-xs">
                                            {item.type === 'module' && (
                                                <div className="flex flex-col">
                                                    <span>P{item.pitch} {item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                    <span>{item.width}x{item.height}mm</span>
                                                </div>
                                            )}
                                            {item.type === 'cabinet' && (
                                                <div className="flex flex-col">
                                                    <span>{item.material}</span>
                                                    <span>{item.width}x{item.height}mm</span>
                                                    <span>{item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                </div>
                                            )}
                                            {(item.type === 'card' || item.type === 'processor') && (
                                                <span>{item.ports ? `${item.ports} Ports` : ''}</span>
                                            )}
                                            {item.type === 'psu' && (
                                                <span>{item.amps ? `${item.amps} Amps` : ''}</span>
                                            )}
                                            {item.type === 'ready' && (
                                                <span>{item.width}x{item.height}mm P{item.pitch}</span>
                                            )}
                                        </td>
                                        <td className="px-4 py-3 font-bold dark:text-slate-200 text-teal-600">
                                            {transactions.filter(t => t.itemId === item.id).reduce((acc, t) => acc + (t.type === 'in' ? Number(t.qty) : -Number(t.qty)), 0)}
                                        </td>
                                        <td className="px-4 py-3 dark:text-slate-200">
                                            <div className="flex flex-col">
                                                <span className="font-semibold">{formatCurrency((item.price || 0) + (item.carriage || 0), item.currency || 'INR')}</span>
                                                {(item.carriage > 0) && <span className="text-[10px] text-slate-400">Base: {item.price} + Carr: {item.carriage}</span>}
                                            </div>
                                        </td>
                                        <td className="px-4 py-3 flex gap-2">
                                            <button onClick={() => handleEdit(item)} className="text-blue-500 hover:text-blue-700 p-1 bg-blue-50 dark:bg-blue-900/30 rounded"><Edit size={14} /></button>
                                            <button onClick={() => handleDelete(item.id)} className="text-red-400 hover:text-red-600 p-1 bg-red-50 dark:bg-red-900/30 rounded"><Trash2 size={14} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                        {items.length === 0 && !loading && <div className="text-center py-12 text-slate-400 bg-white dark:bg-slate-800">No items found.</div>}
                    </div>
                </div>
            );
        };

        // 2. Updated Technical Drawing Visualizer (Responsive & Clean)
        const ScreenVisualizer = ({ cols, rows, module, cabinet, unit }) => {
            if (!module || !cabinet) return null;
            
            // Dimensions
            const cabinetW = cabinet.width;
            const cabinetH = cabinet.height;
            const screenW = cabinetW * cols;
            const screenH = cabinetH * rows;
            
            const formatDims = (mm) => {
                const m = (mm / 1000).toFixed(2) + 'm';
                const ft = (mm / 304.8).toFixed(2) + 'ft';
                return `${m} / ${ft}`;
            };

            return (
                <div className="w-full flex flex-col bg-white rounded-lg border border-slate-200 overflow-hidden">
                    <div className="w-full h-full min-h-[300px] p-10 flex items-center justify-center">
                        <div className="relative" style={{ aspectRatio: `${screenW}/${screenH}`, width: '100%', maxHeight: '400px' }}>
                             {/* Top Dimension */}
                             <div className="absolute -top-8 left-0 right-0 text-center text-xs font-bold text-slate-600 flex items-center justify-center gap-2">
                                <div className="h-[1px] flex-1 bg-slate-300"></div>
                                <span className="bg-white px-1 whitespace-nowrap">{formatDims(screenW)} ({cols} Cabinets)</span>
                                <div className="h-[1px] flex-1 bg-slate-300"></div>
                             </div>

                             {/* Left Dimension */}
                             <div className="absolute -left-8 top-0 bottom-0 text-center text-xs font-bold text-slate-600 flex flex-col items-center justify-center gap-2" style={{ writingMode: 'vertical-rl', transform: 'rotate(180deg)' }}>
                                <div className="w-[1px] flex-1 bg-slate-300"></div>
                                <span className="bg-white px-1 whitespace-nowrap">{formatDims(screenH)} ({rows} Cabinets)</span>
                                <div className="w-[1px] flex-1 bg-slate-300"></div>
                             </div>

                             {/* The Grid Itself */}
                             <div 
                                className="w-full h-full grid bg-white border-2 border-slate-900 shadow-sm"
                                style={{
                                    gridTemplateColumns: `repeat(${cols}, 1fr)`,
                                    gridTemplateRows: `repeat(${rows}, 1fr)`
                                }}
                            >
                                {Array.from({ length: cols * rows }).map((_, i) => (
                                    <div key={i} className="border border-slate-300 relative"></div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 3.5 Inventory Ledger
        const InventoryLedger = ({ user, inventory, transactions }) => {
            const [newTx, setNewTx] = React.useState({
                date: new Date().toISOString().split('T')[0],
                type: 'in', itemId: '', qty: '', source: '', location: '', notes: ''
            });

            const handleAddTx = async () => {
                if (!newTx.itemId || !newTx.qty) return alert("Item and Quantity are required");
                try {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions').add({
                        ...newTx,
                        qty: Number(newTx.qty),
                        createdAt: new Date()
                    });
                    setNewTx({ ...newTx, qty: '', source: '', notes: '' });
                } catch (e) { console.error(e); }
            };

            const getStock = (id) => transactions.filter(t => t.itemId === id).reduce((acc, t) => acc + (t.type === 'in' ? t.qty : -t.qty), 0);

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                     <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <Box className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Stock Ledger
                        </h2>
                    </div>
                    <div className="grid grid-cols-2 md:grid-cols-7 gap-2 mb-6 p-4 bg-slate-50 dark:bg-slate-700/50 rounded-lg items-end">
                        <div className="col-span-1">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Date</label>
                            <input type="date" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.date} onChange={e => setNewTx({...newTx, date: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                            <label className="text-[10px] uppercase font-bold text-slate-500">Action</label>
                            <select className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.type} onChange={e => setNewTx({...newTx, type: e.target.value})}>
                                <option value="in">Stock IN</option>
                                <option value="out">Stock OUT</option>
                            </select>
                        </div>
                        <div className="col-span-2">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Component</label>
                             <select className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.itemId} onChange={e => setNewTx({...newTx, itemId: e.target.value})}>
                                <option value="">Select Item...</option>
                                {['module', 'cabinet', 'ready', 'card', 'processor', 'psu'].map(type => {
                                    const items = inventory.filter(i => i.type === type).sort((a,b) => (a.brand + ' ' + a.model).localeCompare(b.brand + ' ' + b.model));
                                    if (items.length === 0) return null;
                                    return (
                                        <optgroup key={type} label={type === 'psu' ? 'SMPS' : type.toUpperCase()}>
                                            {items.map(i => (
                                                <option key={i.id} value={i.id}>
                                                    {i.brand} {i.model} (Stock: {getStock(i.id)})
                                                </option>
                                            ))}
                                        </optgroup>
                                    );
                                })}
                             </select>
                        </div>
                        <div className="col-span-1">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Qty</label>
                             <input type="number" placeholder="Qty" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.qty} onChange={e => setNewTx({...newTx, qty: e.target.value})} />
                        </div>
                        <div className="col-span-1">
                             <label className="text-[10px] uppercase font-bold text-slate-500">Loc/Source</label>
                             <input placeholder="Source/Loc" className="w-full p-2 border rounded text-sm dark:bg-slate-800 dark:border-slate-600 dark:text-white" value={newTx.source} onChange={e => setNewTx({...newTx, source: e.target.value})} />
                        </div>
                         <button onClick={handleAddTx} className="bg-teal-600 text-white p-2 rounded hover:bg-teal-700 font-bold text-sm h-[38px]">Add</button>
                    </div>
                    <div className="overflow-x-auto">
                        <table className="w-full text-sm text-left border border-slate-200 dark:border-slate-700 rounded">
                            <thead className="bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 uppercase">
                                <tr>
                                    <th className="px-4 py-2">Date</th>
                                    <th className="px-4 py-2">Type</th>
                                    <th className="px-4 py-2">Component</th>
                                    <th className="px-4 py-2">Specs</th>
                                    <th className="px-4 py-2">Qty</th>
                                    <th className="px-4 py-2">Source / Loc</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                                {transactions.sort((a,b) => new Date(b.date) - new Date(a.date)).map(tx => {
                                    const item = inventory.find(i => i.id === tx.itemId) || {};
                                    return (
                                        <tr key={tx.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                            <td className="px-4 py-2 text-slate-500">{tx.date}</td>
                                            <td className="px-4 py-2"><span className={`px-2 py-0.5 rounded text-xs font-bold ${tx.type === 'in' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>{tx.type.toUpperCase()}</span></td>
                                            <td className="px-4 py-2 dark:text-slate-200">
                                                <div className="font-medium">{item.brand} {item.model}</div>
                                                {item.vendor && <div className="text-[10px] text-teal-600 dark:text-teal-400 mt-0.5">{item.vendor}</div>}
                                            </td>
                                            <td className="px-4 py-2 text-slate-500 dark:text-slate-400 text-xs">
                                                {item.type === 'module' && (
                                                    <div className="flex flex-col">
                                                        <span>P{item.pitch} {item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                        <span>{item.width}x{item.height}mm</span>
                                                    </div>
                                                )}
                                                {item.type === 'cabinet' && (
                                                    <div className="flex flex-col">
                                                        <span>{item.material}</span>
                                                        <span>{item.width}x{item.height}mm</span>
                                                        <span>{item.indoor ? 'Indoor' : 'Outdoor'}</span>
                                                    </div>
                                                )}
                                                {(item.type === 'card' || item.type === 'processor') && (
                                                    <span>{item.ports ? `${item.ports} Ports` : ''}</span>
                                                )}
                                                {item.type === 'psu' && (
                                                    <span>{item.amps ? `${item.amps} Amps` : ''}</span>
                                                )}
                                                {item.type === 'ready' && (
                                                    <span>{item.width}x{item.height}mm P{item.pitch}</span>
                                                )}
                                            </td>
                                            <td className="px-4 py-2 font-bold dark:text-slate-200">{tx.qty}</td>
                                            <td className="px-4 py-2 text-slate-500">{tx.source} {tx.location ? `(${tx.location})` : ''}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };

        // 3. Saved Quotes Manager
        const SavedQuotesManager = ({ user, inventory, transactions, exchangeRate, onLoadQuote, onDeleteQuote }) => {
            const [quotes, setQuotes] = React.useState([]);
            const [viewQuote, setViewQuote] = React.useState(null);

            React.useEffect(() => {
                if (!user) return;
                const unsub = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes')
                    .orderBy('updatedAt', 'desc')
                    .onSnapshot(snap => {
                        setQuotes(snap.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                    });
                return () => unsub();
            }, [user]);

            const handleDelete = async (id) => {
                if(confirm("Are you sure you want to delete this quote?")) {
                    await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes').doc(id).delete();
                }
            };

            const handleView = (quote) => {
                const result = calculateBOM(quote.calculatorState, inventory, transactions, exchangeRate);
                if (result) {
                    setViewQuote({ data: result, client: quote.client, project: quote.project });
                } else {
                    alert("Could not calculate quote. Inventory items might be missing.");
                }
            };

            const handleDownloadExcel = (quote) => {
                const result = calculateBOM(quote.calculatorState, inventory, transactions, exchangeRate);
                if (!result) return alert("Calculation failed.");
                
                let csv = `Project,${quote.project}\nClient,${quote.client}\nDate,${new Date().toLocaleDateString()}\n\n`;
                csv += `Bill of Materials\nComponent,Specification,Qty,Rate,Total\n`;
                
                result.detailedItems.forEach(item => {
                    csv += `"${item.name}","${item.spec}",${item.qty * result.screenQty},${item.unit},${item.total * result.screenQty}\n`;
                });
                
                csv += `\nFinancials\n`;
                csv += `Total Cost,${result.totalProjectCost}\n`;
                csv += `Selling Price,${result.totalProjectSell}\n`;
                csv += `Margin,${result.matrix.margin.total}\n`;

                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${quote.project}_Quote.csv`;
                a.click();
            };

            return (
                <div className="p-6 bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                    {viewQuote && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-4xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Eye size={20}/> View Saved Quote</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setViewQuote(null)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                        <button onClick={() => window.print()} className="px-4 py-2 bg-teal-600 text-white hover:bg-teal-700 rounded flex items-center gap-2"><Printer size={16}/> Print / PDF</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-8 bg-slate-200">
                                    <PrintLayout data={{...viewQuote.data, clientName: viewQuote.client, projectName: viewQuote.project}} currency='INR' exchangeRate={exchangeRate} />
                                </div>
                            </div>
                        </div>
                    )}
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800 dark:text-white">
                            <FileText className="w-5 h-5 text-teal-600 dark:text-teal-400" /> Saved Quotes
                        </h2>
                    </div>

                    <div className="grid gap-4">
                        {quotes.map(quote => {
                            const state = quote.calculatorState || {};
                            const unit = state.unit || 'm';
                            const width = state.finalWidth || state.targetWidth; // Fallback
                            const height = state.finalHeight || state.targetHeight;
                            const pitch = state.selectedPitch || 'N/A';
                            const isIndoor = state.selectedIndoor === 'true';

                            return (
                                <div key={quote.id} className="p-4 border rounded-lg bg-slate-50 dark:bg-slate-700/50 dark:border-slate-600 flex justify-between items-center">
                                    <div className="flex-1">
                                        <div className="flex items-center gap-2 mb-1">
                                            <h3 className="font-bold text-slate-800 dark:text-white">{quote.project || 'Untitled Project'}</h3>
                                            <span className={`text-[10px] uppercase font-bold px-2 py-0.5 rounded border ${isIndoor ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-green-50 text-green-600 border-green-200'}`}>
                                                {isIndoor ? 'Indoor' : 'Outdoor'}
                                            </span>
                                            <span className="text-[10px] font-bold px-2 py-0.5 rounded bg-slate-200 text-slate-600">P{pitch}</span>
                                        </div>
                                        <p className="text-sm text-slate-500 mb-2">{quote.client || 'No Client'}  {new Date(quote.updatedAt?.seconds * 1000).toLocaleDateString()}</p>

                                        <div className="flex gap-2 flex-wrap text-xs text-slate-600 dark:text-slate-400">
                                            <span className="bg-white dark:bg-slate-800 border dark:border-slate-600 px-2 py-1 rounded">Size: {state.targetWidth} x {state.targetHeight} {unit}</span>
                                            <span className="bg-white dark:bg-slate-800 border dark:border-slate-600 px-2 py-1 rounded">Qty: {state.screenQty || 1}</span>
                                            <span className="bg-teal-50 dark:bg-teal-900/30 text-teal-700 dark:text-teal-300 border border-teal-100 dark:border-teal-800 px-2 py-1 rounded font-bold">{formatCurrency(quote.finalAmount, 'INR')}</span>
                                        </div>
                                    </div>
                                    <div className="flex gap-2 ml-4">
                                        <button onClick={() => handleView(quote)} className="px-3 py-2 bg-teal-600 text-white rounded text-sm hover:bg-teal-700 flex items-center gap-1"><Eye size={14}/> View</button>
                                        <button onClick={() => handleDownloadExcel(quote)} className="px-3 py-2 bg-green-600 text-white rounded text-sm hover:bg-green-700 flex items-center gap-1"><Download size={14}/> Excel</button>
                                        <button onClick={() => onLoadQuote(quote, false)} className="px-3 py-2 bg-blue-600 text-white rounded text-sm hover:bg-blue-700 flex items-center gap-1"><Edit size={14}/> Edit</button>
                                        <button onClick={() => onLoadQuote(quote, true)} className="px-3 py-2 bg-slate-600 text-white rounded text-sm hover:bg-slate-700 flex items-center gap-1"><Copy size={14}/> Clone</button>
                                        <button onClick={() => handleDelete(quote.id)} className="p-2 text-red-500 hover:bg-red-50 rounded"><Trash2 size={16}/></button>
                                    </div>
                                </div>
                            );
                        })}
                        {quotes.length === 0 && <p className="text-center text-slate-400 py-10">No saved quotes found.</p>}
                    </div>
                </div>
            );
        };

        // 4. Print Layout
        const PrintLayout = ({ data, currency, exchangeRate, date }) => {
            if (!data || !data.moduleType) return null;
            
            const { 
                clientName, projectName, finalWidth, finalHeight, totalCabinets, 
                moduleType, cabinetType, processor, screenQty, totalProjectSell, 
                gridCols, gridRows
            } = data;

            // 1. Technical Calculations
            const screenWidthM = Number(finalWidth);
            const screenHeightM = Number(finalHeight);
            const areaSqm = screenWidthM * screenHeightM;
            const areaSqft = areaSqm * 10.7639;

            // Resolution
            const resW = Math.round((screenWidthM * 1000) / moduleType.pitch);
            const resH = Math.round((screenHeightM * 1000) / moduleType.pitch);

            // Weight: (Module Kg/m2 * Area) + (Cabinet Kg * Qty)
            const totalModWeight = (moduleType.weight || 0) * areaSqm;
            const totalCabWeight = (cabinetType.weight || 0) * totalCabinets;
            const totalWeight = totalModWeight + totalCabWeight;

            // Power
            const avgPower = (moduleType.avgPower || 0) * areaSqm; 
            const maxPower = (moduleType.maxPower || 0) * areaSqm; 

            // 2. Commercial Calculations
            // Get Total Sell Values from calculator state
            const comms = data.commercials || { sellProcTotal: 0, sellInstallTotal: 0, sellStructureTotal: 0 };
            
            // Per Screen Values
            const sellTotalPerScreen = totalProjectSell / screenQty;
            const sellProc = comms.sellProcTotal / screenQty;
            const sellInstall = comms.sellInstallTotal / screenQty;
            const sellStructure = comms.sellStructureTotal / screenQty;
            
            // LED Panel Base = Total - (Processor + Install + Structure)
            const sellLEDBase = sellTotalPerScreen - sellProc - sellInstall - sellStructure;

            // Spares = 2% of the LED Base
            const sellSpares = sellLEDBase * 0.02;
            
            // Final LED Panel = LED Base - Spares
            const sellLEDFinal = sellLEDBase - sellSpares;

            const commercialRows = [
                { name: "LED Panel", rate: sellLEDFinal },
                { name: "Processor", rate: sellProc },
                { name: "Installation", rate: sellInstall },
                { name: "Spares (2%)", rate: sellSpares },
                { name: "Structure", rate: sellStructure },
            ].filter(r => r.rate > 0);

            return (
                <div className="p-8 max-w-[210mm] mx-auto bg-white min-h-screen text-slate-800 print:p-0 print:w-full font-sans text-xs">
                    {/* Header */}
                    <div className="flex justify-between items-start mb-6 border-b-2 border-slate-800 pb-4">
                        <div>
                            {/* Logo Placeholder - Text for now */}
                            <h1 className="text-2xl font-bold text-slate-900 uppercase tracking-wide">ADMIRE SIGN & DISPLAY PVT. LTD.</h1>
                            <div className="text-[10px] text-slate-600 mt-1 space-y-0.5">
                                <p>102, Priya Industrial Estate 4, K.T. Industrial Estate</p>
                                <p>Kherpada, Waliv, Vasai East, Mumbai - 401208</p>
                                <p>Email: info@admiresignage.com | Web: www.admiresignage.com</p>
                            </div>
                        </div>
                        <div className="text-right">
                            <h2 className="text-xl font-light text-slate-500">QUOTATION</h2>
                            <p className="text-sm font-bold text-slate-700">Date: {date || new Date().toLocaleDateString()}</p>
                        </div>
                    </div>

                    {/* Project & Screen Details */}
                    <div className="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2">Project Details</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Client:</span> <span className="col-span-2 font-bold">{clientName}</span>
                                <span className="font-semibold text-slate-500">Project:</span> <span className="col-span-2 font-bold">{projectName}</span>
                                <span className="font-semibold text-slate-500">Screen Size:</span> <span className="col-span-2">{screenWidthM}m (W) x {screenHeightM}m (H)</span>
                                <span className="font-semibold text-slate-500">Quantity:</span> <span className="col-span-2">{screenQty} Nos</span>
                            </div>

                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mt-4 mb-2">Module & Cabinet</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Module:</span> <span className="col-span-2">{moduleType.brand} P{moduleType.pitch}</span>
                                <span className="font-semibold text-slate-500">Mod Size:</span> <span className="col-span-2">{moduleType.width} x {moduleType.height} mm</span>
                                <span className="font-semibold text-slate-500">Lamp:</span> <span className="col-span-2">{moduleType.lampMake || '-'}</span>
                                <span className="font-semibold text-slate-500">Cabinet:</span> <span className="col-span-2">{cabinetType.material || 'Standard'}</span>
                                <span className="font-semibold text-slate-500">Cab Size:</span> <span className="col-span-2">{cabinetType.width} x {cabinetType.height} mm</span>
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2">Screen Specifications</h3>
                            <div className="grid grid-cols-3 gap-y-1 text-[11px]">
                                <span className="font-semibold text-slate-500">Resolution:</span> <span className="col-span-2">{resW} x {resH} pixels</span>
                                <span className="font-semibold text-slate-500">Total Area:</span> <span className="col-span-2">{areaSqft.toFixed(2)} Sq.ft / {areaSqm.toFixed(2)} Sq.m</span>
                                <span className="font-semibold text-slate-500">Total Weight:</span> <span className="col-span-2">{totalWeight.toFixed(1)} kg</span>
                                <span className="font-semibold text-slate-500">Avg Power:</span> <span className="col-span-2">{(avgPower).toFixed(0)} Watts</span>
                                <span className="font-semibold text-slate-500">Max Power:</span> <span className="col-span-2">{(maxPower).toFixed(0)} Watts</span>
                                <span className="font-semibold text-slate-500">Brightness:</span> <span className="col-span-2">{moduleType.brightness} nits</span>
                                <span className="font-semibold text-slate-500">Refresh Rate:</span> <span className="col-span-2">{moduleType.refreshRate} Hz</span>
                                <span className="font-semibold text-slate-500">Controller:</span> <span className="col-span-2">{processor ? `${processor.brand} ${processor.model}` : 'Standard'}</span>
                                <span className="font-semibold text-slate-500">Viewing:</span> <span className="col-span-2">H: {moduleType.viewAngleH} / V: {moduleType.viewAngleV}</span>
                                <span className="font-semibold text-slate-500">IP Rating:</span> <span className="col-span-2">Front: IP{moduleType.ipFront} / Back: IP{moduleType.ipBack}</span>
                            </div>
                        </div>
                    </div>

                    {/* Visualizer */}
                    <div className="mb-8 border rounded-lg p-2 bg-slate-50 break-inside-avoid">
                        <ScreenVisualizer cols={gridCols} rows={gridRows} module={moduleType} cabinet={cabinetType} unit="m" />
                    </div>

                    {/* Commercial Quote */}
                    <div className="mb-6 break-inside-avoid">
                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2 pb-1">Commercial Proposal</h3>
                        <table className="w-full border-collapse border border-slate-300 text-[11px]">
                            <thead className="bg-slate-800 text-white">
                                <tr>
                                    <th className="p-2 border border-slate-600 text-left w-12">#</th>
                                    <th className="p-2 border border-slate-600 text-left">Item Description</th>
                                    <th className="p-2 border border-slate-600 text-right w-32">Amount (1 Screen)</th>
                                    <th className="p-2 border border-slate-600 text-right w-32">Amount ({screenQty} Screens)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {commercialRows.map((row, i) => (
                                    <tr key={i}>
                                        <td className="p-2 border border-slate-300 text-center">{i + 1}</td>
                                        <td className="p-2 border border-slate-300 font-bold">{row.name}</td>
                                        <td className="p-2 border border-slate-300 text-right">{formatCurrency(row.rate, currency)}</td>
                                        <td className="p-2 border border-slate-300 text-right font-bold">{formatCurrency(row.rate * screenQty, currency)}</td>
                                    </tr>
                                ))}
                                <tr className="bg-slate-100">
                                    <td colSpan="3" className="p-2 border border-slate-300 text-right font-bold uppercase">Grand Total (Excl. GST)</td>
                                    <td className="p-2 border border-slate-300 text-right font-bold text-sm">{formatCurrency(totalProjectSell, currency)}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    {/* Terms & Conditions */}
                    <div className="break-inside-avoid">
                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mb-2 pb-1">Terms & Conditions</h3>
                        
                        <div className="text-[10px] text-slate-600 space-y-3">
                            <div className="grid grid-cols-[100px_1fr] gap-y-2 gap-x-4">
                                <div className="font-bold text-slate-800">PRICE</div>
                                <div>{data.terms?.price || 'Ex-works Mumbai'}</div>

                                <div className="font-bold text-slate-800">PAYMENT</div>
                                <div>
                                    {(data.terms?.payment || []).map((p, i) => (
                                        <span key={i}>{p.percent}% {p.name}{i < data.terms.payment.length - 1 ? ', ' : '.'} </span>
                                    ))}
                                </div>

                                <div className="font-bold text-slate-800">DELIVERY</div>
                                <div>Within {data.terms?.deliveryWeeks} weeks from the date of receipt of advance payment with order.</div>

                                <div className="font-bold text-slate-800">GST</div>
                                <div>Extra as applicable (currently 18%)</div>

                                <div className="font-bold text-slate-800">WARRANTY</div>
                                <div className="text-justify leading-snug">
                                    Against any manufacturing defect. Offsite support for troubleshooting. Client can sign up for Admires excellent AMC services for on-site support. 
                                    Serious fault will be attended to by our technical team within 48-72 hours upon receipt of written complaints with pictures/videos of the fault. 
                                    1% Extra spares includes Modules, Power Supply, Receiver Card (if there are over 100 cabinets), Flat cables, 5V connectors, Power and Data Cable. 
                                    Any damage to the screen due to force majure, natural disasters, electricity surge, earthing, accident, etc is not covered under the warranty. 
                                    Power supplies damage due to power fluctuation will not be covered under warranty. Power supply will be under the direct warranty of the OEM supplier. 
                                    If the repair requires additional components then these will be charged extra. Brightness control meter, Video Processor & Timer can be supplied at extra cost. 
                                    Maintenance team visit in six months during warranty period.
                                </div>
                            </div>
                        </div>

                        <h3 className="font-bold text-slate-700 uppercase border-b border-slate-300 mt-4 mb-2 pb-1">Client's Scope</h3>
                        <div className="text-[10px] text-slate-600 grid gap-y-2">
                            <div>
                                <span className="font-bold text-slate-800 block">Structure:</span>
                                Foundation & Structure. Structural stability certificate from a consultant. For wall mounted outdoor screen, Client to ensure strong and solid brick wall, RCC beams and column base. 
                                For front access indoor screen, Client to ensure a strong base. Indoor Structures cannot be mounted on ACP Sheets, Gypsum boards etc. 
                                Scaffolding, Aluminium composite panelling if required. Personnel for troubleshooting training during the screen installation. Helpers for loading, unloading and installing the display at site.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Electricity:</span>
                                Electricity 3 phase electric power near the site, not more than 5m from the site, before the commencement of work. Electrical distribution board within 5m from the screen. 
                                Conduited electrical cable. 4mm 2 core armored cable or 4mm 3 core cables, 32 ampere MCB, 1 switch board with 2 sockets. 
                                Good quality Stabiliser and timers. 1 Certified electrical engineer for all connections from power Main to the unit. Ventilation machineries such as Air Conditioners or Fans.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Internet:</span>
                                CAT 6 or Optic Fiber Data cable and its terminations. Data points near the screen. Space with power sockets for Video wall Controllers. 
                                Data source/AV room within 80 meters of the screen. Connections to be availed through CAT 6 cables duly terminated with RJ45. 
                                If the length is farther then Fiber optic converter will be required. Fiber optic converters, if required, will be charged extra. 
                                In case the fiber optic converter is required, single mode Fiber optic cable is to be provided by client from source point to the display, terminated as per specs with Patch Chords from the splicing unit to connect to screen.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Software:</span>
                                3rd party Software for Content upload on screen will be provided by the controller card supplier. Admire cannot provide regular updates and application stability.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Permissions:</span>
                                All permissions such as PTW, work permits & gate passes for workers, engineers and executives.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Computer:</span>
                                As per specification, to be arranged by client.
                            </div>
                            <div>
                                <span className="font-bold text-slate-800 block">Validity:</span>
                                30 days.
                            </div>
                        </div>

                        <div className="mt-8 pt-8 border-t border-slate-200 flex justify-between items-end">
                            <div className="text-center">
                                <div className="h-12 mb-2"></div>
                                <p className="text-[10px] font-bold border-t border-slate-400 px-4 pt-1">Client Acceptance</p>
                            </div>
                            <div className="text-center">
                                <div className="h-12 mb-2"></div>
                                <p className="text-[10px] font-bold border-t border-slate-400 px-4 pt-1">For Admire Sign & Display Pvt. Ltd.</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

      // 6. BOM Layout - Updated for Multi-Screen Support
const BOMLayout = ({ data, allScreensData }) => {
    if (!data && !allScreensData) return null;
    
    // If multi-screen data exists, use that; otherwise fall back to single screen
    const isMultiScreen = allScreensData && allScreensData.calculations && allScreensData.calculations.length > 1;
    
    if (!isMultiScreen && !data) return null;
    
    const clientName = data?.clientName || '';
    const projectName = data?.projectName || '';
    
    // Helper to render a single screen's BOM table
    const renderScreenBOM = (calc, screenIndex, screenConfig) => {
        const { detailedItems, screenQty, moduleType, cabinetType, finalWidth, finalHeight } = calc;
        
        return (
            <div key={screenIndex} className="mb-8 break-inside-avoid">
                {isMultiScreen && (
                    <div className="bg-teal-50 dark:bg-teal-900/20 p-3 rounded-lg mb-3 border border-teal-200 dark:border-teal-800">
                        <h3 className="font-bold text-teal-800 dark:text-teal-300 text-sm">
                            Screen Configuration #{screenIndex + 1}
                        </h3>
                        <div className="grid grid-cols-4 gap-2 mt-2 text-xs text-teal-700 dark:text-teal-400">
                            <div><span className="font-semibold">Target:</span> {screenConfig.targetWidth}{screenConfig.targetHeight}{screenConfig.unit || 'm'}</div>
                            <div><span className="font-semibold">Final:</span> {finalWidth}m  {finalHeight}m</div>
                            <div><span className="font-semibold">Quantity:</span> {screenQty} screens</div>
                            {moduleType && <div><span className="font-semibold">Pitch:</span> P{moduleType.pitch}</div>}
                        </div>
                    </div>
                )}
                
                <table className="w-full border-collapse border border-slate-300 text-[10px]">
                    <thead className="bg-slate-100 text-slate-700">
                        <tr>
                            <th className="p-2 border border-slate-300 text-left w-10">#</th>
                            <th className="p-2 border border-slate-300 text-left w-32">Component</th>
                            <th className="p-2 border border-slate-300 text-left">Specification / Details</th>
                            <th className="p-2 border border-slate-300 text-center w-16">Qty/Scrn</th>
                            <th className="p-2 border border-slate-300 text-center w-16">Total Qty</th>
                        </tr>
                    </thead>
                    <tbody>
                        {detailedItems.map((item, i) => {
                            let extraSpecs = null;
                            if (item.id === 'modules' && moduleType) {
                                extraSpecs = (
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-1 mt-1 text-[9px] text-slate-500">
                                        <span>Size: {moduleType.width}x{moduleType.height}mm</span>
                                        <span>LED: {moduleType.ledType || '-'}</span>
                                        <span>Bright: {moduleType.brightness} nits</span>
                                        <span>Ref: {moduleType.refreshRate} Hz</span>
                                        <span>Ang: {moduleType.viewAngleH}/{moduleType.viewAngleV}</span>
                                        <span>IP: {moduleType.ipFront}/{moduleType.ipBack}</span>
                                        <span>Pwr: {moduleType.avgPower}/{moduleType.maxPower} W</span>
                                        <span>Wt: {moduleType.weight} kg</span>
                                    </div>
                                );
                            }
                            if (item.id === 'cabinets' && cabinetType) {
                                extraSpecs = (
                                    <div className="grid grid-cols-2 gap-x-4 gap-y-1 mt-1 text-[9px] text-slate-500">
                                        <span>Size: {cabinetType.width}x{cabinetType.height}mm</span>
                                        <span>Mat: {cabinetType.material}</span>
                                        <span>Weight: {cabinetType.weight} kg</span>
                                    </div>
                                );
                            }
                            return (
                                <tr key={i}>
                                    <td className="p-2 border border-slate-300 text-center">{i + 1}</td>
                                    <td className="p-2 border border-slate-300 font-bold align-top">{item.name}</td>
                                    <td className="p-2 border border-slate-300 align-top">
                                        <div className="font-semibold">{item.spec}</div>
                                        {extraSpecs}
                                    </td>
                                    <td className="p-2 border border-slate-300 text-center align-top">{item.qty}</td>
                                    <td className="p-2 border border-slate-300 text-center font-bold align-top">{item.qty * screenQty}</td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };
    
    // Helper to render consolidated BOM (all screens combined)
    const renderConsolidatedBOM = () => {
        if (!isMultiScreen) return null;
        
        // Aggregate all components across all screens
        const consolidatedItems = {};
        
        allScreensData.calculations.forEach((calc, screenIndex) => {
            calc.detailedItems.forEach(item => {
                const key = `${item.inventoryId || item.id}_${item.spec}`;
                
                if (!consolidatedItems[key]) {
                    consolidatedItems[key] = {
                        name: item.name,
                        spec: item.spec,
                        totalQty: 0,
                        screens: []
                    };
                }
                
                const itemTotalQty = item.qty * calc.screenQty;
                consolidatedItems[key].totalQty += itemTotalQty;
                consolidatedItems[key].screens.push({
                    screenIndex: screenIndex + 1,
                    qtyPerScreen: item.qty,
                    screenQty: calc.screenQty,
                    total: itemTotalQty
                });
            });
        });
        
        const consolidatedArray = Object.values(consolidatedItems);
        
        return (
            <div className="mt-8 break-inside-avoid border-t-4 border-slate-800 pt-6">
                <div className="bg-slate-800 text-white p-3 rounded-t-lg mb-0">
                    <h3 className="font-bold text-lg uppercase tracking-wide">Consolidated Bill of Materials</h3>
                    <p className="text-xs text-slate-300 mt-1">Combined quantities across all screen configurations</p>
                </div>
                
                <table className="w-full border-collapse border border-slate-300 text-[10px]">
                    <thead className="bg-slate-700 text-white">
                        <tr>
                            <th className="p-2 border border-slate-600 text-left w-10">#</th>
                            <th className="p-2 border border-slate-600 text-left w-32">Component</th>
                            <th className="p-2 border border-slate-600 text-left">Specification</th>
                            <th className="p-2 border border-slate-600 text-center w-20">Total Qty</th>
                            <th className="p-2 border border-slate-600 text-left">Usage Breakdown</th>
                        </tr>
                    </thead>
                    <tbody>
                        {consolidatedArray.map((item, i) => (
                            <tr key={i} className={i % 2 === 0 ? 'bg-slate-50' : 'bg-white'}>
                                <td className="p-2 border border-slate-300 text-center">{i + 1}</td>
                                <td className="p-2 border border-slate-300 font-bold align-top">{item.name}</td>
                                <td className="p-2 border border-slate-300 align-top">{item.spec}</td>
                                <td className="p-2 border border-slate-300 text-center font-bold align-top text-teal-700">{item.totalQty}</td>
                                <td className="p-2 border border-slate-300 align-top">
                                    <div className="text-[9px] text-slate-600">
                                        {item.screens.map((screen, idx) => (
                                            <span key={idx}>
                                                Screen #{screen.screenIndex}: {screen.total} units
                                                {idx < item.screens.length - 1 ? '  ' : ''}
                                            </span>
                                        ))}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                
                <div className="mt-4 p-3 bg-teal-50 dark:bg-teal-900/20 rounded-lg border border-teal-200 dark:border-teal-800">
                    <div className="grid grid-cols-3 gap-4 text-xs">
                        <div>
                            <span className="font-bold text-teal-800 dark:text-teal-300">Total Configurations:</span>
                            <span className="ml-2 font-bold text-lg text-teal-600 dark:text-teal-400">{allScreensData.calculations.length}</span>
                        </div>
                        <div>
                            <span className="font-bold text-teal-800 dark:text-teal-300">Total Screens:</span>
                            <span className="ml-2 font-bold text-lg text-teal-600 dark:text-teal-400">{allScreensData.totalScreenQty}</span>
                        </div>
                        <div>
                            <span className="font-bold text-teal-800 dark:text-teal-300">Unique Components:</span>
                            <span className="ml-2 font-bold text-lg text-teal-600 dark:text-teal-400">{consolidatedArray.length}</span>
                        </div>
                    </div>
                </div>
            </div>
        );
    };

    return (
        <div className="p-8 max-w-[210mm] mx-auto bg-white min-h-screen text-slate-800 print:p-0 print:w-full font-sans text-xs">
            <div className="flex justify-between items-start mb-6 border-b-2 border-slate-800 pb-4">
                <div>
                    <h1 className="text-2xl font-bold text-slate-900 uppercase tracking-wide">Bill of Materials</h1>
                    <div className="mt-2 space-y-1">
                        <p className="text-sm font-bold text-slate-700">Project: <span className="font-normal">{projectName}</span></p>
                        <p className="text-sm font-bold text-slate-700">Client: <span className="font-normal">{clientName}</span></p>
                        {isMultiScreen && (
                            <p className="text-sm font-bold text-slate-700">
                                Configurations: <span className="font-normal">{allScreensData.calculations.length} screen types  {allScreensData.totalScreenQty} total screens</span>
                            </p>
                        )}
                        {!isMultiScreen && data.moduleType && (
                            <p className="text-sm font-bold text-slate-700">
                                Specs: <span className="font-normal">P{data.moduleType.pitch} {data.moduleType.indoor ? 'Indoor' : 'Outdoor'}  {data.finalWidth}m x {data.finalHeight}m  Qty: {data.screenQty}</span>
                            </p>
                        )}
                    </div>
                </div>
                <div className="text-right">
                    <p className="text-sm font-bold text-slate-700">REF: {generateId()}</p>
                    <p className="text-xs text-slate-500">{new Date().toLocaleDateString()}</p>
                </div>
            </div>

            {/* Individual Screen BOMs */}
            {isMultiScreen ? (
                <>
                    <div className="mb-6">
                        <h2 className="text-sm font-bold text-slate-700 uppercase mb-3 pb-2 border-b border-slate-300">Individual Screen Configurations</h2>
                    </div>
                    {allScreensData.calculations.map((calc, index) => 
                        renderScreenBOM(calc, index, allScreensData.screenConfigs ? allScreensData.screenConfigs[index] : {})
                    )}
                    
                    {/* Consolidated BOM */}
                    {renderConsolidatedBOM()}
                </>
            ) : (
                // Single screen BOM (backward compatible)
                renderScreenBOM(data, 0, {})
            )}
            
            <div className="mt-8 text-[10px] text-slate-400 border-t border-slate-200 pt-2 text-center">
                Internal Document  Generated by Admire Signage Tool
            </div>
        </div>
    );
};

        // Helper: Extra Input
        const ExtraInput = ({ label, fieldKey, extras, updateExtra, currency }) => (
            <div className="flex flex-col gap-1">
                <label className="text-xs text-slate-500 dark:text-slate-400">{label}</label>
                <div className="flex items-center">
                    <input
                        type="number"
                        value={extras[fieldKey].val}
                        onChange={e => updateExtra(fieldKey, 'val', e.target.value)}
                        className="w-full p-2 border rounded-l text-sm border-r-0 dark:bg-slate-700 dark:border-slate-600 dark:text-white"
                    />
                    <button
                        onClick={() => updateExtra(fieldKey, 'type', extras[fieldKey].type === 'abs' ? 'pct' : 'abs')}
                        className={`px-3 py-2 text-xs font-bold border rounded-r w-16 transition-colors dark:border-slate-600 ${extras[fieldKey].type === 'pct' ? 'bg-teal-600 text-white border-teal-600' : 'bg-slate-100 dark:bg-slate-800 border-slate-300 text-slate-600 dark:text-slate-300'}`}
                    >
                        {extras[fieldKey].type === 'abs' ? (currency === 'INR' ? '' : '$') : '%'}
                    </button>
                </div>
            </div>
        );
// Helper: Shared Calculation Logic
        const calculateBOM = (state, inventory, transactions, exchangeRate) => {
            const {
                screenQty, targetWidth, targetHeight, unit, 
                selectedIndoor, assemblyMode, selectedPitch, selectedModuleId, 
                selectedCabinetId, selectedCardId, selectedPSUId, selectedProcId, 
                sizingMode, readyId, margin, extras, overrides, extraComponents,
                pricingMode, targetSellPrice, commercials, terms
            } = state;

            const getPriceInInr = (item) => {
                if (!item) return 0;
                const basePrice = Number(item.price || 0);
                const carriage = Number(item.carriage || 0);
                const totalBase = basePrice + carriage; 
                if (item.currency === 'USD') return totalBase * exchangeRate;
                return totalBase; 
            };

            let module, cabinet, card, psu, proc;
            let totalModules = 0;

            if (assemblyMode === 'assembled') {
                module = inventory.find(i => i.id === selectedModuleId);
                cabinet = inventory.find(i => i.id === selectedCabinetId);
                card = inventory.find(i => i.id === selectedCardId);
                psu = inventory.find(i => i.id === selectedPSUId);
                proc = inventory.find(i => i.id === selectedProcId);
                if (!module || !cabinet) return null;
            } else {
                const readyUnit = inventory.find(i => i.id === readyId);
                proc = inventory.find(i => i.id === selectedProcId);
                if (!readyUnit) return null;
                module = readyUnit; 
                cabinet = readyUnit;
            }

            // Dimensions
            const w_mm = unit === 'm' ? targetWidth * 1000 : targetWidth * 304.8;
            const h_mm = unit === 'm' ? targetHeight * 1000 : targetHeight * 304.8;

            // Sizing Logic
            const rawCols = w_mm / cabinet.width;
            const rawRows = h_mm / cabinet.height;
            let cols, rows;
            if (sizingMode === 'up') { cols = Math.ceil(rawCols); rows = Math.ceil(rawRows); }
            else if (sizingMode === 'down') { cols = Math.max(1, Math.floor(rawCols)); rows = Math.max(1, Math.floor(rawRows)); }
            else { cols = Math.max(1, Math.round(rawCols)); rows = Math.max(1, Math.round(rawRows)); }

            const finalW_mm = cols * cabinet.width;
            const finalH_mm = rows * cabinet.height;
            const totalCabinetsPerScreen = cols * rows;

            // Area Calculation
            const areaSqFt = (finalW_mm * finalH_mm) / 92903; 

            // --- BUILD ITEM LIST ---
            let rawItems = [];
            if (assemblyMode === 'assembled') {
                const modsPerCab = (Math.floor(cabinet.width / module.width) * Math.floor(cabinet.height / module.height));
                totalModules = totalCabinetsPerScreen * modsPerCab;
                rawItems = [
                    { id: 'modules', inventoryId: selectedModuleId, name: 'Modules', spec: `${module.brand} ${module.model}`, qty: totalModules, unit: getPriceInInr(module), total: totalModules * getPriceInInr(module), type: 'led' },
                    { id: 'cabinets', inventoryId: selectedCabinetId, name: 'Cabinets', spec: `${cabinet.brand} ${cabinet.model}`, qty: totalCabinetsPerScreen, unit: getPriceInInr(cabinet), total: totalCabinetsPerScreen * getPriceInInr(cabinet), type: 'led' },
                    { id: 'cards', inventoryId: selectedCardId, name: 'Cards', spec: card ? card.brand : '-', qty: totalCabinetsPerScreen, unit: getPriceInInr(card), total: totalCabinetsPerScreen * getPriceInInr(card), type: 'led' },
                    { id: 'psu', inventoryId: selectedPSUId, name: 'SMPS', spec: psu ? psu.brand : '-', qty: totalCabinetsPerScreen, unit: getPriceInInr(psu), total: totalCabinetsPerScreen * getPriceInInr(psu), type: 'led' },
                ];
            } else {
                rawItems = [
                    { id: 'ready', inventoryId: readyId, name: 'LED Panels (Ready)', spec: `${cabinet.brand} ${cabinet.model}`, qty: totalCabinetsPerScreen, unit: getPriceInInr(cabinet), total: totalCabinetsPerScreen * getPriceInInr(cabinet), type: 'led' }
                ];
                totalModules = totalCabinetsPerScreen;
            }
            // Always include processor row so it remains visible in the Cost Sheet UI
            rawItems.push({ 
                id: 'processor', 
                inventoryId: selectedProcId, 
                name: 'Processor', 
                spec: proc ? proc.brand : 'Select Processor', 
                qty: 1, 
                unit: proc ? getPriceInInr(proc) : 0, 
                total: proc ? getPriceInInr(proc) : 0, 
                type: 'service' 
            });

            // Add Extra Components
            if (extraComponents && extraComponents.length > 0) {
                extraComponents.forEach(extra => {
                    const invItem = inventory.find(i => i.id === extra.componentId);
                    if (invItem) {
                        const extraQty = extra.type === 'cabinet' ? (extra.qty * totalCabinetsPerScreen) : extra.qty;
                        rawItems.push({
                            id: extra.id,
                            inventoryId: extra.componentId,
                            name: `Extra: ${invItem.type}`,
                            spec: `${invItem.brand} ${invItem.model}`,
                            qty: extraQty,
                            unit: getPriceInInr(invItem),
                            total: extraQty * getPriceInInr(invItem),
                            type: invItem.type === 'processor' ? 'service' : 'led' // Categorize extra components
                        });
                    } else {
                        // Show placeholder for newly added (empty) extras
                        rawItems.push({
                            id: extra.id,
                            inventoryId: '',
                            name: 'Extra Component',
                            spec: 'Select Item...',
                            qty: extra.qty || 1,
                            unit: 0,
                            total: 0,
                            type: 'led'
                        });
                    }
                });
            }

            // --- APPLY OVERRIDES ---
            const finalItems = rawItems.map(item => {
                if (overrides && overrides[item.id]) {
                    const ov = overrides[item.id];
                    const finalQty = ov.qty !== undefined && ov.qty !== '' ? Number(ov.qty) : item.qty;
                    const finalRate = ov.rate !== undefined && ov.rate !== '' ? Number(ov.rate) : item.unit;
                    return { ...item, qty: finalQty, unit: finalRate, total: finalQty * finalRate, isOverridden: true };
                }
                return item;
            });

            // --- SPLIT COSTS: LED vs SERVICES ---
            const ledItemsTotal = finalItems.filter(i => i.type === 'led').reduce((acc, i) => acc + i.total, 0);
            const serviceItemsTotal = finalItems.filter(i => i.type !== 'led').reduce((acc, i) => acc + i.total, 0);

            // Extras: Split logic
            const calculatedExtras = {};
            let ledOpsCost = 0;
            let serviceOpsCost = 0;

            if(extras) {
                Object.keys(extras).forEach(key => {
                    const item = extras[key];
                    let val = 0;
                    
                    // NEW: Sync Cost Unit with Sell Unit
                    if (key === 'install') {
                         const mode = commercials?.installation?.unit || 'sqft';
                         const rate = Number(item.val); // Input is now treated as Rate based on mode
                         if (mode === 'sqft') val = rate * areaSqFt; // Rate * Area
                         else val = rate; // Rate is Flat Amount
                    } 
                    else if (key === 'structure') {
                         const mode = commercials?.structure?.unit || 'sqft';
                         const rate = Number(item.val);
                         if (mode === 'sqft') val = rate * areaSqFt;
                         else val = rate;
                    }
                    // Standard Logic for other overheads
                    else {
                        const baseForPct = ledItemsTotal; 
                        if (item.type === 'pct') val = baseForPct * (item.val / 100);
                        else val = Number(item.val);
                    }

                    calculatedExtras[key] = val;

                    if (key === 'structure' || key === 'install') {
                        serviceOpsCost += val;
                    } else {
                        ledOpsCost += val;
                    }
                });
            }
            
            // COST TOTALS (Per Screen)
            const costLEDPerScreen = ledItemsTotal + ledOpsCost;
            const costServicesPerScreen = serviceItemsTotal + serviceOpsCost;
            const costPerScreenTotal = costLEDPerScreen + costServicesPerScreen;

            const totalProjectCost = costPerScreenTotal * screenQty;

            // --- COMMERCIALS / SELL PRICE LOGIC ---
            
            // 1. Calculate Service Sell Prices (Fixed Inputs)
            const comms = commercials || { processor: {val:0}, installation: {val:0}, structure: {val:0} };
            
            // Processor SP
            let sellProcTotal = 0;
            if (comms.processor.unit === 'unit') {
                const procItem = finalItems.find(i => i.id === 'processor'); // Find overridden qty if exists
                const procQty = procItem ? procItem.qty : 1; 
                sellProcTotal = Number(comms.processor.val) * procQty * screenQty;
            } else { // per screen
                sellProcTotal = Number(comms.processor.val) * screenQty;
            }

            // Installation SP
            let sellInstallTotal = 0;
            if (comms.installation.unit === 'sqft') {
                sellInstallTotal = Number(comms.installation.val) * areaSqFt * screenQty;
            } else { // per screen
                sellInstallTotal = Number(comms.installation.val) * screenQty;
            }

            // Structure SP
            let sellStructureTotal = 0;
            if (comms.structure.unit === 'sqft') {
                sellStructureTotal = Number(comms.structure.val) * areaSqFt * screenQty;
            } else { // per screen
                sellStructureTotal = Number(comms.structure.val) * screenQty;
            }
            
            const totalServiceSell = sellProcTotal + sellInstallTotal + sellStructureTotal;
            const sellServicesPerScreen = totalServiceSell / screenQty;

            // 2. Calculate LED Panel Sell Price (The Variable/Target)
            let sellLEDPerScreen = 0;
            let effectiveMargin = margin;
            const mode = pricingMode || 'margin';

            if (mode === 'margin') {
                // Formula: Cost / (1 - Margin%) -> GROSS MARGIN Logic
                // If user enters 30%, they expect 30% profit on the sell price.
                // However, standard markup is Cost * (1 + Margin%).
                // Let's stick to the industry standard requested: "Cost + Margin%" usually implies Markup in simple tools,
                // BUT the user explicitly compared to Excel which used Gross Margin logic (Profit/Sell).
                // Let's use Markup (Cost * 1.X) as it's safer/standard for simple calculators unless 'Gross Margin' is explicitly requested.
                // Re-reading prompt: "User input of Margin %... should only be for the LED Panel".
                // I will use simple Markup for now: Cost * (1 + M/100). 
                sellLEDPerScreen = costLEDPerScreen * (1 + margin/100);
            } else {
                const target = Number(targetSellPrice || 0);
                if (mode === 'screen') sellLEDPerScreen = target;
                else if (mode === 'sqft') sellLEDPerScreen = target * areaSqFt;
                else if (mode === 'sqm') sellLEDPerScreen = target * (areaSqFt / 10.7639);
                
                // Reverse Calculate Effective Margin for LED Panel
                if (costLEDPerScreen > 0) effectiveMargin = ((sellLEDPerScreen - costLEDPerScreen) / costLEDPerScreen) * 100;
                else effectiveMargin = 0;
            }

            const totalLEDSell = sellLEDPerScreen * screenQty;
            
            // --- FINAL TOTALS ---
            const totalProjectSell = totalLEDSell + totalServiceSell;
            const totalMargin = totalProjectSell - totalProjectCost;

            return {
                gridCols: cols, gridRows: rows,
                finalWidth: (finalW_mm / 1000).toFixed(2), finalHeight: (finalH_mm / 1000).toFixed(2),
                totalCabinets: totalCabinetsPerScreen, moduleType: module, cabinetType: cabinet, processor: proc,
                breakdown: { 
                    qtyModules: totalModules, 
                    ledOps: ledOpsCost,
                    serviceOps: serviceOpsCost 
                },
                detailedItems: finalItems, calculatedExtras, 
                
                // Costs
                costLEDPerScreen,
                costServicesPerScreen,
                costPerScreen: costPerScreenTotal,
                totalProjectCost,
                
                // Sales
                finalPrice: totalProjectSell, 
                totalProjectSell, 
                
                assemblyMode, screenQty, 
                commercials: { sellProcTotal, sellInstallTotal, sellStructureTotal },
                terms: terms || { price: 'Ex-works Mumbai', deliveryWeeks: 10, payment: [] },
                
                // Matrix for UI
                matrix: {
                    cost: { sqft: costPerScreenTotal / areaSqFt, unit: costPerScreenTotal, total: totalProjectCost },
                    margin: { sqft: (totalMargin/screenQty) / areaSqFt, unit: (totalMargin/screenQty), total: totalMargin },
                    sell: { sqft: (totalProjectSell/screenQty) / areaSqFt, unit: (totalProjectSell/screenQty), total: totalProjectSell },
                    
                    // Specific LED Panel Metrics (for the Calculator UI focus)
                    led: {
                        cost: costLEDPerScreen,
                        sell: sellLEDPerScreen,
                        margin: sellLEDPerScreen - costLEDPerScreen,
                        marginPct: effectiveMargin
                    },
                    
                    sqft: { perScreen: areaSqFt, total: areaSqFt * screenQty }
                }
            };
        };
        // 5. Updated QuoteCalculator (Mockup UI Implementation)

        // --- Helper Components ---
        const LogisticsInput = ({ label, fieldKey, extras, updateExtra }) => (
            <div className="flex items-center justify-between gap-2 mb-2">
                <label className="text-xs text-slate-500 dark:text-slate-400 flex-1">{label}</label>
                <div className="flex items-center w-36 relative">
                    <input
                        type="number"
                        value={extras[fieldKey].val}
                        onChange={e => updateExtra(fieldKey, 'val', e.target.value)}
                        className="w-full pl-3 pr-9 py-1.5 text-right text-sm border border-slate-200 dark:border-slate-600 rounded bg-slate-50 dark:bg-slate-800 dark:text-white focus:bg-white dark:focus:bg-slate-700 focus:ring-1 focus:ring-teal-500 transition-all"
                    />
                    <button
                        onClick={() => updateExtra(fieldKey, 'type', extras[fieldKey].type === 'abs' ? 'pct' : 'abs')}
                        className="absolute right-1 top-1 bottom-1 px-1.5 text-[10px] font-bold text-slate-400 hover:text-teal-600 uppercase bg-transparent"
                    >
                        {extras[fieldKey].type === 'abs' ? '' : '%'}
                    </button>
                </div>
            </div>
        );

        const CommercialInput = ({ label, costVal, setCost, sellVal, setSell, sellUnit, setSellUnit }) => (
            <div className="mb-3">
                <div className="flex justify-between text-xs mb-1">
                    <span className="font-medium text-slate-700 dark:text-slate-300">{label}</span>
                    {sellUnit && (
                        <select value={sellUnit} onChange={e => setSellUnit(e.target.value)} className="text-[10px] text-slate-500 bg-slate-100 dark:bg-slate-700 border-none rounded px-1 py-0.5 outline-none cursor-pointer">
                            <option value="sqft">/Sq.Ft</option>
                            <option value="screen">/Screen</option>
                        </select>
                    )}
                </div>
                <div className="flex gap-2">
                    <div className="relative flex-1 group">
                        <span className="absolute left-2 top-1.5 text-xs text-slate-400 font-bold">Cost</span>
                        <input type="number" value={costVal} onChange={e => setCost(e.target.value)} placeholder="0" className="w-full pl-10 pr-2 py-1.5 text-right text-sm border border-slate-200 dark:border-slate-600 rounded bg-red-50/30 dark:bg-red-900/10 focus:bg-white dark:focus:bg-slate-700 dark:text-white transition-colors" />
                    </div>
                    <div className="relative flex-1">
                        <span className="absolute left-2 top-1.5 text-xs text-slate-400 font-bold">Sell</span>
                        <input type="number" value={sellVal} onChange={e => setSell(e.target.value)} placeholder="0" className="w-full pl-10 pr-2 py-1.5 text-right text-sm border border-slate-200 dark:border-slate-600 rounded bg-green-50/30 dark:bg-green-900/10 focus:bg-white dark:focus:bg-slate-700 dark:text-white font-semibold text-green-700 dark:text-green-400 transition-colors" />
                    </div>
                </div>
            </div>
        );

  // --- Interactive Cost Table (With Sub-totals & Working Add Button) ---
        const InteractiveCostSheet = ({ calculation, state, updateState, updateExtra, updateScreenProp, inventory, getStock, overrides, onOverride, editingRow, setEditingRow, onClearOverride }) => {
    
    const activeScreen = state.screens[state.activeScreenIndex];
const { screenQty, selectedPitch, selectedModuleId, selectedCabinetId, selectedCardId, selectedPSUId, selectedProcId, sizingMode, readyId, extraComponents, extras, commercials } = activeScreen;
const { assemblyMode, selectedIndoor } = state;

            // Safety ID Generator
            const safeGenId = () => Math.random().toString(36).substr(2, 9).toUpperCase();

            // --- Filter Logic ---
            const isIndoor = selectedIndoor === 'true';
            const availableModules = inventory.filter(i => i.type === 'module' && i.indoor === isIndoor);
            const uniquePitches = [...new Set(availableModules.map(m => m.pitch))].sort((a, b) => a - b);
            const filteredModules = selectedPitch ? availableModules.filter(m => m.pitch == selectedPitch) : [];
            const selectedModule = inventory.find(i => i.id === selectedModuleId);
            const cabinets = inventory.filter(i => {
                if (i.type !== 'cabinet') return false;
                if (!selectedModule) return true;
                return (i.width % selectedModule.width === 0) && (i.height % selectedModule.height === 0);
            });
            const readyUnits = inventory.filter(i => i.type === 'ready' && i.indoor === isIndoor);

            // --- Helper: Render Hardware Selection ---
            const renderComponentCell = (item) => {
    const updateScreenState = (key, value) => {
        updateScreenProp(state.activeScreenIndex, key, value);
    };
    
    if (item.id === 'modules') {
        return (
            <div className="flex gap-2">
                <select value={selectedPitch} onChange={e => { updateScreenState('selectedPitch', e.target.value); updateScreenState('selectedModuleId', ''); }} className="w-20 p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="">Pitch</option>{uniquePitches.map(p => <option key={p} value={p}>P{p}</option>)}
                </select>
                <select value={selectedModuleId} onChange={e => updateScreenState('selectedModuleId', e.target.value)} disabled={!selectedPitch} className="flex-1 p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white disabled:opacity-50">
                    <option value="">Select Module...</option>
                    {filteredModules.map(m => <option key={m.id} value={m.id}>{m.brand} {m.model} ({getStock(m.id)})</option>)}
                </select>
            </div>
        );
    }
    if (item.id === 'cabinets') {
        return <select value={selectedCabinetId} onChange={e => updateScreenState('selectedCabinetId', e.target.value)} disabled={!selectedModule} className="w-full p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white disabled:opacity-50"><option value="">Select Cabinet...</option>{cabinets.map(c => <option key={c.id} value={c.id}>{c.brand} {c.model} ({c.width}x{c.height}) - Stock: {getStock(c.id)}</option>)}</select>;
    }
    if (item.id === 'cards') {
        return <select value={selectedCardId} onChange={e => updateScreenState('selectedCardId', e.target.value)} className="w-full p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">Select Card...</option>{inventory.filter(i => i.type === 'card').map(c => <option key={c.id} value={c.id}>{c.brand} {c.model} ({getStock(c.id)})</option>)}</select>;
    }
    if (item.id === 'psu') {
        return <select value={selectedPSUId} onChange={e => updateScreenState('selectedPSUId', e.target.value)} className="w-full p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">Select SMPS...</option>{inventory.filter(i => i.type === 'psu').map(c => <option key={c.id} value={c.id}>{c.brand} {c.model} ({getStock(c.id)})</option>)}</select>;
    }
    if (item.id === 'processor') {
        return (
            <div className="flex flex-col gap-1">
                <select value={selectedProcId} onChange={e => updateScreenState('selectedProcId', e.target.value)} className="w-full p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="">Select Processor...</option>
                    {inventory.filter(i => i.type === 'processor').map(c => <option key={c.id} value={c.id}>{c.brand} {c.model} ({getStock(c.id)})</option>)}
                </select>
                <div className="flex items-center gap-1">
                    <span className="text-[10px] text-green-600 font-bold">Sell:</span>
                    <input 
    type="number" 
    className="w-20 p-0.5 text-xs border border-green-200 rounded bg-green-50 text-green-800"
    value={commercials.processor?.val || 0}
    onChange={e => updateScreenProp(state.activeScreenIndex, 'commercials', {...commercials, processor: {...commercials.processor, val: e.target.value}})}
/>
                </div>
            </div>
        );
    }
    if (item.id === 'ready') {
         return <select value={readyId} onChange={e => updateScreenState('readyId', e.target.value)} className="w-full p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="">Select Screen Model...</option>{readyUnits.map(u => <option key={u.id} value={u.id}>{u.brand} {u.model} (P{u.pitch})</option>)}</select>;
    }
    
    const extraIdx = extraComponents ? extraComponents.findIndex(e => e.id === item.id) : -1;
    if (extraIdx !== -1) {
         return (
            <div className="flex gap-1 items-center">
                <select value={extraComponents[extraIdx].componentId} onChange={e => { const n = [...extraComponents]; n[extraIdx].componentId = e.target.value; updateScreenState('extraComponents', n); }} className="flex-1 p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white">
                    <option value="">Select...</option>
                    {['module', 'cabinet', 'card', 'psu'].map(type => {
                        const items = inventory.filter(i => i.type === type).sort((a,b) => (a.brand + ' ' + a.model).localeCompare(b.brand + ' ' + b.model));
                        if (items.length === 0) return null;
                        return (
                            <optgroup key={type} label={type === 'psu' ? 'SMPS' : type.toUpperCase()}>
                                {items.map(i => (
                                    <option key={i.id} value={i.id}>{i.brand} {i.model}</option>
                                ))}
                            </optgroup>
                        );
                    })}
                </select>
                <select value={extraComponents[extraIdx].type} onChange={e => { const n = [...extraComponents]; n[extraIdx].type = e.target.value; updateScreenState('extraComponents', n); }} className="w-16 p-1 text-xs border rounded bg-white dark:bg-slate-700 dark:border-slate-600 dark:text-white"><option value="screen">/Scrn</option><option value="cabinet">/Cab</option></select>
                <button type="button" onClick={() => updateScreenState('extraComponents', extraComponents.filter((_, i) => i !== extraIdx))} className="text-red-400 hover:text-red-600"><Trash2 size={12} /></button>
            </div>
        );
    }
    return <span className="font-bold text-slate-700 dark:text-slate-200">{item.name} <span className="text-[10px] text-slate-400 font-normal">({item.spec})</span></span>;
};

            // --- Calculation Grouping ---
            const getExtraCost = (key) => calculation?.calculatedExtras?.[key] || 0;
            
            const defaultItems = assemblyMode === 'assembled' ? [
                { id: 'modules', type: 'led', name: 'Modules', qty: 0, unit: 0, total: 0, spec: 'Select Pitch & Variant' },
                { id: 'cabinets', type: 'led', name: 'Cabinets', qty: 0, unit: 0, total: 0, spec: 'Select Cabinet' },
                { id: 'cards', type: 'led', name: 'Receiving Cards', qty: 0, unit: 0, total: 0, spec: 'Optional' },
                { id: 'psu', type: 'led', name: 'SMPS', qty: 0, unit: 0, total: 0, spec: 'Optional' },
                { id: 'processor', type: 'service', name: 'Processor', qty: 1, unit: 0, total: 0, spec: 'Select Processor' }
            ] : [
                { id: 'ready', type: 'led', name: 'Ready Unit', qty: 0, unit: 0, total: 0, spec: 'Select Model' },
                { id: 'processor', type: 'service', name: 'Processor', qty: 1, unit: 0, total: 0, spec: 'Select Processor' }
            ];

            let displayItems = calculation ? calculation.detailedItems : defaultItems;
            
            if (!calculation && state.extraComponents?.length > 0) {
                displayItems = [...displayItems, ...state.extraComponents.map(e => ({ id: e.id, type: 'led', name: 'Extra', spec: 'Select...', qty: e.qty, unit: 0, total: 0 }))];
            }

            // Calculations for Subtotals
            const areaSqFt = calculation?.matrix?.sqft?.perScreen || 1;
            
            const ledItems = displayItems.filter(i => i.type === 'led');
            const logisticsKeys = ['hardware', 'assembly', 'packaging', 'transport', 'wastage', 'overheads'];
            const logisticsTotal = logisticsKeys.reduce((sum, key) => sum + getExtraCost(key), 0);
            
            const ledItemsTotal = ledItems.reduce((sum, item) => sum + (item.total * screenQty), 0);
            const ledPanelSubtotal = ledItemsTotal + (logisticsTotal * screenQty);
            const ledPanelPerScreen = ledPanelSubtotal / (screenQty || 1);
            const ledPanelPerSqFt = ledPanelPerScreen / areaSqFt;
            
            const serviceItems = displayItems.filter(i => i.type !== 'led'); 
            const installCost = getExtraCost('install');
            const structureCost = getExtraCost('structure');
            const serviceItemsTotal = serviceItems.reduce((sum, item) => sum + (item.total * screenQty), 0);
            const additionalSubtotal = serviceItemsTotal + ((installCost + structureCost) * screenQty);
            const additionalPerScreen = additionalSubtotal / (screenQty || 1);
            const additionalPerSqFt = additionalPerScreen / areaSqFt;

            const grandTotal = ledPanelSubtotal + additionalSubtotal;
            const grandTotalPerScreen = grandTotal / (screenQty || 1);
            const grandTotalPerSqFt = grandTotalPerScreen / areaSqFt;

            // --- Render Rows Helper ---
            const renderItemRow = (item) => (
                <tr key={item.id} className={`hover:bg-slate-50 dark:hover:bg-slate-700/50 transition-colors ${item.isOverridden ? 'bg-amber-50 dark:bg-amber-900/20' : ''}`}>
                    <td className="p-2 pl-4">
                        <div className="flex items-center gap-2">
                            <div className="flex-1">{renderComponentCell(item)}</div>
                            {calculation && (
                                <>
                                    <button type="button" onClick={() => setEditingRow(editingRow === item.id ? null : item.id)} className={`p-1 rounded ${editingRow === item.id ? 'bg-teal-100 text-teal-700' : 'text-slate-300 hover:text-teal-600'}`}><Edit size={12} /></button>
                                    {item.isOverridden && <button type="button" onClick={() => onClearOverride(item.id)} className="text-amber-500 hover:text-red-500"><RefreshCw size={12} /></button>}
                                </>
                            )}
                        </div>
                    </td>
                    <td className="p-2 text-right w-24">
                        {editingRow === item.id ? (
                            <input type="number" className="w-full p-1 text-right text-xs border rounded" value={overrides[item.id]?.rate ?? item.unit} onChange={e => onOverride(item.id, 'rate', e.target.value)} />
                        ) : formatCurrency(item.unit, 'INR', false)}
                    </td>
                    <td className="p-2 text-center border-l border-slate-100 dark:border-slate-700 w-16">
                        {editingRow === item.id ? (
                            <input type="number" className="w-full p-1 text-center text-xs border rounded" value={overrides[item.id]?.qty ?? item.qty} onChange={e => onOverride(item.id, 'qty', e.target.value)} />
                        ) : item.qty}
                    </td>
                    <td className="p-2 text-right text-slate-500 w-24">{formatCurrency(item.total, 'INR', false)}</td>
                    <td className="p-2 text-right font-medium border-l border-slate-100 dark:border-slate-700 w-28">{formatCurrency(item.total * screenQty, 'INR', false)}</td>
                </tr>
            );

            const renderLogisticsRow = (key) => (
                <tr key={key} className="text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td className="p-2 pl-4 text-xs font-medium capitalize">{key}</td>
                    <td className="p-2 text-right">
                        <div className="flex items-center justify-end gap-1">
                            <input type="number" value={extras[key].val} onChange={e => updateExtra(key, 'val', e.target.value)} className="w-16 p-1 text-right text-xs border rounded bg-white dark:bg-slate-800 dark:border-slate-600" />
                            <button type="button" onClick={() => updateExtra(key, 'type', extras[key].type === 'abs' ? 'pct' : 'abs')} className="px-1 text-[10px] font-bold border rounded bg-slate-100 dark:bg-slate-700">{extras[key].type === 'abs' ? '' : '%'}</button>
                        </div>
                    </td>
                    <td className="p-2 text-center border-l border-slate-100 dark:border-slate-700 text-[10px] text-slate-400">{extras[key].type === 'pct' ? `${extras[key].val}%` : '-'}</td>
                    <td className="p-2 text-right">{formatCurrency(getExtraCost(key), 'INR', false)}</td>
                    <td className="p-2 text-right border-l border-slate-100 dark:border-slate-700">{formatCurrency(getExtraCost(key) * screenQty, 'INR', false)}</td>
                </tr>
            );

            const renderServiceRow = (sellKey, label, costKey = sellKey) => (
                <tr key={sellKey} className="text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700/50">
                    <td className="p-2 pl-4">
                        <div className="flex flex-col gap-1">
                            <div className="flex justify-between items-center">
                                <span className="text-xs font-medium">{label}</span>
                                <select value={commercials[sellKey]?.unit || 'sqft'} onChange={e => updateScreenProp(state.activeScreenIndex, 'commercials', {...commercials, [sellKey]: {...commercials[sellKey], unit: e.target.value}})} className="text-[10px] p-0.5 border rounded bg-slate-50 dark:bg-slate-700"><option value="sqft">/Sq.Ft</option><option value="screen">/Screen</option></select>
                            </div>
                            <div className="flex items-center gap-1">
                                <span className="text-[10px] text-green-600 font-bold">Sell:</span>
                                <input type="number" className="w-20 p-0.5 text-xs border border-green-200 rounded bg-green-50 text-green-800" value={commercials[sellKey]?.val || 0} onChange={e => updateScreenProp(state.activeScreenIndex, 'commercials', {...commercials, [sellKey]: {...commercials[sellKey], val: e.target.value}})} />
                            </div>
                        </div>
                    </td>
                    <td className="p-2 text-right">
                        <div className="flex items-center justify-end gap-1">
                            <span className="text-[10px] text-slate-400 mr-1">Cost:</span>
                            <input type="number" value={extras[costKey]?.val || 0} onChange={e => updateExtra(costKey, 'val', e.target.value)} className="w-16 p-1 text-right text-xs border rounded bg-white dark:bg-slate-800 dark:border-slate-600" />
                            <button type="button" onClick={() => updateExtra(costKey, 'type', extras[costKey]?.type === 'abs' ? 'pct' : 'abs')} className="px-1 text-[10px] font-bold border rounded bg-slate-100 dark:bg-slate-700">{extras[costKey]?.type === 'abs' ? '' : '%'}</button>
                        </div>
                    </td>
                    <td className="p-2 text-center border-l border-slate-100 dark:border-slate-700 text-xs">
                        {commercials[sellKey]?.unit === 'sqft' ? calculation?.matrix.sqft.perScreen.toFixed(1) || '-' : '1'}
                    </td>
                    <td className="p-2 text-right">{formatCurrency(getExtraCost(costKey), 'INR', false)}</td>
                    <td className="p-2 text-right border-l border-slate-100 dark:border-slate-700">{formatCurrency(getExtraCost(costKey) * screenQty, 'INR', false)}</td>
                </tr>
            );

            return (
                <div className="overflow-x-auto border border-slate-200 dark:border-slate-700 rounded-lg">
                    <table className="w-full text-xs text-left border-collapse">
                        <thead>
                            <tr className="bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold">
                                <th className="p-2">Component Selection</th>
                                <th className="p-2 text-right">Rate (Cost)</th>
                                <th className="p-2 text-center border-l border-slate-200 dark:border-slate-700">Qty/Scrn</th>
                                <th className="p-2 text-right">Cost/Scrn</th>
                                <th className="p-2 text-right border-l border-slate-200 dark:border-slate-700">Total Cost</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100 dark:divide-slate-700">
                            {/* LED Panel */}
                            <tr className="bg-slate-50 dark:bg-slate-800/50"><td colSpan="5" className="p-2 font-bold text-teal-700 dark:text-teal-400 uppercase tracking-wider text-[10px]">A. LED Panel & Logistics</td></tr>
                            {ledItems.map(renderItemRow)}
                            <tr className="bg-white dark:bg-slate-900">
    <td colSpan="5" className="p-2 text-center">
        <button type="button" onClick={() => updateScreenProp(state.activeScreenIndex, 'extraComponents', [...(extraComponents || []), { id: safeGenId(), componentId: '', qty: 1, type: 'screen' }])} className="text-[10px] text-teal-600 hover:underline flex items-center justify-center gap-1 w-full"><Plus size={10}/> Add Component to Panel</button>
                                </td>
                            </tr>
                            {logisticsKeys.map(k => renderLogisticsRow(k))}
                            <tr className="bg-teal-50 dark:bg-teal-900/20 font-bold border-t border-teal-100 dark:border-teal-800">
                                <td className="p-2 text-right text-teal-800 dark:text-teal-300">Sub-total (LED Panel)</td>
                                <td className="p-2 text-right text-teal-700 dark:text-teal-400 text-[10px] font-normal">{formatCurrency(ledPanelPerSqFt, 'INR')}/sqft</td>
                                <td className="p-2 text-center border-l border-teal-100 dark:border-teal-800">-</td>
                                <td className="p-2 text-right text-teal-800 dark:text-teal-300">{formatCurrency(ledPanelPerScreen, 'INR', false)}</td>
                                <td className="p-2 text-right text-teal-800 dark:text-teal-300 border-l border-teal-100 dark:border-teal-800">{formatCurrency(ledPanelSubtotal, 'INR', false)}</td>
                            </tr>

                            {/* Additional Costs */}
                            <tr className="bg-slate-50 dark:bg-slate-800/50 border-t border-slate-200 dark:border-slate-700"><td colSpan="5" className="p-2 font-bold text-blue-700 dark:text-blue-400 uppercase tracking-wider text-[10px]">B. Additional Costs</td></tr>
                            {serviceItems.map(renderItemRow)}
                            {renderServiceRow('installation', 'Installation', 'install')}
                            {renderServiceRow('structure', 'Structure', 'structure')}
                             <tr className="bg-blue-50 dark:bg-blue-900/20 font-bold border-t border-blue-100 dark:border-blue-800">
                                <td className="p-2 text-right text-blue-800 dark:text-blue-300">Sub-total (Additional)</td>
                                <td className="p-2 text-right text-blue-700 dark:text-blue-400 text-[10px] font-normal">{formatCurrency(additionalPerSqFt, 'INR')}/sqft</td>
                                <td className="p-2 text-center border-l border-blue-100 dark:border-blue-800">-</td>
                                <td className="p-2 text-right text-blue-800 dark:text-blue-300">{formatCurrency(additionalPerScreen, 'INR', false)}</td>
                                <td className="p-2 text-right text-blue-800 dark:text-blue-300 border-l border-blue-100 dark:border-blue-800">{formatCurrency(additionalSubtotal, 'INR', false)}</td>
                            </tr>

                            {/* Grand Total */}
                            <tr className="bg-slate-800 text-white font-bold border-t-2 border-slate-900 text-sm">
                                <td className="p-3 text-right uppercase">Grand Total (Cost)</td>
                                <td className="p-3 text-right text-slate-300 text-xs font-normal">{formatCurrency(grandTotalPerSqFt, 'INR')}/sqft</td>
                                <td className="p-3 text-center border-l border-slate-600">-</td>
                                <td className="p-3 text-right border-l border-slate-600">{formatCurrency(grandTotalPerScreen, 'INR', false)}</td>
                                <td className="p-3 text-right border-l border-slate-600">{formatCurrency(grandTotal, 'INR', false)}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            );
        };
        const QuoteCalculator = ({ user, inventory, transactions, state, setState, exchangeRate, setExchangeRate, onSaveQuote }) => {
            const {
                client, project, screenQty, targetWidth, targetHeight, unit, 
                selectedIndoor, assemblyMode, sizingMode, margin, extras, overrides, editingRow
            } = state;

            const [calculation, setCalculation] = React.useState(null);
const [allScreensTotal, setAllScreensTotal] = React.useState(null);
const [showPreview, setShowPreview] = React.useState(false);
            const [showStock, setShowStock] = React.useState(false);
            const [showBOM, setShowBOM] = React.useState(false);
            const [bomTab, setBomTab] = React.useState('interactive');

            // Logic Helpers
            const getStock = (id) => transactions ? transactions.filter(t => t.itemId === id).reduce((acc, t) => acc + (t.type === 'in' ? Number(t.qty) : -Number(t.qty)), 0) : 0;
            const updateState = (key, value) => setState(prev => ({ ...prev, [key]: value }));
            const updateExtra = (key, field, val) => {
    const activeIndex = state.activeScreenIndex;
    setState(prev => {
        const newScreens = [...prev.screens];
        newScreens[activeIndex] = {
            ...newScreens[activeIndex],
            extras: {
                ...newScreens[activeIndex].extras,
                [key]: {
                    ...newScreens[activeIndex].extras[key],
                    [field]: val
                }
            }
        };
        return { ...prev, screens: newScreens };
    });
};

            const handleReset = () => {
    if (confirm("Reset calculator to defaults?")) {
        setState({
            client: '', project: '', unit: 'ft',
            screens: [
    {
        id: generateId(),
        screenQty: 0,
        targetWidth: 0,
        targetHeight: 0,
        selectedIndoor: 'true',
        assemblyMode: 'assembled',
        selectedPitch: '',
        selectedModuleId: '',
        selectedCabinetId: '',
        selectedCardId: '',
        selectedPSUId: '',
        selectedProcId: '',
        sizingMode: 'closest',
        readyId: '',
        extraComponents: [],
        overrides: {},
        editingRow: null,
        extras: {
            assembly: { val: 0, type: 'abs' },
            hardware: { val: 0, type: 'abs' },
            packaging: { val: 0, type: 'abs' },
            transport: { val: 0, type: 'abs' },
            install: { val: 0, type: 'abs' },
            wastage: { val: 0, type: 'abs' },
            overheads: { val: 0, type: 'abs' },
            structure: { val: 0, type: 'abs' }
        },
        commercials: {
            processor: {val: 0, unit: 'screen'},
            installation: {val: 0, unit: 'sqft'},
            structure: {val: 0, unit: 'sqft'}
        }
    }
],
            activeScreenIndex: 0,
            selectedIndoor: 'true', assemblyMode: 'assembled', selectedPitch: '',
            selectedModuleId: '', selectedCabinetId: '', selectedCardId: '',
            selectedPSUId: '', selectedProcId: '', sizingMode: 'closest', readyId: '',
            margin: 0, pricingMode: 'margin', targetSellPrice: 0,
            extraComponents: [],
            commercials: { 
                processor: {val: 0, unit: 'screen'}, 
                installation: {val: 0, unit: 'sqft'}, 
                structure: {val: 0, unit: 'sqft'} 
            },
            terms: {
                price: 'Ex-works Mumbai',
                deliveryWeeks: 10,
                payment: [
                    { name: "Advance with order", percent: 60 },
                    { name: "Before dispatch", percent: 30 },
                    { name: "After installation", percent: 10 }
                ]
            },
            extras: {
                assembly: { val: 0, type: 'abs' }, 
                hardware: { val: 0, type: 'abs' }, 
                packaging: { val: 0, type: 'abs' }, 
                transport: { val: 0, type: 'abs' }, 
                install: { val: 0, type: 'abs' }, 
                wastage: { val: 0, type: 'abs' }, 
                overheads: { val: 0, type: 'abs' }, 
                structure: { val: 0, type: 'abs' } 
            },
            overrides: {},
            editingRow: null
        });
    }
};
// Screen Management Functions
const addScreen = () => {
    const newScreen = {
        id: generateId(),
        screenQty: 1,
        targetWidth: 0,
        targetHeight: 0,
        selectedIndoor: state.selectedIndoor,
        assemblyMode: state.assemblyMode,
        selectedPitch: '',
        selectedModuleId: '',
        selectedCabinetId: '',
        selectedCardId: '',
        selectedPSUId: '',
        selectedProcId: '',
        sizingMode: 'closest',
        readyId: '',
        extraComponents: [],
        overrides: {},
        editingRow: null,
        extras: {
            assembly: { val: 0, type: 'abs' },
            hardware: { val: 0, type: 'abs' },
            packaging: { val: 0, type: 'abs' },
            transport: { val: 0, type: 'abs' },
            install: { val: 0, type: 'abs' },
            wastage: { val: 0, type: 'abs' },
            overheads: { val: 0, type: 'abs' },
            structure: { val: 0, type: 'abs' }
        },
        commercials: {
            processor: {val: 0, unit: 'screen'},
            installation: {val: 0, unit: 'sqft'},
            structure: {val: 0, unit: 'sqft'}
        }
    };
    setState(prev => ({
        ...prev,
        screens: [...prev.screens, newScreen],
        activeScreenIndex: prev.screens.length
    }));
};

const removeScreen = (index) => {
    if (state.screens.length === 1) {
        alert("Cannot remove the last screen configuration.");
        return;
    }
    if (confirm("Remove this screen configuration?")) {
        setState(prev => ({
            ...prev,
            screens: prev.screens.filter((_, i) => i !== index),
            activeScreenIndex: Math.min(prev.activeScreenIndex, prev.screens.length - 2)
        }));
    }
};

const updateScreenProp = (index, key, value) => {
    setState(prev => {
        const newScreens = [...prev.screens];
        newScreens[index] = { ...newScreens[index], [key]: value };
        return { ...prev, screens: newScreens };
    });
};

const duplicateScreen = (index) => {
    const screenToDup = state.screens[index];
    const newScreen = {
        ...screenToDup,
        id: generateId(),
        overrides: {},
        editingRow: null
    };
    setState(prev => ({
        ...prev,
        screens: [...prev.screens, newScreen],
        activeScreenIndex: prev.screens.length
    }));
};
            // Override Handlers
            const handleOverride = (id, field, value) => {
                setState(prev => ({
                    ...prev, overrides: { ...prev.overrides, [id]: { ...prev.overrides[id], [field]: value } }
                }));
            };

            const clearOverride = (id) => {
                const newOverrides = { ...overrides };
                delete newOverrides[id];
                updateState('overrides', newOverrides);
                updateState('editingRow', null);
            };
// Calculate totals across all screens
const calculateAllScreens = () => {
    if (!state.screens || state.screens.length === 0) return null;
    
    const allCalculations = state.screens.map((screen, index) => {
        const calcState = {
    ...state,
    screenQty: screen.screenQty,
    targetWidth: screen.targetWidth,
    targetHeight: screen.targetHeight,
    selectedPitch: screen.selectedPitch,
    selectedModuleId: screen.selectedModuleId,
    selectedCabinetId: screen.selectedCabinetId,
    selectedCardId: screen.selectedCardId,
    selectedPSUId: screen.selectedPSUId,
    selectedProcId: screen.selectedProcId,
    sizingMode: screen.sizingMode,
    readyId: screen.readyId,
    extraComponents: screen.extraComponents,
    overrides: screen.overrides,
    editingRow: screen.editingRow,
    extras: screen.extras,
    commercials: screen.commercials
};
        return calculateBOM(calcState, inventory, transactions, exchangeRate);
    }).filter(calc => calc !== null);
    
    if (allCalculations.length === 0) return null;
    
    // Aggregate totals
const totals = {
    totalProjectCost: allCalculations.reduce((sum, calc) => sum + calc.totalProjectCost, 0),
    totalProjectSell: allCalculations.reduce((sum, calc) => sum + calc.totalProjectSell, 0),
    totalLEDSell: allCalculations.reduce((sum, calc) => sum + (calc.matrix.led.sell * calc.screenQty), 0),
    totalServicesSell: allCalculations.reduce((sum, calc) => sum + (calc.matrix.sell.total - (calc.matrix.led.sell * calc.screenQty)), 0),
    totalMargin: 0,
    totalScreenQty: allCalculations.reduce((sum, calc) => sum + calc.screenQty, 0),
    calculations: allCalculations,
    screenConfigs: state.screens // Include screen configs for BOM display
};
    
    totals.totalMargin = totals.totalProjectSell - totals.totalProjectCost;
    
    return totals;
};
            // Real-time Calculation - Calculate for Active Screen
React.useEffect(() => {
    if (!state.screens || state.screens.length === 0) {
        setCalculation(null);
        return;
    }
    
    const activeScreen = state.screens[state.activeScreenIndex];
    if (!activeScreen) {
        setCalculation(null);
        return;
    }
    
    // Merge active screen properties with global state for calculation
const calcState = {
    ...state,
    screenQty: activeScreen.screenQty,
    targetWidth: activeScreen.targetWidth,
    targetHeight: activeScreen.targetHeight,
    selectedPitch: activeScreen.selectedPitch,
    selectedModuleId: activeScreen.selectedModuleId,
    selectedCabinetId: activeScreen.selectedCabinetId,
    selectedCardId: activeScreen.selectedCardId,
    selectedPSUId: activeScreen.selectedPSUId,
    selectedProcId: activeScreen.selectedProcId,
    sizingMode: activeScreen.sizingMode,
    readyId: activeScreen.readyId,
    extraComponents: activeScreen.extraComponents,
    overrides: activeScreen.overrides,
    editingRow: activeScreen.editingRow,
    extras: activeScreen.extras,
    commercials: activeScreen.commercials
};
    
    const result = calculateBOM(calcState, inventory, transactions, exchangeRate);
    setCalculation(result);
}, [state.screens, state.activeScreenIndex, state.unit, state.selectedIndoor, state.assemblyMode, state.margin, state.extras, inventory, exchangeRate, state.pricingMode, state.targetSellPrice, state.commercials, state.terms]);
// Calculate totals across all screens
React.useEffect(() => {
    const totals = calculateAllScreens();
    setAllScreensTotal(totals);
}, [state.screens, state.unit, state.selectedIndoor, state.assemblyMode, state.margin, state.extras, inventory, exchangeRate, state.pricingMode, state.targetSellPrice, state.commercials, state.terms]);

            // Profit Color Logic
            const profit = calculation ? calculation.matrix.margin.total : 0;
            const profitColor = profit >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400';

            return (
                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6 relative items-start">
                    
                    {/* --- Interactive BOM Modal --- */}
{showBOM && (calculation || allScreensTotal) && (
    <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
        <div className="bg-white dark:bg-slate-900 max-w-5xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div className="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-slate-50 dark:bg-slate-800">
                <div className="flex items-center gap-4">
                    <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2">
                        <FileText size={20} className="text-teal-600"/> Cost Sheet (BOM)
                        {state.screens.length > 1 && (
                            <span className="text-xs font-normal text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-teal-900/30 px-2 py-1 rounded">
                                {state.screens.length} Configurations
                            </span>
                        )}
                    </h2>
                </div>
                <div className="flex gap-2">
                    <button onClick={() => setShowBOM(false)} className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded text-sm font-bold">Close</button>
                    <button onClick={() => window.print()} className="px-4 py-2 bg-slate-800 text-white hover:bg-slate-700 rounded flex items-center gap-2 text-sm font-bold"><Printer size={16}/> Print</button>
                </div>
            </div>
            <div className="flex-1 overflow-auto bg-slate-100 dark:bg-slate-800 p-8 flex justify-center">
                <BOMLayout 
                    data={calculation ? {...calculation, clientName: client, projectName: project} : null}
                    allScreensData={allScreensTotal ? {
                        ...allScreensTotal,
                        clientName: client,
                        projectName: project,
                        screenConfigs: state.screens.map(s => ({
                            targetWidth: s.targetWidth,
                            targetHeight: s.targetHeight,
                            unit: unit
                        }))
                    } : null}
                />
            </div>
        </div>
    </div>
)}

                    {/* --- Other Modals --- */}
                    {showPreview && calculation && (
                        <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
                            <div className="bg-white max-w-4xl w-full h-[90vh] rounded-lg shadow-2xl flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-slate-100 rounded-t-lg">
                                    <h2 className="font-bold text-lg text-slate-800 flex items-center gap-2"><Eye size={20} /> Print Preview</h2>
                                    <div className="flex gap-2">
                                        <button onClick={() => setShowPreview(false)} className="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded">Close</button>
                                        <button onClick={() => window.print()} className="px-4 py-2 bg-teal-600 text-white hover:bg-teal-700 rounded flex items-center gap-2"><Printer size={16} /> Print / Save PDF</button>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-auto p-8 bg-slate-200">
                                    <PrintLayout data={{ ...calculation, clientName: client, projectName: project, margin }} currency='INR' exchangeRate={exchangeRate} />
                                </div>
                            </div>
                       </div>
                    )}
                     {showStock && calculation && (
    <div className="fixed inset-0 z-[100] bg-black/80 flex justify-center items-center p-4">
        <div className="bg-white dark:bg-slate-900 max-w-2xl w-full rounded-lg shadow-2xl flex flex-col">
            <div className="p-4 border-b flex justify-between items-center bg-slate-100 dark:bg-slate-800 rounded-t-lg">
                <h2 className="font-bold text-lg text-slate-800 dark:text-white flex items-center gap-2"><Box size={20} className="text-teal-600"/> Stock Availability</h2>
                <button onClick={() => setShowStock(false)} className="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700 rounded">Close</button>
            </div>
            <div className="p-6 overflow-auto">
                <table className="w-full text-sm text-left border border-slate-200 dark:border-slate-700 rounded">
                    <thead className="bg-slate-50 dark:bg-slate-800 text-slate-600 dark:text-slate-300 uppercase font-bold text-xs">
                        <tr>
                            <th className="px-4 py-2">Component</th>
                            <th className="px-4 py-2 text-center">Required</th>
                            <th className="px-4 py-2 text-center">Stock</th>
                            <th className="px-4 py-2 text-center">Balance</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100 dark:divide-slate-700 bg-white dark:bg-slate-800">
                        {calculation.detailedItems.map((item, i) => {
                            const reqQty = item.qty * calculation.screenQty;
                            const stock = item.inventoryId ? getStock(item.inventoryId) : 0;
                            const balance = stock - reqQty;
                            return (
                                <tr key={i} className="hover:bg-slate-50 dark:hover:bg-slate-700/50">
                                    <td className="px-4 py-2">
                                        <div className="font-medium text-slate-800 dark:text-slate-200">{item.name}</div>
                                        <div className="text-xs text-slate-500 dark:text-slate-400">{item.spec}</div>
                                    </td>
                                    <td className="px-4 py-2 text-center font-bold dark:text-slate-200">{reqQty}</td>
                                    <td className="px-4 py-2 text-center text-slate-600 dark:text-slate-400">{stock}</td>
                                    <td className={`px-4 py-2 text-center font-bold ${balance >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                                        {balance}
                                    </td>
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
)}

                    {/* --- LEFT COLUMN (Inputs) --- */}
                    <div className="lg:col-span-8 space-y-6">

                        {/* 1. Project Specs Card */}
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700 overflow-hidden">
                            <div className="bg-slate-50/50 dark:bg-slate-800/50 px-6 py-4 border-b border-slate-100 dark:border-slate-700 flex justify-between items-center">
                                <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2"><Settings className="w-4 h-4 text-teal-600" /> Project Specs</h3>
                                <div className="flex items-center gap-2">
                                    <button onClick={handleReset} className="text-[10px] font-bold text-red-500 hover:text-red-700 uppercase hover:bg-red-50 dark:hover:bg-red-900/20 px-2 py-1 rounded transition-colors mr-2 flex items-center gap-1"><RefreshCw size={10}/> Reset</button>
                                    <div className="flex bg-slate-200 dark:bg-slate-700 rounded-lg p-0.5">
                                        <button onClick={() => updateState('unit', 'm')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${unit === 'm' ? 'bg-white dark:bg-slate-600 shadow text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400'}`}>M</button>
                                        <button onClick={() => updateState('unit', 'ft')} className={`px-3 py-1 text-xs font-bold rounded-md transition-all ${unit === 'ft' ? 'bg-white dark:bg-slate-600 shadow text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400'}`}>FT</button>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="p-6 space-y-6">
    {/* Client & Project */}
    <div>
        <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Client & Project</label>
        <div className="grid grid-cols-2 gap-2">
            <input value={client} onChange={e => updateState('client', e.target.value)} placeholder="Client Name" className="w-full p-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm outline-none focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all dark:text-white" />
            <input value={project} onChange={e => updateState('project', e.target.value)} placeholder="Project Ref" className="w-full p-2.5 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg text-sm outline-none focus:ring-2 focus:ring-teal-500/20 focus:border-teal-500 transition-all dark:text-white" />
        </div>
    </div>

    {/* Global Settings */}
    <div className="grid grid-cols-2 gap-4">
        <div>
            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Application</label>
            <div className="grid grid-cols-2 gap-2">
                <button onClick={() => { updateState('selectedIndoor', 'true'); }} className={`p-2 text-center text-sm border rounded-lg font-medium transition-all ${selectedIndoor === 'true' ? 'bg-teal-50 dark:bg-teal-900/30 border-teal-500 text-teal-700 dark:text-teal-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Indoor</button>
                <button onClick={() => { updateState('selectedIndoor', 'false'); }} className={`p-2 text-center text-sm border rounded-lg font-medium transition-all ${selectedIndoor === 'false' ? 'bg-teal-50 dark:bg-teal-900/30 border-teal-500 text-teal-700 dark:text-teal-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Outdoor</button>
            </div>
        </div>
        <div>
            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Supply Type</label>
            <div className="grid grid-cols-2 gap-2">
                <button onClick={() => updateState('assemblyMode', 'assembled')} className={`p-2 text-center text-sm border rounded-lg font-medium transition-all ${assemblyMode === 'assembled' ? 'bg-teal-50 dark:bg-teal-900/30 border-teal-500 text-teal-700 dark:text-teal-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Assembled</button>
                <button onClick={() => updateState('assemblyMode', 'ready')} className={`p-2 text-center text-sm border rounded-lg font-medium transition-all ${assemblyMode === 'ready' ? 'bg-teal-50 dark:bg-teal-900/30 border-teal-500 text-teal-700 dark:text-teal-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}>Ready Unit</button>
            </div>
        </div>
    </div>

    {/* Screen Configurations */}
    <div>
        <div className="flex justify-between items-center mb-3">
            <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Screen Configurations</label>
            <button onClick={addScreen} className="text-xs font-bold text-teal-600 dark:text-teal-400 hover:text-teal-700 dark:hover:text-teal-300 flex items-center gap-1">
                <Plus size={14} /> Add Size
            </button>
        </div>
        
        <div className="space-y-3">
            {state.screens.map((screen, index) => (
                <div key={screen.id} className={`p-4 rounded-lg border-2 transition-all ${state.activeScreenIndex === index ? 'border-teal-500 bg-teal-50/50 dark:bg-teal-900/10' : 'border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-800'}`}>
                    <div className="flex justify-between items-start mb-3">
                        <div className="flex items-center gap-2">
                            <button 
                                onClick={() => updateState('activeScreenIndex', index)}
                                className={`px-2 py-1 rounded font-bold text-xs ${state.activeScreenIndex === index ? 'bg-teal-600 text-white' : 'bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300'}`}
                            >
                                #{index + 1}
                            </button>
                            <span className="text-xs text-slate-500 dark:text-slate-400">
                                {screen.targetWidth && screen.targetHeight ? `${screen.targetWidth}  ${screen.targetHeight} ${unit}` : 'Not configured'}
                            </span>
                        </div>
                        <div className="flex gap-1">
                            <button onClick={() => duplicateScreen(index)} className="p-1 text-slate-400 hover:text-teal-600 dark:hover:text-teal-400" title="Duplicate">
                                <Copy size={14} />
                            </button>
                            {state.screens.length > 1 && (
                                <button onClick={() => removeScreen(index)} className="p-1 text-slate-400 hover:text-red-600 dark:hover:text-red-400" title="Remove">
                                    <Trash2 size={14} />
                                </button>
                            )}
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-4 gap-2">
                        <div>
                            <span className="text-[10px] text-slate-400 font-semibold block mb-1">WIDTH</span>
                            <input 
                                type="number" 
                                value={screen.targetWidth} 
                                onChange={e => updateScreenProp(index, 'targetWidth', e.target.value)} 
                                className="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded text-sm font-bold text-slate-800" 
                            />
                        </div>
                        <div>
                            <span className="text-[10px] text-slate-400 font-semibold block mb-1">HEIGHT</span>
                            <input 
                                type="number" 
                                value={screen.targetHeight} 
                                onChange={e => updateScreenProp(index, 'targetHeight', e.target.value)} 
                                className="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded text-sm font-bold text-slate-800" 
                            />
                        </div>
                        <div>
                            <span className="text-[10px] text-teal-600 dark:text-teal-400 font-semibold block mb-1">QTY</span>
                            <input 
                                type="number" 
                                min="0" 
                                value={screen.screenQty} 
                                onChange={e => updateScreenProp(index, 'screenQty', Math.max(0, parseInt(e.target.value)) || 0)} 
                                className="w-full p-2 border border-teal-200 dark:border-teal-800 bg-teal-50 dark:bg-teal-900/30 text-teal-800 dark:text-teal-200 rounded text-sm font-bold" 
                            />
                        </div>
                        <div>
                            <span className="text-[10px] text-slate-400 font-semibold block mb-1">SIZING</span>
                            <select 
                                value={screen.sizingMode} 
                                onChange={e => updateScreenProp(index, 'sizingMode', e.target.value)}
                                className="w-full p-2 border border-slate-200 dark:border-slate-600 dark:bg-slate-700 dark:text-white rounded text-xs"
                            >
                                <option value="closest">Closest</option>
                                <option value="up">Round Up</option>
                                <option value="down">Round Down</option>
                            </select>
                        </div>
                    </div>
                </div>
            ))}
        </div>
    </div>
</div>
                        </div>

                        {/* 2. Detailed Cost & Selection Table */}
                        {/* 2. Detailed Cost & Selection Table - Carousel for Multiple Screens */}
<div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
    <details className="group p-4" open>
        <summary className="flex justify-between items-center cursor-pointer list-none">
            <h3 className="font-bold text-slate-800 dark:text-white flex items-center gap-2">
                <Box className="w-4 h-4 text-teal-600" /> Hardware & Cost Breakdown
                {state.screens.length > 1 && (
                    <span className="text-xs font-normal text-slate-500 dark:text-slate-400">
                        (Screen #{state.activeScreenIndex + 1} of {state.screens.length})
                    </span>
                )}
            </h3>
            <div className="flex items-center gap-2">
                <span className="text-teal-600 text-xs font-bold group-open:hidden">Show Table</span>
                <span className="text-slate-400 text-xs hidden group-open:block">Hide Table</span>
            </div>
        </summary>
        <div className="mt-4 pt-4 border-t border-slate-100 dark:border-slate-700">
            {/* Screen Navigation Tabs */}
            {state.screens.length > 1 && (
                <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                    {state.screens.map((screen, index) => {
                        const isActive = state.activeScreenIndex === index;
                        const screenLabel = screen.targetWidth && screen.targetHeight 
                            ? `${screen.targetWidth}${screen.targetHeight}${unit} (${screen.screenQty})`
                            : `Screen #${index + 1}`;
                        
                        return (
                            <button
                                key={screen.id}
                                onClick={() => updateState('activeScreenIndex', index)}
                                className={`flex-shrink-0 px-4 py-2 rounded-lg text-xs font-bold transition-all ${
                                    isActive 
                                        ? 'bg-teal-600 text-white shadow-lg' 
                                        : 'bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-600'
                                }`}
                            >
                                <div className="flex items-center gap-2">
                                    <span>#{index + 1}</span>
                                    <span className="text-[10px] opacity-75">{screenLabel}</span>
                                </div>
                            </button>
                        );
                    })}
                </div>
            )}
            
            {/* Active Screen Details */}
            {state.screens[state.activeScreenIndex] && (
                <div className="mb-4 p-3 bg-slate-50 dark:bg-slate-700/30 rounded-lg border border-slate-200 dark:border-slate-600">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                        <div>
                            <span className="text-slate-500 dark:text-slate-400 font-semibold">Dimensions:</span>
                            <span className="ml-2 font-bold text-slate-800 dark:text-white">
                                {state.screens[state.activeScreenIndex].targetWidth || 0}  {state.screens[state.activeScreenIndex].targetHeight || 0} {unit}
                            </span>
                        </div>
                        <div>
                            <span className="text-slate-500 dark:text-slate-400 font-semibold">Quantity:</span>
                            <span className="ml-2 font-bold text-teal-600 dark:text-teal-400">
                                {state.screens[state.activeScreenIndex].screenQty || 0} screens
                            </span>
                        </div>
                        <div>
                            <span className="text-slate-500 dark:text-slate-400 font-semibold">Sizing:</span>
                            <span className="ml-2 font-bold text-slate-800 dark:text-white capitalize">
                                {state.screens[state.activeScreenIndex].sizingMode}
                            </span>
                        </div>
                        {calculation && (
                            <div>
                                <span className="text-slate-500 dark:text-slate-400 font-semibold">Final Size:</span>
                                <span className="ml-2 font-bold text-slate-800 dark:text-white">
                                    {calculation.finalWidth}  {calculation.finalHeight} m
                                </span>
                            </div>
                        )}
                    </div>
                </div>
            )}
            
            <InteractiveCostSheet 
                calculation={calculation} 
                state={state}
                updateState={updateState}
                updateExtra={updateExtra}
                updateScreenProp={updateScreenProp}
                inventory={inventory}
                getStock={getStock}
                overrides={state.screens[state.activeScreenIndex]?.overrides || {}}
                onOverride={(id, field, value) => {
                    const screen = state.screens[state.activeScreenIndex];
                    updateScreenProp(state.activeScreenIndex, 'overrides', {
                        ...screen.overrides,
                        [id]: { ...screen.overrides[id], [field]: value }
                    });
                }}
                editingRow={state.screens[state.activeScreenIndex]?.editingRow}
                setEditingRow={(id) => updateScreenProp(state.activeScreenIndex, 'editingRow', id)}
                onClearOverride={(id) => {
                    const screen = state.screens[state.activeScreenIndex];
                    const newOverrides = { ...screen.overrides };
                    delete newOverrides[id];
                    updateScreenProp(state.activeScreenIndex, 'overrides', newOverrides);
                    updateScreenProp(state.activeScreenIndex, 'editingRow', null);
                }}
            />
        </div>
    </details>
</div>

                        {/* 4. Terms */}
                        <div className="bg-white dark:bg-slate-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-700">
                            <details className="group p-4">
                                <summary className="flex justify-between items-center cursor-pointer list-none">
                                    <span className="text-sm font-bold text-slate-600 dark:text-slate-300">Terms & Conditions</span>
                                    <span className="text-teal-600 text-xs group-open:hidden">Show Details</span>
                                </summary>
                                <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t border-slate-100 dark:border-slate-700">
                                    <div><label className="text-[10px] uppercase font-bold text-slate-400">Price Basis</label><input value={state.terms?.price} onChange={e => setState(p => ({...p, terms: {...p.terms, price: e.target.value}}))} className="w-full p-2 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white" /></div>
                                    <div><label className="text-[10px] uppercase font-bold text-slate-400">Delivery Weeks</label><input type="number" value={state.terms?.deliveryWeeks} onChange={e => setState(p => ({...p, terms: {...p.terms, deliveryWeeks: e.target.value}}))} className="w-full p-2 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white" /></div>
                                    <div className="col-span-1 md:col-span-2">
                                         <label className="text-[10px] uppercase font-bold text-slate-400 block mb-2">Payment Milestones</label>
                                         {(state.terms?.payment || []).map((ms, idx) => (
                                            <div key={idx} className="flex gap-2 mb-2">
                                                <input value={ms.name} onChange={e => { const n = [...state.terms.payment]; n[idx].name = e.target.value; setState(p => ({...p, terms: {...p.terms, payment: n}})); }} className="flex-1 p-2 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="Milestone Name" />
                                                <input type="number" value={ms.percent} onChange={e => { const n = [...state.terms.payment]; n[idx].percent = Number(e.target.value); setState(p => ({...p, terms: {...p.terms, payment: n}})); }} className="w-16 p-2 border rounded text-xs dark:bg-slate-700 dark:border-slate-600 dark:text-white" placeholder="%" />
                                                <button onClick={() => { const n = state.terms.payment.filter((_, i) => i !== idx); setState(p => ({...p, terms: {...p.terms, payment: n}})); }} className="text-red-400"><X size={14} /></button>
                                            </div>
                                         ))}
                                         <button onClick={() => setState(p => ({...p, terms: {...p.terms, payment: [...(p.terms.payment || []), {name: '', percent: 0}]}}))} className="text-xs text-teal-600 font-bold">+ Add Milestone</button>
                                    </div>
                                </div>
                            </details>
                        </div>
                        <div className="h-10"></div>
                    </div>

                    {/* --- RIGHT COLUMN (Sticky Sidebar) --- */}
                    <div className="lg:col-span-4 space-y-6 lg:sticky lg:top-24">
                        
                        {/* Financial Summary (Moved Up) */}
<div className="bg-white dark:bg-slate-800 rounded-xl shadow-lg border border-slate-200 dark:border-slate-700 overflow-hidden">
    <div className="p-5 bg-gradient-to-br from-slate-50 to-white dark:from-slate-700 dark:to-slate-800">
        {/* Multi-Screen Summary Header */}
        {state.screens.length > 1 && allScreensTotal && (
            <div className="mb-4 pb-4 border-b border-slate-200 dark:border-slate-600">
                <div className="text-[10px] uppercase font-bold text-slate-400 mb-2">Project Summary</div>
                <div className="grid grid-cols-2 gap-2 text-xs">
                    <div className="bg-blue-50 dark:bg-blue-900/20 p-2 rounded">
                        <div className="text-[10px] text-blue-600 dark:text-blue-400 font-semibold">Screen Types</div>
                        <div className="font-bold text-blue-800 dark:text-blue-300">{state.screens.length}</div>
                    </div>
                    <div className="bg-teal-50 dark:bg-teal-900/20 p-2 rounded">
                        <div className="text-[10px] text-teal-600 dark:text-teal-400 font-semibold">Total Qty</div>
                        <div className="font-bold text-teal-800 dark:text-teal-300">{allScreensTotal.totalScreenQty}</div>
                    </div>
                </div>
            </div>
        )}
        
        <div className="flex justify-between items-center mb-2">
            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Margin Strategy</label>
            <select 
                value={state.pricingMode || 'margin'} 
                onChange={e => {
                    const newMode = e.target.value;
                    updateState('pricingMode', newMode);
                    if (newMode !== 'margin' && calculation) {
                        let newTarget = 0;
                        if (newMode === 'screen') newTarget = calculation.matrix.sell.unit;
                        else if (newMode === 'sqft') newTarget = calculation.matrix.sell.sqft;
                        else if (newMode === 'sqm') newTarget = calculation.matrix.sell.sqft * 10.7639;
                        updateState('targetSellPrice', Math.round(newTarget));
                    }
                }}
                className="text-xs border-none bg-transparent font-bold text-teal-600 dark:text-teal-400 focus:ring-0 cursor-pointer outline-none"
            >
                <option value="margin">Margin %</option>
                <option value="sqft">Price / Sq.Ft</option>
                <option value="sqm">Price / Sq.Mtr</option>
                <option value="screen">Price / Screen</option>
            </select>
        </div>
        
        <div className="flex items-center gap-2 mb-6">
            <input 
                type="number" 
                value={state.pricingMode === 'margin' ? margin : state.targetSellPrice}
                onChange={e => {
                    const val = parseFloat(e.target.value) || 0;
                    if (state.pricingMode === 'margin') updateState('margin', val);
                    else updateState('targetSellPrice', val);
                }}
                className="w-24 text-center text-xl font-bold p-2 border rounded-lg bg-white dark:bg-slate-600 dark:border-slate-500 shadow-sm focus:ring-2 focus:ring-teal-500/50 outline-none dark:text-white" 
            />
            <span className="text-lg font-bold text-slate-400">{state.pricingMode === 'margin' ? '%' : ''}</span>
            <div className="flex-1 text-right">
                 <div className="text-[10px] text-slate-400 uppercase font-bold">
                     {state.screens.length > 1 ? 'Total Profit' : 'Est. Profit'}
                 </div>
                 <div className={`text-sm font-bold ${(allScreensTotal ? allScreensTotal.totalMargin : (calculation?.matrix.margin.total || 0)) >= 0 ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`}>
                     {allScreensTotal 
                         ? formatCurrency(allScreensTotal.totalMargin, 'INR') 
                         : (calculation ? formatCurrency(calculation.matrix.margin.total, 'INR') : '-')}
                 </div>
            </div>
        </div>

        <div className="space-y-3 pt-4 border-t border-slate-100 dark:border-slate-600">
            {state.screens.length > 1 ? (
                // Multi-Screen Breakdown
                <>
                    <div className="flex justify-between items-end">
                        <span className="text-sm text-slate-500 dark:text-slate-400">LED Panels (All)</span>
                        <span className="font-bold text-slate-800 dark:text-white">
                            {allScreensTotal ? formatCurrency(allScreensTotal.totalLEDSell, 'INR') : '-'}
                        </span>
                    </div>
                    <div className="flex justify-between items-end">
                        <span className="text-sm text-slate-500 dark:text-slate-400">Services & Extras</span>
                        <span className="font-bold text-slate-800 dark:text-white">
                            {allScreensTotal ? formatCurrency(allScreensTotal.totalServicesSell, 'INR') : '-'}
                        </span>
                    </div>
                    
                    {/* Individual Screen Costs (Collapsible) */}
                    <details className="group">
                        <summary className="text-[10px] text-teal-600 dark:text-teal-400 font-bold uppercase cursor-pointer hover:underline">
                            View Screen Breakdown
                        </summary>
                        <div className="mt-2 space-y-2 pl-2 border-l-2 border-slate-200 dark:border-slate-600">
                            {allScreensTotal?.calculations.map((calc, index) => (
                                <div key={index} className="text-xs">
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-500 dark:text-slate-400">
                                            Screen #{index + 1} 
                                            <span className="text-[10px] ml-1">
                                                ({state.screens[index].targetWidth}{state.screens[index].targetHeight}{unit} {calc.screenQty})
                                            </span>
                                        </span>
                                        <span className="font-bold text-slate-700 dark:text-slate-300">
                                            {formatCurrency(calc.totalProjectSell, 'INR')}
                                        </span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </details>
                </>
            ) : (
                // Single Screen Breakdown
                <>
                    <div className="flex justify-between items-end">
                        <span className="text-sm text-slate-500 dark:text-slate-400">LED Panel Price</span>
                        <span className="font-bold text-slate-800 dark:text-white">
                            {calculation ? formatCurrency(calculation.matrix.led.sell * calculation.screenQty, 'INR') : '-'}
                        </span>
                    </div>
                    <div className="flex justify-between items-end">
                        <span className="text-sm text-slate-500 dark:text-slate-400">Services & Extras</span>
                        <span className="font-bold text-slate-800 dark:text-white">
                            {calculation ? formatCurrency((calculation.matrix.sell.total - (calculation.matrix.led.sell * calculation.screenQty)), 'INR') : '-'}
                        </span>
                    </div>
                    <div className="flex justify-between items-end pt-2 mt-2 border-t border-dashed border-slate-200 dark:border-slate-600">
                        <span className="text-sm font-bold text-slate-600 dark:text-slate-300">Rate / Sq.Ft</span>
                        <span className="font-bold text-slate-500 dark:text-slate-400">
                            {calculation ? formatCurrency(calculation.matrix.sell.sqft, 'INR') : '-'}
                        </span>
                    </div>
                </>
            )}
        </div>
    </div>
    
    <div className="bg-slate-900 p-5 text-white">
        <div className="flex justify-between items-center mb-1">
            <span className="text-sm text-slate-400">Grand Total (Ex. GST)</span>
            {state.screens.length > 1 && (
                <span className="text-xs text-teal-400 font-bold">{allScreensTotal?.totalScreenQty || 0} screens</span>
            )}
        </div>
        <div className="flex justify-between items-baseline">
            <span className="text-3xl font-bold tracking-tight">
                {allScreensTotal 
                    ? formatCurrency(allScreensTotal.totalProjectSell, 'INR') 
                    : (calculation ? formatCurrency(calculation.totalProjectSell, 'INR') : '-')}
            </span>
        </div>
        <button 
            onClick={() => onSaveQuote(allScreensTotal ? allScreensTotal.totalProjectSell : calculation?.totalProjectSell)} 
            className="w-full mt-4 py-3 bg-teal-600 hover:bg-teal-500 text-white font-bold rounded-lg shadow-lg shadow-teal-900/20 transition-all flex justify-center items-center gap-2"
        >
            <Save size={18} /> Save Quote
        </button>
    </div>
</div>

                        {/* Visualizer (Moved Down) */}
                        <div className="bg-slate-900 rounded-xl shadow-lg p-6 text-white overflow-hidden relative min-h-[250px] flex items-center justify-center">
                            {calculation ? (
                                <div className="w-full h-full flex items-center justify-center p-4">
                                    <ScreenVisualizer cols={calculation.gridCols} rows={calculation.gridRows} module={calculation.moduleType} cabinet={calculation.cabinetType} unit={unit} />
                                </div>
                            ) : (
                                <div className="text-slate-500 flex flex-col items-center"><Monitor size={32} className="mb-2 opacity-50"/><span>Enter dimensions</span></div>
                            )}
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3">
                             <button onClick={() => setShowBOM(true)} className="p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 flex flex-col items-center justify-center gap-1 transition-colors">
                                <FileText size={16} className="text-blue-500" /> <span className="text-[10px]">BOM</span>
                             </button>
                             <button onClick={() => setShowPreview(true)} className="p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 flex flex-col items-center justify-center gap-1 transition-colors">
                                <Printer size={16} /> <span className="text-[10px]">Print</span>
                             </button>
                             <button onClick={() => setShowStock(true)} className="p-3 rounded-lg border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 text-sm font-medium text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-slate-700 flex flex-col items-center justify-center gap-1 transition-colors">
                                <Box size={16} className="text-teal-500" /> <span className="text-[10px]">Stock</span>
                             </button>
                        </div>
                    </div>
                </div>
            );
        };

        // 6. Main App
        const App = () => {
            const [user, setUser] = React.useState(null);
            const [view, setView] = React.useState('quote');
            const [inventory, setInventory] = React.useState([]);
            const [transactions, setTransactions] = React.useState([]);
            const [darkMode, setDarkMode] = React.useState(false);
            const [exchangeRate, setExchangeRate] = React.useState(84);

            // Initial State
            const initialCalcState = {
    client: '', project: '', unit: 'm',
    screens: [
        {
            id: generateId(),
            screenQty: 0,
            targetWidth: 0,
            targetHeight: 0,
            selectedIndoor: 'true',
            assemblyMode: 'assembled',
            selectedPitch: '',
            selectedModuleId: '',
            selectedCabinetId: '',
            selectedCardId: '',
            selectedPSUId: '',
            selectedProcId: '',
            sizingMode: 'closest',
            readyId: '',
            extraComponents: [],
            overrides: {},
            editingRow: null,
            extras: {
                assembly: { val: 0, type: 'abs' },
                hardware: { val: 0, type: 'abs' },
                packaging: { val: 0, type: 'abs' },
                transport: { val: 0, type: 'abs' },
                install: { val: 0, type: 'abs' },
                wastage: { val: 0, type: 'abs' },
                overheads: { val: 0, type: 'abs' },
                structure: { val: 0, type: 'abs' }
            },
            commercials: {
                processor: {val: 0, unit: 'screen'},
                installation: {val: 0, unit: 'sqft'},
                structure: {val: 0, unit: 'sqft'}
            }
        }
    ],
    activeScreenIndex: 0,
    selectedIndoor: 'true', assemblyMode: 'assembled', selectedPitch: '',
                selectedModuleId: '', selectedCabinetId: '', selectedCardId: '',
                selectedPSUId: '', selectedProcId: '', sizingMode: 'closest', readyId: '',
                margin: 0, targetSellPrice: 0, pricingMode: 'margin',
                commercials: { 
                    processor: {val: 0, unit: 'screen'}, 
                    installation: {val: 0, unit: 'sqft'}, 
                    structure: {val: 0, unit: 'sqft'} 
                },
                terms: {
                    price: 'Ex-works Mumbai',
                    deliveryWeeks: 10,
                    payment: [
                        { name: "Advance with order", percent: 60 },
                        { name: "Before dispatch", percent: 30 },
                        { name: "After installation", percent: 10 }
                    ]
                },
                extraComponents: [],
                extras: {
                    assembly: { val: 0, type: 'abs' },
                    hardware: { val: 0, type: 'abs' },
                    packaging: { val: 0, type: 'abs' },
                    transport: { val: 0, type: 'abs' },
                    install: { val: 0, type: 'abs' },
                    wastage: { val: 0, type: 'abs' },
                    overheads: { val: 0, type: 'abs' },
                    structure: { val: 0, type: 'abs' }
                },
                overrides: {},
                editingRow: null
            };

            const [calcState, setCalcState] = React.useState(initialCalcState);

            React.useEffect(() => {
                const init = async () => {
                    if (!isConfigured) return;
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }
                };
                init();
                if (isConfigured) auth.onAuthStateChanged(setUser);
            }, []);

            React.useEffect(() => {
                document.documentElement.classList.toggle('dark', darkMode);
            }, [darkMode]);

            React.useEffect(() => {
                if (!user || !db) return;
                const unsubInv = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('inventory')
                         .onSnapshot(snap => setInventory(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                const unsubTx = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('transactions')
                         .onSnapshot(snap => setTransactions(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                return () => { unsubInv(); unsubTx(); };
            }, [user]);

            const handleSaveQuote = async (finalAmount) => {
    if (!calcState.client || !calcState.project) return alert("Please enter Client and Project names.");
    
    // Calculate all screens data for saving
    const allScreensData = calculateAllScreens();
    
    try {
        await db.collection('artifacts').doc(appId).collection('public').doc('data').collection('quotes').add({
            client: calcState.client,
            project: calcState.project,
            calculatorState: calcState,
            finalAmount: finalAmount || 0,
            screenCount: calcState.screens.length,
            totalScreenQty: allScreensData?.totalScreenQty || 0,
            allScreensData: allScreensData, // Store complete calculations
            updatedAt: new Date()
        });
                    alert("Quote Saved Successfully!");
                } catch (e) { console.error(e); alert("Error saving quote."); }
            };

            const handleLoadQuote = (quote, isDuplicate) => {
                const newState = { ...quote.calculatorState };
                if (isDuplicate) {
                    newState.client = newState.client + ' (Copy)';
                    newState.project = newState.project + ' (Copy)';
                }
                setCalcState(newState);
                setView('quote');
            };

            if (!isConfigured) return <div className="p-10 text-center">Config Missing</div>;
            if (!user) return <div className="h-screen flex items-center justify-center bg-slate-50 dark:bg-slate-900"><div className="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-600"></div></div>;

            return (
                <div className="min-h-screen no-print pb-20 bg-slate-50 dark:bg-slate-900 transition-colors font-sans">
                    <nav className="bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 sticky top-0 z-50 px-4 md:px-6 h-16 flex items-center justify-between shadow-sm">
                        <div className="flex items-center gap-2">
                            <div className="bg-teal-50 dark:bg-teal-900/30 p-2 rounded-lg">
                                <Calculator className="w-5 h-5 text-teal-600 dark:text-teal-400" />
                            </div>
                            <span className="font-bold text-lg tracking-tight text-slate-900 dark:text-white">ADMIRE <span className="text-teal-600 dark:text-teal-400 font-medium">SIGNAGE</span></span>
                        </div>
                        
                        <div className="flex gap-4 items-center">
                            <div className="hidden md:flex gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                <button onClick={() => setView('quote')} className={`px-4 py-1.5 rounded-md text-sm font-semibold transition-all ${view === 'quote' ? 'bg-white dark:bg-slate-600 shadow-sm text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white'}`}>Calculator</button>
                                <button onClick={() => setView('inventory')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'inventory' ? 'bg-white dark:bg-slate-600 shadow-sm text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white'}`}>Inventory</button>
                                <button onClick={() => setView('ledger')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'ledger' ? 'bg-white dark:bg-slate-600 shadow-sm text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white'}`}>Stock</button>
                                <button onClick={() => setView('saved')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${view === 'saved' ? 'bg-white dark:bg-slate-600 shadow-sm text-teal-600 dark:text-teal-400' : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white'}`}>Quotes</button>
                            </div>
                            
                            <div className="flex items-center gap-2 pl-4 border-l border-slate-200 dark:border-slate-700">
                                <div className="flex items-center bg-slate-100 dark:bg-slate-700 rounded px-2 py-1" title="Exchange rate for USD items">
                                    <span className="text-[10px] text-slate-500 font-bold mr-1">$1=</span>
                                    <input type="number" value={exchangeRate} onChange={e => setExchangeRate(Number(e.target.value))} className="w-8 bg-transparent text-xs outline-none font-bold dark:text-white" />
                                </div>
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors">
                                    {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main className="max-w-[1600px] mx-auto p-4 md:p-6">
                        {view === 'inventory' && <InventoryManager user={user} transactions={transactions} />}
                        {view === 'ledger' && <InventoryLedger user={user} inventory={inventory} transactions={transactions} />}
                        {view === 'saved' && <SavedQuotesManager user={user} inventory={inventory} transactions={transactions} exchangeRate={exchangeRate} onLoadQuote={handleLoadQuote} />}
                        {view === 'quote' && (
                            <QuoteCalculator 
                                user={user} 
                                inventory={inventory}
                                transactions={transactions} 
                                state={calcState} 
                                setState={setCalcState}
                                exchangeRate={exchangeRate}
                                setExchangeRate={setExchangeRate}
                                onSaveQuote={handleSaveQuote}
                            />
                        )}
                    </main>

                    {/* Mobile Bottom Bar for Price */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 p-4 lg:hidden shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 flex items-center gap-4">
                        <div className="flex-1">
                            <div className="text-[10px] text-slate-500 dark:text-slate-400 font-bold uppercase">Total Estimate</div>
                            <div className="text-xl font-bold text-slate-900 dark:text-white">
                                {calcState.project && formatCurrency(calculateBOM(calcState, inventory, transactions, exchangeRate)?.totalProjectSell || 0, 'INR')}
                            </div>
                        </div>
                        <button onClick={() => document.querySelector('main').scrollIntoView({behavior: 'smooth'})} className="px-6 py-2.5 bg-teal-600 text-white rounded-lg font-bold shadow-lg shadow-teal-600/30">Top</button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
